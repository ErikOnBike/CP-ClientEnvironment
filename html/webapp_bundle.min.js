/*
 * Minified browser version of CodeParadise VM (based on SqueakJS VM)
 * SqueakJS VM: Copyright (c) 2013-2025 Vanessa Freudenberg
 * CodeParadise: https://github.com/ErikOnBike/CodeParadise
 */
!function(){"use strict";"undefined"!=typeof window?window.globalThis||(window.globalThis=window):(global.globalThis||(global.globalThis=global),globalThis.require=function(t){var e=require(t);return Object.keys(e).forEach((function(s){if(s[0]>="A"&&s[0]<="Z"){var i=e[s];i&&i.constructor&&i.prototype&&i===i.prototype.constructor&&(i.__cp_className=t+"."+s)}})),e},globalThis.constructor=function(){}),globalThis.identity=function(t){return t??globalThis},globalThis.Squeak={},Object.extend||(Object.extend=function(t){for(var e=1;e<arguments.length;e++)if("object"==typeof arguments[e])for(var s in arguments[e])t[s]=arguments[e][s]}),Function.prototype.subclass||(Function.prototype.subclass=function(t){var e=function(){if(this.initialize){var t=this.initialize.apply(this,arguments);if(void 0!==t)return t}return this},s=function(){};s.prototype=this.prototype,e.prototype=new s;for(var i=1;i<arguments.length;i++)Object.extend(e.prototype,arguments[i]);var r=t.split("."),n=r.pop();return r.reduce((function(t,e){return t[e]||(t[e]={}),t[e]}),globalThis)[n]=e,e}),Object.extend(Squeak,"version",{vmVersion:"SqueakJS 1.2.3",vmDate:"2024-09-28",vmBuild:"cp-20250516",vmPath:"unknown",vmFile:"vm.js",vmMakerVersion:"[VMMakerJS-bf.17 VMMaker-bf.353]",vmInterpreterVersion:"JSInterpreter VMMaker.js-codefrau.1",platformName:"JS",platformSubtype:"unknown",osVersion:"unknown",windowSystem:"unknown"},"object header",{},"special objects",{},"known classes",{Class_instVars:null},"constants",{},"error codes",{},"modules",{externalModules:Squeak.externalModules||{},registerExternalModule:function(t,e){this.externalModules[t]=e}},"time",{Epoch:Date.UTC(1901,0,1)+6e4*(new Date).getTimezoneOffset(),EpochUTC:Date.UTC(1901,0,1),totalSeconds:function(){return Math.floor((Date.now()-Squeak.Epoch)/1e3)}},"utils",{bytesAsString:function(t){for(var e=[],s=0;s<t.length;)e.push(String.fromCharCode.apply(null,t.subarray(s,s+=16348)));return e.join("")},word64FromUint32:function(t,e){return t<2097152?4294967296*t+e:t>4292870144?4294967296*(t>>0)+e:[t,e]}}),Object.subclass("Squeak.Object","initialization",{initInstanceOf:function(t,e,s,i){this.sqClass=t,this.hash=s;var r=t.pointers[2],n=(r>>1&63)+(r>>10&192)-1;this._format=r>>7&15,this._format<8?6!=this._format?n+e>0&&(this.pointers=this.fillArray(n+e,i)):e>0&&(t.isFloatClass?(this.isFloat=!0,this.float=0):this.words=new Uint32Array(e)):e>0&&(this.bytes=new Uint8Array(e))},initAsClone:function(t,e){this.sqClass=t.sqClass,this.hash=e,this._format=t._format,t.isFloat?(this.isFloat=t.isFloat,this.float=t.float):(t.pointers&&(this.pointers=t.pointers.slice(0)),t.words&&(this.words=new Uint32Array(t.words)),t.bytes&&(this.bytes=new Uint8Array(t.bytes)))},initFromImage:function(t,e,s,i){this.oop=t,this.sqClass=e,this._format=s,this.hash=i},classNameFromImage:function(t,e){var s=t.get(e.get(this.oop)[6]);if(s&&s._format>=8&&s._format<12){var i=e.get(s.oop),r=s.decodeBytes(i.length,i,0,3&s._format);return Squeak.bytesAsString(r)}return"Class"},renameFromImage:function(t,e,s){var i=this.sqClass<32?t.get(s[this.sqClass-1]):t.get(this.sqClass);if(!i)return this;var r=i.instProto||i.classInstProto(i.classNameFromImage(t,e));if(!r)return this;var n=new r;return n.oop=this.oop,n.sqClass=this.sqClass,n._format=this._format,n.hash=this.hash,n},installFromImage:function(t,e,s,i,r,n){var a=this.sqClass;this.sqClass=a>0&&a<32?t.get(s[a-1]):t.get(a);var o=e.get(this.oop),c=o.length;if(this._format<5){if(c>0){var h=o;this.pointers=this.decodePointers(c,h,t)}}else if(this._format>=12){var u=this.decodeWords(1,o,r)[0]>>10&255;h=this.decodeWords(u+1,o,r);this.pointers=this.decodePointers(u+1,h,t),this.bytes=this.decodeBytes(c-(u+1),o,u+1,3&this._format)}else this._format>=8?c>0&&(this.bytes=this.decodeBytes(c,o,0,3&this._format)):this.sqClass==i?(this.isFloat=!0,this.float=this.decodeFloat(o,r,n)):c>0&&(this.words=this.decodeWords(c,o,r));this.mark=!1},decodePointers:function(t,e,s){for(var i=new Array(t),r=0;r<t;r++){var n=e[r];i[r]=1==(1&n)?n>>1:s.get(n)||42424242}return i},decodeWords:function(t,e,s){for(var i=new DataView(e.buffer,e.byteOffset),r=new Uint32Array(t),n=0;n<t;n++)r[n]=i.getUint32(4*n,s);return r},decodeBytes:function(t,e,s,i){var r=4*t-i,n=new Uint8Array(e.buffer,e.byteOffset+4*s,r),a=new Uint8Array(r);return a.set(n),a},decodeFloat:function(t,e,s){var i=new DataView(t.buffer,t.byteOffset);if(!e)return i.getFloat64(0,!1);if(s)return i.getFloat64(0,!0);var r=new ArrayBuffer(8),n=new DataView(r);return n.setUint32(0,i.getUint32(4)),n.setUint32(4,i.getUint32(0)),n.getFloat64(0,!0)},fillArray:function(t,e){var s=new Array(t);return s.fill(e),s}},"testing",{isWords:function(){return 6===this._format},isBytes:function(){var t=this._format;return t>=8&&t<=11},isWordsOrBytes:function(){var t=this._format;return 6==t||t>=8&&t<=11},isPointers:function(){return this._format<=4},isWeak:function(){return 4===this._format},isMethod:function(){return this._format>=12},sameFormats:function(t,e){return t<8?t===e:(12&t)==(12&e)},sameFormatAs:function(t){return this.sameFormats(this._format,t._format)}},"printing",{toString:function(){return this.sqInstName()},bytesAsString:function(){return this.bytes?Squeak.bytesAsString(this.bytes):""},bytesAsNumberString:function(t){if(!this.bytes)return"";for(var e="0123456789ABCDEF",s=[],i=0,r=this.bytes.length-1;r>=0;r--)s.push(e[this.bytes[r]>>4]),s.push(e[15&this.bytes[r]]),i=256*i+this.bytes[r];var n=t?"-":"",a=i>9007199254740991?"≈":"";return n+"16r"+s.join("")+" ("+a+n+i+"L)"},assnKeyAsString:function(){return this.pointers[0].bytesAsString()},slotNameAt:function(t){var e=this.instSize();return t<=e?this.sqClass.allInstVarNames()[t-1]||"ivar"+(t-1):(t-e).toString()},sqInstName:function(){if(this.isNil)return"nil";if(this.isTrue)return"true";if(this.isFalse)return"false";if(this.isFloat){var t=this.float.toString();return/\./.test(t)||(t+=".0"),t}var e=this.sqClass.className();if(/ /.test(e))return"the "+e;switch(e){case"String":case"ByteString":return"'"+this.bytesAsString()+"'";case"Symbol":case"ByteSymbol":return"#"+this.bytesAsString();case"Point":return this.pointers.join("@");case"Rectangle":return this.pointers.join(" corner: ");case"Association":case"ReadOnlyVariableBinding":return this.pointers.join("->");case"LargePositiveInteger":return this.bytesAsNumberString(!1);case"LargeNegativeInteger":return this.bytesAsNumberString(!0);case"Character":var s=this.pointers?this.pointers[0]:this.hash;return"$"+String.fromCharCode(s)+" ("+s.toString()+")";case"CompiledMethod":return this.methodAsString();case"CompiledBlock":return"[] in "+this.blockOuterCode().sqInstName()}return/^[aeiou]/i.test(e)?"an"+e:"a"+e}},"accessing",{pointersSize:function(){return this.pointers?this.pointers.length:0},bytesSize:function(){return this.bytes?this.bytes.length:0},wordsSize:function(){return this.isFloat?2:this.words?this.words.length:0},instSize:function(){var t=this._format;return t>4||2===t?0:t<2?this.pointersSize():this.sqClass.classInstSize()},indexableSize:function(t){var e=this._format;return e<2?-1:3===e&&t.vm.isContext(this)&&!t.allowAccessBeyondSP?this.pointers[2]:e<6?this.pointersSize()-this.instSize():e<8?this.wordsSize():e<12?this.bytesSize():this.bytesSize()+4*this.pointersSize()},floatData:function(){var t=new ArrayBuffer(8),e=new DataView(t);return e.setFloat64(0,this.float,!1),e},wordsAsFloat32Array:function(){return this.float32Array||this.words&&(this.float32Array=new Float32Array(this.words.buffer))},wordsAsFloat64Array:function(){return this.float64Array||this.words&&(this.float64Array=new Float64Array(this.words.buffer))},wordsAsInt32Array:function(){return this.int32Array||this.words&&(this.int32Array=new Int32Array(this.words.buffer))},wordsAsInt16Array:function(){return this.int16Array||this.words&&(this.int16Array=new Int16Array(this.words.buffer))},wordsAsUint16Array:function(){return this.uint16Array||this.words&&(this.uint16Array=new Uint16Array(this.words.buffer))},wordsAsUint8Array:function(){return this.uint8Array||this.words&&(this.uint8Array=new Uint8Array(this.words.buffer))},wordsOrBytes:function(){return this.words?this.words:this.uint32Array?this.uint32Array:this.bytes?this.uint32Array=new Uint32Array(this.bytes.buffer,0,this.bytes.length>>>2):null},setAddr:function(t){var e=this.snapshotSize();return this.oop=t+4*e.header,t+4*(e.header+e.body)},snapshotSize:function(){var t=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;return this.bytes&&(t+=this.bytes.length+3>>>2),{header:++t>63?2:this.sqClass.isCompact?0:1,body:t}},addr:function(){return this.oop-4*this.snapshotSize().header},totalBytes:function(){var t=this.snapshotSize();return 4*(t.header+t.body)},writeTo:function(t,e,s){this.bytes&&(this._format|=3&-this.bytes.length);var i=e,r=this.snapshotSize(),n=(15&this._format)<<8|(4095&this.hash)<<17;switch(r.header){case 2:t.setUint32(e,r.body<<2|0),e+=4,t.setUint32(e,0|this.sqClass.oop),e+=4,t.setUint32(e,0|n),e+=4;break;case 1:t.setUint32(e,1|this.sqClass.oop),e+=4,t.setUint32(e,n|r.body<<2|1),e+=4;break;case 0:var a=s.compactClasses.indexOf(this.sqClass)+1;t.setUint32(e,n|a<<12|r.body<<2|3),e+=4}if(this.isFloat)t.setFloat64(e,this.float),e+=8;else if(this.words)for(var o=0;o<this.words.length;o++)t.setUint32(e,this.words[o]),e+=4;else if(this.pointers)for(o=0;o<this.pointers.length;o++)t.setUint32(e,s.objectToOop(this.pointers[o])),e+=4;if(this.bytes){for(o=0;o<this.bytes.length;o++)t.setUint8(e++,this.bytes[o]);e+=3&-this.bytes.length}if(e!==i+this.totalBytes())throw Error("written size does not match");return e}},"as class",{classInstFormat:function(){return this.pointers[2]>>7&15},classInstSize:function(){var t=this.pointers[2];return(t>>10&192)+(t>>1&63)-1},classInstIsBytes:function(){var t=this.classInstFormat();return t>=8&&t<=11},classInstIsPointers:function(){return this.classInstFormat()<=4},instVarNames:function(){for(var t=3;t<=4;t++){var e=this.pointers[t].pointers;if(e&&e.length&&e[0].bytes)return e.map((function(t){return t.bytesAsString()}))}return[]},allInstVarNames:function(){var t=this.superclass();return t.isNil?this.instVarNames():t.allInstVarNames().concat(this.instVarNames())},superclass:function(){return this.pointers[0]},className:function(){if(!this.pointers)return"_NOTACLASS_";for(var t=6;t<=7;t++){if((i=this.pointers[t])&&i.bytes)return i.bytesAsString()}for(var e=5;e<=6;e++){var s=this.pointers[e];if(s&&s.pointers)for(t=6;t<=7;t++){var i;if((i=s.pointers[t])&&i.bytes)return i.bytesAsString()+" class"}}return"_SOMECLASS_"},defaultInst:function(){return Squeak.Object},classInstProto:function(t){if(this.instProto)return this.instProto;var e=this.defaultInst();try{t||(t=this.className());var s=t.replace(/[^A-Za-z0-9]/g,"_");s="UndefinedObject"===s?"nil":"True"===s?"true_":"False"===s?"false_":(/^[AEIOU]/.test(s)?"an":"a")+s,(e=new Function("return function "+s+"() {};")()).prototype=this.defaultInst().prototype}catch(t){}return Object.defineProperty(this,"instProto",{value:e}),e}},"as method",{methodSignFlag:function(){return!1},methodNumLits:function(){return this.pointers[0]>>9&255},methodNumArgs:function(){return this.pointers[0]>>24&15},methodPrimitiveIndex:function(){var t=805306879&this.pointers[0];return t>511?(511&t)+(t>>19):t},methodClassForSuper:function(){return this.pointers[this.methodNumLits()].pointers[1]},methodNeedsLargeFrame:function(){return(131072&this.pointers[0])>0},methodAddPointers:function(t){this.pointers=t},methodTempCount:function(){return this.pointers[0]>>18&63},methodGetLiteral:function(t){return this.pointers[1+t]},methodGetSelector:function(t){return this.pointers[1+t]},methodAsString:function(){return"aCompiledMethod"}},"as context",{contextHome:function(){return this.contextIsBlock()?this.pointers[5]:this},contextIsBlock:function(){return"number"==typeof this.pointers[3]},contextMethod:function(){return this.contextHome().pointers[3]},contextSender:function(){return this.pointers[0]},contextSizeWithStack:function(t){if(t&&t.activeContext===this)return t.sp+1;var e=this.pointers[2];return 6+("number"==typeof e?e:0)}}),Squeak.Object.subclass("Squeak.ObjectSpur","initialization",{initInstanceOf:function(t,e,s,i){this.sqClass=t,this.hash=s;var r=t.pointers[2],n=65535&r,a=r>>16&31;this._format=a,a<12?a<10?n+e>0&&(this.pointers=this.fillArray(n+e,i)):e>0&&(t.isFloatClass?(this.isFloat=!0,this.float=0):this.words=new Uint32Array(e)):e>0&&(this.bytes=new Uint8Array(e))},installFromImage:function(t,e,s,i,r,n,a){var o=this.sqClass;if(o<32)throw Error("Invalid class ID: "+o);if(this.sqClass=s[o],!this.sqClass)throw Error("Class ID not in class table: "+o);var c=e.get(this.oop),h=c.length;switch(this._format){case 0:case 1:case 2:case 3:case 4:case 5:if(h>0){var u=c;this.pointers=this.decodePointers(h,u,t,n,a)}break;case 11:h--,this._format=10;case 10:this.sqClass===i?(this.isFloat=!0,this.float=this.decodeFloat(c,r,!0)):h>0&&(this.words=this.decodeWords(h,c,r));break;case 12:case 13:throw Error("16 bit arrays not supported yet");case 20:case 21:case 22:case 23:h--,this._format-=4;case 16:case 17:case 18:case 19:h>0&&(this.bytes=this.decodeBytes(h,c,0,3&this._format));break;case 28:case 29:case 30:case 31:h--,this._format-=4;case 24:case 25:case 26:case 27:var l=this.decodeWords(1,c,r)[0]>>(a?3:1),p=32767&l,m=(u=a?this.decodeWords64(p+1,c,r):this.decodeWords(p+1,c,r),a?2*(p+1):p+1);this.pointers=this.decodePointers(p+1,u,t,n,a),this.bytes=this.decodeBytes(h-m,c,m,3&this._format),a&&(this.pointers[0]=2147483648&c[1]|l);break;default:throw Error("Unknown object format: "+this._format)}this.mark=!1},decodeWords64:function(t,e,s){for(var i=new Array(t),r=0;r<t;r++){var n=e[2*r],a=e[2*r+1];i[r]=Squeak.word64FromUint32(a,n)}return i},decodePointers:function(t,e,s,i,r){for(var n=new Array(t),a=0;a<t;a++){var o=e[a];if("number"!=typeof o)if(4==(7&o[1]))n[a]=this.decodeSmallFloat(o[0],o[1],r);else{if(1!=(7&o[1]))throw 2==(7&o[1])?Error("Large Immediate Characters not implemented yet"):Error("Large OOPs not implemented yet");n[a]=r.makeLargeFromSmall(o[0],o[1])}else if(1==(1&o))n[a]=r?(o>=0?o<=8589934591:o>=-8589934592)?o/4>>1:r.makeLargeFromSmall((o-(o>>>0))/4294967296>>>0,o>>>0):o>>1;else if(2==(3&o)){if(o<0||o>8589934591)throw Error("Large Immediate Characters not implemented yet");n[a]=i(o>>>(r?3:2))}else if(r&&4==(7&o))n[a]=this.decodeSmallFloat((o-(o>>>0))/4294967296>>>0,o>>>0,r);else if(n[a]=s.get(o)||42424242,42424242===n[a])debugger}return n},decodeSmallFloat:function(t,e,s){var i=0,r=0,n=(8&e)<<28;return 0==(t|4294967280&e)?i=n:(i=939524096+(t>>>4)|n,r=e>>>4|(15&t)<<28),s.makeFloat(new Uint32Array([r,i]))},overhead64:function(t){var e=0,s=0,i=0;if(this._format<=5)e=-2&t.length;else if(this._format>=24){var r=1==(1&(e=(t[0]>>3&32767)+1)),n=this._format>=28;r&&(e+=n?1:-1),i=t.length/2,s=t.length-e}else i=(s=t.length)/2;return{bytes:4*e,sizeHeader:s>=255&&i<255}},initInstanceOfChar:function(t,e){this.oop=e<<2|2,this.sqClass=t,this.hash=e,this._format=7,this.mark=!0},initInstanceOfFloat:function(t,e){this.sqClass=t,this.hash=0,this._format=10,this.isFloat=!0,this.float=this.decodeFloat(e,!0,!0)},initInstanceOfLargeInt:function(t,e){this.sqClass=t,this.hash=0,this._format=16,this.bytes=new Uint8Array(e)},classNameFromImage:function(t,e){var s=t.get(e.get(this.oop)[6]);if(s&&s._format>=16&&s._format<24){var i=e.get(s.oop),r=s.decodeBytes(i.length,i,0,7&s._format);return Squeak.bytesAsString(r)}return"Class"},renameFromImage:function(t,e,s){var i=s[this.sqClass];if(!i)return this;var r=i.instProto||i.classInstProto(i.classNameFromImage(t,e));if(!r)return this;var n=new r;return n.oop=this.oop,n.sqClass=this.sqClass,n._format=this._format,n.hash=this.hash,n}},"accessing",{instSize:function(){return this._format<2?this.pointersSize():this.sqClass.classInstSize()},indexableSize:function(t){var e=this._format;return e<2?-1:3===e&&t.vm.isContext(this)?this.pointers[2]:e<6?this.pointersSize()-this.instSize():e<12?this.wordsSize():e<16?this.shortsSize():e<24?this.bytesSize():4*this.pointersSize()+this.bytesSize()},snapshotSize:function(){var t=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;this.bytes&&(t+=this.bytes.length+3>>>2);var e=t>=255?2:0;return t+=1&t,(t+=2)<4&&(t=4),{header:e,body:t}},writeTo:function(t,e,s,i){var r=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;this.bytes&&(r+=this.bytes.length+3>>>2,this._format|=3&-this.bytes.length);var n=e,a=this._format<<24|4194303&this.sqClass.hash,o=r<<24|4194303&this.hash;if(r>=255&&(t.setUint32(e,r,s),e+=4,o=255<<24|4194303&this.hash,t.setUint32(e,o,s),e+=4),t.setUint32(e,a,s),e+=4,t.setUint32(e,o,s),e+=4,this.isFloat)t.setFloat64(e,this.float,s),e+=8;else if(this.words)for(var c=0;c<this.words.length;c++)t.setUint32(e,this.words[c],s),e+=4;else if(this.pointers){var h=0;if(this._format>=24){var u=this.methodSignFlag()?2147483648:0,l=this.pointers[0]<<1|1|u;t.setUint32(e,l,s),e+=4,h=1}for(c=h;c<this.pointers.length;c++)t.setUint32(e,i(this.pointers[c]),s),e+=4}if(this.bytes){for(c=0;c<this.bytes.length;c++)t.setUint8(e++,this.bytes[c]);e+=3&-this.bytes.length}if((e+=0===r?8:4*(1&r))!==n+this.totalBytes())throw Error("written size does not match");return e}},"testing",{isBytes:function(){var t=this._format;return t>=16&&t<=23},isPointers:function(){return this._format<=6},isWords:function(){return 10===this._format},isWordsOrBytes:function(){var t=this._format;return 10===t||t>=16&&t<=23},isWeak:function(){return 4===this._format},isMethod:function(){return this._format>=24},sameFormats:function(t,e){return t<16?t===e:(248&t)==(248&e)}},"as class",{defaultInst:function(){return Squeak.ObjectSpur},classInstFormat:function(){return this.pointers[2]>>16&31},classInstSize:function(){return 65535&this.pointers[2]},classInstIsBytes:function(){var t=this.classInstFormat();return t>=16&&t<=23},classInstIsPointers:function(){return this.classInstFormat()<=6},classByteSizeOfInstance:function(t){var e=this.classInstFormat(),s=this.classInstSize();return s+=e<9?t:e>=16?(t+3)/4|0:e>=12?(t+1)/2|0:e>=10?t:2*t,s+=1&s,(s+=s>=255?4:2)<4&&(s=4),4*s}},"as compiled block",{blockOuterCode:function(){return this.pointers[this.pointers.length-1]}},"as method",{methodSignFlag:function(){return this.pointers[0]<0},methodNumLits:function(){return 32767&this.pointers[0]},methodPrimitiveIndex:function(){return 0==(65536&this.pointers[0])?0:this.bytes[1]+256*this.bytes[2]},methodAsString:function(){var t=this.pointers[this.pointers.length-1].pointers[1],e=this.pointers[this.pointers.length-2];return e.pointers&&(e=e.pointers[1]),t.className()+">>"+e.bytesAsString()}}),Object.subclass("Squeak.Image","about",{about:function(){}},"initializing",{initialize:function(t){this.headRoom=1e8,this.totalMemory=0,this.headerFlags=0,this.name=t,this.gcCount=0,this.gcMilliseconds=0,this.pgcCount=0,this.pgcMilliseconds=0,this.gcTenured=0,this.allocationCount=0,this.oldSpaceCount=0,this.youngSpaceCount=0,this.newSpaceCount=0,this.hasNewInstances={}},readFromBuffer:function(t,e,s){console.log("squeak: reading "+this.name+" ("+t.byteLength+" bytes)"),this.startupTime=Date.now();for(var i=new DataView(t),r=!1,n=0,a=function(){var t=i.getUint32(n,r);return n+=4,t},o=a,c=4,h=function(e,s){if(s){for(var i=[];i.length<e;)i.push(o());return i}var r=new Uint32Array(t,n,e*c/4);return n+=e*c,r},u=[6501,6502,6504,68e3,68002,68004],l=0,p=0;r=!r,n=p,l=o(),!(u.indexOf(72174&l)>=0);)if(r||(p+=512),p>512)throw Error("bad image version");this.version=l;var m=0!=(1&l);this.hasClosures=!([6501,6502,68e3].indexOf(l)>=0),this.isSpur=0!=(16&l);var f=l>=68e3;if(f&&!this.isSpur)throw Error("64 bit non-spur images not supported yet");f&&(o=function(){var t=i.getUint32(n,!0),e=i.getUint32(n+4,!0);return n+=8,Squeak.word64FromUint32(e,t)},c=8);var d=a(),v=o(),g=o(),b=o(),k=a();f&&a();var y=o();this.headerFlags=o(),this.savedHeaderWords=[k,y,this.headerFlags];for(var S=0;S<4;S++)this.savedHeaderWords.push(a());var P,C=o(),I=new Map,O=new Map,x=p+d;if(n=x,this.isSpur){this.oldSpaceBytes=C-16;for(var w=n+C,j=0,V=null,N=0,A={};n<w;){for(;n<w-16;){var F=n,E=a(),T=a(),B=T>>>24;255===B&&(B=E,E=a(),T=a());H=j+n-8-x;var _=4194303&E;J=4194303&T,Y=h(B,(U=E>>>24&31)<10&&_>0);if(n+=f?8*(B<1?1-B:0):4*(B<2?2-B:1&B),_>=32){if((G=new Squeak.ObjectSpur).initFromImage(H,_,U,J),P&&(P.nextObject=G),this.oldSpaceCount++,P=G,I.set(g+H,G),O.set(H,Y),A[H]=N,f){var M=G.overhead64(Y);N+=M.bytes,M.sizeHeader&&(A[H]-=8,N-=8)}}else N+=n-F,16!==_||V||(V=Y),_&&I.set(g+H,Y)}if(n!==w-16)throw Error("invalid segment");var R=a(),L=a(),q=a();if(a(),0!==q){var D=4278190080&L?4*(16777215&R):0;w+=q,j+=D,N+=16+D,this.oldSpaceBytes+=D+q}}this.oldSpaceBytes-=N,this.firstOldObject=I.get(g),this.lastOldObject=G,this.lastOldObject.nextObject=null}else{for(;n<x+v;){var z=0,K=0,W=o();switch(3&W){case 0:z=W>>>2,K=o(),W=o();break;case 1:K=W-1,z=(W=o())>>>2&63;break;case 3:z=W>>>2&63,K=W>>>12&31;break;case 2:throw Error("Unexpected free block")}z--;var U,G,H=n-4-x,J=W>>>17&4095,Y=h(z,(U=W>>>8&15)<5);(G=new Squeak.Object).initFromImage(H,K,U,J),K<32&&(G.hash|=268435456),P&&(P.nextObject=G),this.oldSpaceCount++,P=G,I.set(g+H,G),O.set(H,Y)}this.firstOldObject=I.get(g+4),this.lastOldObject=G,this.lastOldObject.nextObject=null,this.oldSpaceBytes=v}this.totalMemory=this.oldSpaceBytes+this.headRoom,this.totalMemory=1e6*Math.ceil(this.totalMemory/1e6);var X=I.get(b),$=this.isSpur?this.spurClassTable(I,O,V,X):O.get(I.get(O.get(X.oop)[28]).oop),Z=null;for(G=this.firstOldObject,P=null;G;)P=Z,Z=G.renameFromImage(I,O,$),P?P.nextObject=Z:this.firstOldObject=Z,I.set(g+G.oop,Z),G=G.nextObject;this.lastOldObject=Z,this.lastOldObject.nextObject=null;var Q=I.get(b),tt=O.get(I.get(O.get(Q.oop)[28]).oop),et=I.get(O.get(Q.oop)[9]);this.isSpur&&(this.initImmediateClasses(I,O,Q),tt=this.spurClassTable(I,O,V,Q),m=this.getCharacter.bind(this),this.initSpurOverrides());var st=this.firstOldObject,it=0,rt=function(){if(st){for(var t=it+(this.oldSpaceCount/20|0);st&&it<t;)st.installFromImage(I,O,tt,et,r,m,f&&{makeFloat:function(t){return this.instantiateFloat(t)}.bind(this),makeLargeFromSmall:function(t,e){return this.instantiateLargeFromSmall(t,e)}.bind(this)}),st=st.nextObject,it++;return s&&s(it/this.oldSpaceCount),!0}return this.specialObjectsArray=Q,this.decorateKnownObjects(),this.isSpur?(this.fixSkippedOops(A),f&&this.fixPCs(),this.ensureFullBlockClosureClass(this.specialObjectsArray,tt)):(this.fixCompiledMethods(),this.fixCompactOops()),!1}.bind(this);if(s)self.setTimeout((function t(){rt()?self.setTimeout(t,0):e&&e()}),0);else{for(;rt(););e&&e()}},decorateKnownObjects:function(){var t=this.specialObjectsArray.pointers;if(t[0].isNil=!0,t[2].isTrue=!0,t[1].isFalse=!0,t[9].isFloatClass=!0,!this.isSpur){this.compactClasses=this.specialObjectsArray.pointers[28].pointers;for(var e=0;e<this.compactClasses.length;e++)this.compactClasses[e].isNil||(this.compactClasses[e].isCompact=!0)}Number.prototype.sqInstName||Object.defineProperty(Number.prototype,"sqInstName",{enumerable:!1,value:function(){return this.toString()}})},fixCompactOops:function(){if(!this.isSpur){for(var t=this.firstOldObject,e=0;t;){var s=t.hash>268435455;if(s!==!!t.sqClass.isCompact){var i=0===t.snapshotSize().header;s!==i&&(e+=i?-4:4)}t.hash&=268435455,t.oop+=e,t=t.nextObject}this.oldSpaceBytes+=e}},fixCompiledMethods:function(){if(!(this.version>=6502))for(var t=this.firstOldObject,e=this.specialObjectsArray.pointers[16];t;)t.isMethod()&&(t.sqClass=e),t=t.nextObject},fixSkippedOops:function(t){for(var e=this.firstOldObject;e;)e.oop-=t[e.oop],e=e.nextObject;if((e=this.lastOldObject).addr()+e.totalBytes()!==this.oldSpaceBytes)throw Error("image size doesn't match object sizes")},fixPCs:function(){for(var t=this.specialObjectsArray.pointers[10],e=this.specialObjectsArray.pointers[36],s=this.firstOldObject;s;)s.sqClass===t?s.pointers[1]-=4*s.pointers[3].pointers.length:s.sqClass===e&&(s.pointers[1]-=4*s.pointers[0].pointers[3].pointers.length),s=s.nextObject},ensureFullBlockClosureClass:function(t,e){t.pointers[37].isNil&&e[38]&&(t.pointers[37]=e[38])}},"garbage collection - full",{fullGC:function(t){this.vm.addMessage("fullGC: "+t);var e=Date.now(),s=this.newSpaceCount,i=this.oldSpaceCount,r=this.markReachableObjects();this.removeUnmarkedOldObjects(),this.appendToOldObjects(r),this.finalizeWeakReferences(),this.allocationCount+=this.newSpaceCount,this.newSpaceCount=0,this.youngSpaceCount=0,this.hasNewInstances={},this.gcCount++,this.gcMilliseconds+=Date.now()-e;var n=i-this.oldSpaceCount,a=r.length,o=this.oldSpaceCount-a,c=s-a,h=i-o;return console.log("Full GC ("+t+"): "+(Date.now()-e)+" ms; before: "+i.toLocaleString()+" old objects; allocated "+s.toLocaleString()+" new; surviving "+o.toLocaleString()+" old; tenuring "+a.toLocaleString()+" new; gc'ed "+h.toLocaleString()+" old and "+c.toLocaleString()+" new; total now: "+this.oldSpaceCount.toLocaleString()+" ("+(n>0?"+":"")+n.toLocaleString()+", "+this.oldSpaceBytes.toLocaleString()+" bytes)"),r.length>0?r[0]:null},gcRoots:function(){return this.vm.storeContextRegisters(),[this.specialObjectsArray,this.vm.activeContext]},markReachableObjects:function(){var t=this.gcRoots(),e=[];for(this.weakObjects=[];t.length>0;){var s=t.pop();if(!s.mark){s.oop<0&&e.push(s),s.mark=!0,s.sqClass.mark||t.push(s.sqClass);var i=s.pointers;if(i){var r=i.length;if(s.isWeak()&&(r=s.sqClass.classInstSize(),this.weakObjects.push(s)),this.vm.isContext(s))for(var n=r=s.contextSizeWithStack();n<i.length;n++)i[n]=this.vm.nilObj;for(n=0;n<r;n++)"object"!=typeof i[n]||i[n].mark||t.push(i[n])}}}return this.isSpur?e:e.sort((function(t,e){return e.oop-t.oop}))},removeUnmarkedOldObjects:function(){var t=0,e=0,s=this.firstOldObject;for(s.mark=!1;;){var i=s.nextObject;if(!i)return this.lastOldObject=s,this.lastOldObject.nextObject=null,this.oldSpaceBytes-=e,void(this.oldSpaceCount-=t);if(i.dirty&&(i.dirty=!1),i.mark)(s=i).mark=!1,s.oop-=e;else{var r=i;s.nextObject=r.nextObject,r.oop=-++this.newSpaceCount,e+=r.totalBytes(),t++}}},appendToOldObjects:function(t){for(var e=this.lastOldObject,s=0;s<t.length;s++){var i=t[s];i.mark=!1,this.oldSpaceBytes=i.setAddr(this.oldSpaceBytes),e.nextObject=i,e=i}e.nextObject=null,this.lastOldObject=e,this.lastOldObject.nextObject=null,this.oldSpaceCount+=t.length,this.gcTenured+=t.length,this.vm.signalLowSpaceIfNecessary(this.bytesLeft())},tenureIfYoung:function(t){t.oop<0&&this.appendToOldObjects([t])},finalizeWeakReferences:function(){var t=this.weakObjects;this.weakObjects=null;for(var e=0;e<t.length;e++){for(var s=t[e],i=s.pointers,r=s.sqClass.classInstSize(),n=!1,a=r;a<i.length;a++)i[a].oop<0&&(i[a]=this.vm.nilObj,n=!0);if(n&&(this.vm.pendingFinalizationSignals++,r>=2)){var o=s.pointers[0];if(o.sqClass==this.vm.specialObjects[55]){var c=o.pointers[0];s.pointers[1]=c,o.pointers[0]=s}}}this.vm.pendingFinalizationSignals>0&&this.vm.forceInterruptCheck()}},"garbage collection - partial",{partialGC:function(t){this.vm.addMessage("partialGC: "+t);var e=Date.now(),s=this.newSpaceCount,i=this.findYoungObjects();return this.appendToYoungSpace(i),this.finalizeWeakReferences(),this.cleanupYoungSpace(i),this.allocationCount+=this.newSpaceCount-i.length,this.youngSpaceCount=i.length,this.newSpaceCount=this.youngSpaceCount,this.pgcCount++,this.pgcMilliseconds+=Date.now()-e,console.log("Partial GC ("+t+"): "+(Date.now()-e)+" ms, found "+this.youngRootsCount.toLocaleString()+" roots in "+this.oldSpaceCount.toLocaleString()+" old, kept "+this.youngSpaceCount.toLocaleString()+" young ("+(s-this.youngSpaceCount).toLocaleString()+" gc'ed)"),i[0]},youngRoots:function(){for(var t=this.gcRoots().filter((function(t){return t.oop<0})),e=this.firstOldObject;e;){if(e.dirty){for(var s=e.pointers,i=!1,r=0;r<s.length;r++){var n=s[r];"object"==typeof n&&n.oop<0&&(t.push(n),i=!0)}i||(e.dirty=!1)}e=e.nextObject}return t},findYoungObjects:function(){var t=this.youngRoots(),e=[];for(this.youngRootsCount=t.length,this.weakObjects=[];t.length>0;){var s=t.pop();if(!s.mark){e.push(s),s.mark=!0,s.sqClass.oop<0&&t.push(s.sqClass);var i=s.pointers;if(i){var r=i.length;if(s.isWeak()&&(r=s.sqClass.classInstSize(),this.weakObjects.push(s)),this.vm.isContext(s))for(var n=r=s.contextSizeWithStack();n<i.length;n++)i[n]=this.vm.nilObj;for(n=0;n<r;n++){var a=i[n];"object"==typeof a&&a.oop<0&&t.push(a)}}}}return this.isSpur?e:e.sort((function(t,e){return e.oop-t.oop}))},appendToYoungSpace:function(t){for(var e=this.lastOldObject.oop+1,s=0;s<t.length;s++){var i=t[s];this.hasNewInstances[i.oop]&&(delete this.hasNewInstances[i.oop],this.hasNewInstances[e]=!0),i.oop=e,i.nextObject=t[s+1],e++}},cleanupYoungSpace:function(t){for(var e=t[0],s=-1;e;)this.hasNewInstances[e.oop]&&(delete this.hasNewInstances[e.oop],this.hasNewInstances[s]=!0),e.oop=s,e.mark=!1,e=e.nextObject,s--}},"creating",{registerObject:function(t){return t.oop=-++this.newSpaceCount,this.lastHash=13849+27181*this.lastHash&4294967295,4095&this.lastHash},registerObjectSpur:function(t){return t.oop=-++this.newSpaceCount,0},instantiateClass:function(t,e,s){var i=new(t.classInstProto()),r=this.registerObject(i);return i.initInstanceOf(t,e,r,s),this.hasNewInstances[t.oop]=!0,i},clone:function(t){var e=new(t.sqClass.classInstProto()),s=this.registerObject(e);return e.initAsClone(t,s),this.hasNewInstances[e.sqClass.oop]=!0,e}},"operations",{bulkBecome:function(t,e,s,i){if(!t)return!e;var r=t.length;if(r!==e.length)return!1;var n=null;this.newSpaceCount>0?n=this.partialGC("become"):this.vm.storeContextRegisters();for(var a={},o=0;o<r;o++){if(!(h=t[o]).sqClass)return!1;if(a[h.oop])return!1;a[h.oop]=e[o]}if(s)for(o=0;o<r;o++){if(!(h=e[o]).sqClass)return!1;if(a[h.oop])return!1;a[h.oop]=t[o]}if(i)for(o=0;o<r;o++){if(!e[o].sqClass)return!1;var c=t[o].hash;t[o].hash=e[o].hash,e[o].hash=c,this.isSpur&&this.classTable[c]===t[o]&&(this.classTable[c]=e[o]),s&&this.isSpur&&this.classTable[e[o].hash]===e[o]&&(this.classTable[e[o].hash]=t[o])}this.lastOldObject.nextObject=n;for(var h=this.firstOldObject;h;){var u=a[h.sqClass.oop];u&&(h.sqClass=u,u.oop<0&&(h.dirty=!0));var l=h.pointers;if(l)for(var p=0;p<l.length;p++)(u=a[l[p].oop])&&(l[p]=u,u.oop<0&&(h.dirty=!0));h=h.nextObject}return this.lastOldObject.nextObject=null,this.vm.flushMethodCacheAfterBecome(a),!0},objectAfter:function(t){return t.nextObject||this.nextObjectWithGC("nextObject",t)},someInstanceOf:function(t){for(var e=this.firstOldObject;e;){if(e.sqClass===t)return e;e=e.nextObject||this.nextObjectWithGCFor(e,t)}return null},nextInstanceAfter:function(t){for(var e=t.sqClass;;){if(!(t=t.nextObject||this.nextObjectWithGCFor(t,e)))return null;if(t.sqClass===e)return t}},nextObjectWithGC:function(t,e){var s=e.oop>0?0:this.youngSpaceCount;return this.newSpaceCount<=s?null:(e.oop<0&&this.fullGC(t),this.partialGC(t))},nextObjectWithGCFor:function(t,e){return this.hasNewInstances[e.oop]?this.nextObjectWithGC("instance of "+e.className(),t):null},allInstancesOf:function(t){for(var e=this.firstOldObject,s=[];e;)e.sqClass===t&&s.push(e),e=e.nextObject||this.nextObjectWithGCFor(e,t);return s},writeToBuffer:function(){var t=new DataView(new ArrayBuffer(64+this.oldSpaceBytes)),e=0,s=function(s){t.setUint32(e,s),e+=4};for(s(this.formatVersion()),s(64),s(this.oldSpaceBytes),s(this.firstOldObject.addr()),s(this.objectToOop(this.specialObjectsArray)),s(this.lastHash),s(52429400);e<64;)s(0);for(var i=this.firstOldObject,r=0;i;)e=i.writeTo(t,e,this),i=i.nextObject,r++;if(e!==t.byteLength)throw Error("wrong image size");if(r!==this.oldSpaceCount)throw Error("wrong object count");return t.buffer},objectToOop:function(t){if("number"==typeof t)return t<<1|1;if(t.oop<0)throw Error("temporary oop");return t.oop},bytesLeft:function(){return this.totalMemory-this.oldSpaceBytes},formatVersion:function(){return this.isSpur?6521:this.hasClosures?6504:6502},segmentVersion:function(){var t=this.isSpur?"seod":"does";return this.formatVersion()|t.charCodeAt(0)<<24},storeImageSegment:function(t,e,s){var i=new DataView(t.words.buffer),r=0,n=e.pointers,a=0;i.setUint32(r,this.segmentVersion()),r+=4,this.fullGC("storeImageSegment"),s.mark=!0;for(var o=0;o<s.pointers.length;o++)"object"==typeof s.pointers[o]&&(s.pointers[o].mark=!0);this.markReachableObjects(),s.mark=!1;for(o=0;o<s.pointers.length;o++)"object"==typeof s.pointers[o]&&(s.pointers[o].mark=!1);var c={},h=[];function u(t){var e=c[t.oop];if(!e){if(t.mark){if(a>=n.length)return 0;e=2147483652+4*a,n[a++]=t}else{if(r+t.totalBytes()>i.byteLength)return 0;e=r+4*(t.snapshotSize().header+1),r=t.writeTo(i,r,this),h.push(t)}c[t.oop]=e}return e}function l(){for(var t=this.firstOldObject;t;)t.mark=!1,t=t.nextObject;return this.weakObjects=null,!1}for(u=u.bind(this),l=l.bind(this),u(s);h.length>0;){var p=h.shift(),m=c[p.oop],f=p.snapshotSize().header,d=p.pointers;if(f>0){var v=u(p.sqClass);if(!v)return l();var g=1===f?1:0;i.setUint32(m-8,v|g)}if(d)for(o=0;o<d.length;o++){var b=d[o];if("object"==typeof b){var k=u(b);if(!k)return l();i.setUint32(m+4*o,k)}}}p=t.oop<e.oop?t:e;for(var y=0;p;)p.oop-=y,p===t?(y+=4*p.words.length-r,p.words=new Uint32Array(p.words.buffer.slice(0,r))):p===e&&(y+=4*(p.pointers.length-a),p.pointers.length=a),p=p.nextObject;return this.oldSpaceBytes-=y,l(),!0},loadImageSegment:function(t,e){if(1===t.words.length)return t.nextObject;var s=new DataView(t.words.buffer),i=!1,r=0,n=function(){var t=s.getUint32(r,i);return r+=4,t},a=function(t,e){if(e<5){for(var i=[];i.length<t;)i.push(n());return i}var a=new Uint32Array(s.buffer,r,t);return r+=4*t,a},o=n();if(!0&o&&(i=!0,r=0,!0&(o=n())))return console.error("image segment format not supported"),null;this.tenureIfYoung(t);for(var c=t,h=c.nextObject,u=t.oop,l=new Map,p=new Map;r<s.byteLength;){var m=0,f=0,d=n();switch(3&d){case 0:m=d>>>2,f=n(),d=n();break;case 1:f=d-1,m=(d=n())>>>2&63;break;case 3:m=d>>>2&63,f=d>>>12&31;break;case 2:throw Error("Unexpected free block")}m--;var v=r,g=d>>>8&15,b=d>>>17&4095,k=a(m,g),y=new Squeak.Object;y.initFromImage(v+u,f,g,b),c.nextObject=y,this.oldSpaceCount++,c=y,l.set(v,y),p.set(v+u,k)}y.nextObject=h;for(var S=0;S<e.pointers.length;S++)l.set(2147483652+4*S,e.pointers[S]);var P=this.specialObjectsArray.pointers[28].pointers,C=0,I=P.map((function(t){return l.set(--C,t),C}));t.words=new Uint32Array([t.words[0]]),delete t.uint8Array;var O=t.nextObject,x=this.specialObjectsArray.pointers[9],w=O;do{w.installFromImage(l,p,I,x,i,false),w=w.nextObject}while(w!==h);return O}},"spur support",{initSpurOverrides:function(){this.registerObject=this.registerObjectSpur,this.writeToBuffer=this.writeToBufferSpur,this.storeImageSegment=this.storeImageSegmentSpur,this.loadImageSegment=this.loadImageSegmentSpur},spurClassTable:function(t,e,s,i){for(var r={},n=this.firstOldObject,a=0;a<4096;a++){var o=t.get(s[a]);if(o.oop&&(o=e.get(o.oop)),1024===o.length)for(var c=0;c<1024;c++){var h=t.get(o[c]);if(!h)throw Error("Invalid class table entry (oop "+o[c]+")");if(h!==n)r[l=1024*a+c]=h}}for(var u in Squeak)if(/^splOb_Class/.test(u)){var l,p=t.get(e.get(i.oop)[Squeak[u]]);if(p!==n)(l=p.hash)>0&&l<1024&&(r[l]=p)}return r[3]=r[1],this.classTable=r,this.classTableIndex=1024,r},enterIntoClassTable:function(t){for(var e=this.classTableIndex,s=this.classTable;e<=4194303;){if(!s[e])return s[e]=t,t.hash=e,this.classTableIndex=e,e;e++}return console.error("class table full?"),null},initImmediateClasses:function(t,e,s){var i=e.get(s.oop);this.characterClass=t.get(i[19]),this.floatClass=t.get(i[9]),this.largePosIntClass=t.get(i[13]),this.largeNegIntClass=t.get(i[42]),this.characterClass.classInstProto("Character"),this.floatClass.classInstProto("BoxedFloat64"),this.largePosIntClass.classInstProto("LargePositiveInteger"),this.largeNegIntClass.classInstProto("LargeNegativeInteger"),this.characterTable={}},getCharacter:function(t){var e=this.characterTable[t];return e||((e=new this.characterClass.instProto).initInstanceOfChar(this.characterClass,t),this.characterTable[t]=e),e},instantiateFloat:function(t){var e=new this.floatClass.instProto;return this.registerObjectSpur(e),this.hasNewInstances[this.floatClass.oop]=!0,e.initInstanceOfFloat(this.floatClass,t),e},instantiateLargeFromSmall:function(t,e){e=t<<29|e>>>3;var s=(t>>=3)<0;s&&(t=-t,0!==(e=-e)&&t--);var i=0===t?4:t<=255?5:t<=65535?6:t<=16777215?7:8,r=s?this.largeNegIntClass:this.largePosIntClass,n=new r.instProto;this.registerObjectSpur(n),this.hasNewInstances[r.oop]=!0,n.initInstanceOfLargeInt(r,i);for(var a=n.bytes,o=0;o<4;o++)a[o]=255&e,e>>=8;for(o=4;o<i;o++)a[o]=255&t,t>>=8;return n},ensureClassesInTable:function(){for(var t=this.firstOldObject,e=1024;t;){var s=t.sqClass;if(0===s.hash&&this.enterIntoClassTable(s),s.hash>e&&(e=s.hash),this.classTable[s.hash]!==s)throw Error("Class not in class table");t=t.nextObject}return 1+(e>>10)},classTableBytes:function(t){return 4*(4108+1028*t)},writeFreeLists:function(t,e,s,i){return t.setUint32(e,167772178,s),e+=4,t.setUint32(e,536870912,s),e+=4,e+=128},writeClassTable:function(t,e,s,i,r){var n=4104,a=1024;t.setUint32(e,n,s),e+=4,t.setUint32(e,4278190080,s),e+=4,t.setUint32(e,33554448,s),e+=4,t.setUint32(e,4278190080,s),e+=4;for(var o=0;o<r;o++)t.setUint32(e,16624+4112*o,s),e+=4;e+=4*(n-r);var c=0;for(o=0;o<r;o++){t.setUint32(e,a,s),e+=4,t.setUint32(e,4278190080,s),e+=4,t.setUint32(e,33554448,s),e+=4,t.setUint32(e,4278190080,s),e+=4;for(var h=0;h<a;h++){var u=this.classTable[c];if(u&&u.pointers){if(!u.hash)throw Error("class without id");(u.hash!==c&&c>=32||u.oop<0)&&(console.warn("freeing class index "+c+" "+u.className()),u=null,delete this.classTable[c])}u&&t.setUint32(e,i(u),s),e+=4,c++}}return e},writeToBufferSpur:function(){var t=this.ensureClassesInTable(),e=136+this.classTableBytes(t),s=new DataView(new ArrayBuffer(64+e+this.oldSpaceBytes+16)),i=!0,r=Date.now(),n=0;function a(t){s.setUint32(n,t,i),n+=4}function o(t){if("number"==typeof t)return t<<1|1;if(7===t._format){if(t.hash!==t.oop>>2||2!=(3&t.oop))throw Error("Bad immediate char");return t.oop}if(t.oop<0)throw Error("temporary oop");return t.oop<48?t.oop:t.oop+e}for(a(this.formatVersion()),a(64),a(e+this.oldSpaceBytes+16),a(this.firstOldObject.addr()),a(o(this.specialObjectsArray)),this.savedHeaderWords.forEach(a),a(e+this.oldSpaceBytes+16);n<64;)a(0);var c=this.firstOldObject,h=0;for(n=c.writeTo(s,n,i,o),c=c.nextObject,h++,n=c.writeTo(s,n,i,o),c=c.nextObject,h++,n=c.writeTo(s,n,i,o),c=c.nextObject,h++,n=this.writeFreeLists(s,n,i,o),n=this.writeClassTable(s,n,i,o,t);c;)n=c.writeTo(s,n,i,o),c=c.nextObject,h++;if(a(1241513987),a(8388608),a(0),a(0),n!==s.byteLength)throw Error("wrong image size");if(h!==this.oldSpaceCount)throw Error("wrong object count");var u=Date.now()-r;return console.log("Wrote "+h+" objects in "+u+" ms, image size "+n+" bytes"),s.buffer},storeImageSegmentSpur:function(t,e,s){return this.vm.warnOnce("not implemented for Spur yet: primitive 98 (primitiveStoreImageSegment)"),!1},loadImageSegmentSpur:function(t,e){return this.vm.warnOnce("not implemented for Spur yet: primitive 99 (primitiveLoadImageSegment)"),null}}),Object.subclass("Squeak.Interpreter","initialization",{initialize:function(t,e,s){console.log("squeak: initializing interpreter "+Squeak.vmVersion+" ("+Squeak.vmDate+")"),this.Squeak=Squeak,this.image=t,this.image.vm=this,this.options=s||{},this.primHandler=new Squeak.Primitives(this,e),this.loadImageState(),this.initVMState(),this.loadInitialContext(),this.hackImage(),this.initCompiler(),console.log("squeak: ready")},loadImageState:function(){this.specialObjects=this.image.specialObjectsArray.pointers,this.specialSelectors=this.specialObjects[23].pointers,this.nilObj=this.specialObjects[0],this.falseObj=this.specialObjects[1],this.trueObj=this.specialObjects[2],this.hasClosures=this.image.hasClosures,this.getGlobals=this.globalsGetter(),this.hasClosures||this.findMethod("UnixFileDirectory class>>pathNameDelimiter")||(this.primHandler.emulateMac=!0),6501==this.image.version&&(this.primHandler.reverseDisplay=!0)},initVMState:function(){this.byteCodeCount=0,this.sendCount=0,this.interruptCheckCounter=0,this.interruptCheckCounterFeedBackReset=1e3,this.interruptChecksEveryNms=3,this.lowSpaceThreshold=1e6,this.signalLowSpace=!1,this.nextPollTick=0,this.nextWakeupTick=0,this.lastTick=0,this.interruptKeycode=2094,this.interruptPending=!1,this.pendingFinalizationSignals=0,this.freeContexts=this.nilObj,this.freeLargeContexts=this.nilObj,this.reclaimableContextCount=0,this.nRecycledContexts=0,this.nAllocatedContexts=0,this.methodCacheSize=1024,this.methodCacheMask=this.methodCacheSize-1,this.methodCacheRandomish=0,this.methodCache=[];for(var t=0;t<this.methodCacheSize;t++)this.methodCache[t]={lkupClass:null,selector:null,method:null,primIndex:0,argCount:0,mClass:null};this.breakOutOfInterpreter=!1,this.breakOutTick=0,this.breakOnMethod=null,this.breakOnNewMethod=!1,this.breakOnMessageNotUnderstood=!1,this.breakOnContextChanged=!1,this.breakOnContextReturned=null,this.messages={},this.startupTime=Date.now()},loadInitialContext:function(){var t=this.specialObjects[3].pointers[1].pointers[1];this.activeContext=t.pointers[1],this.activeContext.dirty=!0,this.fetchContextRegisters(this.activeContext),this.reclaimableContextCount=0},globalsGetter:function(){var t=this.specialObjects[8],e=t.sqClass.className();if("Association"===e&&(e=(t=t.pointers[1]).sqClass.className()),"SystemDictionary"===e)return function(){return t.pointers[1].pointers};if("SmalltalkImage"===e){var s=t.pointers[0],i=s.sqClass.className();if("SystemDictionary"===i)return function(){return s.pointers[1].pointers};if("Environment"===i)return function(){return s.pointers[2].pointers[1].pointers}}return console.warn("cannot find global dict"),function(){return[]}},initCompiler:function(){if(!Squeak.Compiler)return console.warn("Squeak.Compiler not loaded, using interpreter only");try{if(42!==new Function("return 42")())return console.warn("function constructor not working, disabling JIT")}catch(t){return console.warn("disabling JIT: "+t)}var t=this.image.oldSpaceCount/(this.startupTime-this.image.startupTime);if(t<10)return console.warn("Slow machine detected (loaded "+(1e3*t|0)+" objects/sec), using interpreter only");try{console.log("squeak: initializing JIT compiler");var e=new Squeak.Compiler(this);e.compile&&(this.compiler=e)}catch(t){console.warn("Compiler: "+t)}this.compiler||console.warn("SqueakJS will be running in interpreter mode only (slow)")},hackImage:function(){}},"interpreting",{interpretOne:function(t){if(!this.method.compiled){if(this.method.methodSignFlag())return this.interpretOneSistaWithExtensions(t,0,0);var e,s;this.Squeak;switch(this.byteCodeCount++,e=this.nextByte()){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return void this.push(this.receiver.pointers[15&e]);case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:return void this.push(this.homeContext.pointers[6+(15&e)]);case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:return void this.push(this.method.methodGetLiteral(31&e));case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 81:case 82:case 83:case 84:case 85:case 86:case 87:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:return void this.push(this.method.methodGetLiteral(31&e).pointers[1]);case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:return this.receiver.dirty=!0,void(this.receiver.pointers[7&e]=this.pop());case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:return void(this.homeContext.pointers[6+(7&e)]=this.pop());case 112:return void this.push(this.receiver);case 113:return void this.push(this.trueObj);case 114:return void this.push(this.falseObj);case 115:return void this.push(this.nilObj);case 116:return void this.push(-1);case 117:return void this.push(0);case 118:return void this.push(1);case 119:return void this.push(2);case 120:return void this.doReturn(this.receiver);case 121:return void this.doReturn(this.trueObj);case 122:return void this.doReturn(this.falseObj);case 123:return void this.doReturn(this.nilObj);case 124:return void this.doReturn(this.pop());case 125:return void this.doReturn(this.pop(),this.activeContext.pointers[0]);case 126:case 127:return void this.nono();case 128:return void this.extendedPush(this.nextByte());case 129:return void this.extendedStore(this.nextByte());case 130:return void this.extendedStorePop(this.nextByte());case 131:return s=this.nextByte(),void this.send(this.method.methodGetSelector(31&s),s>>5,!1);case 132:return void this.doubleExtendedDoAnything(this.nextByte());case 133:return s=this.nextByte(),void this.send(this.method.methodGetSelector(31&s),s>>5,!0);case 134:return s=this.nextByte(),void this.send(this.method.methodGetSelector(63&s),s>>6,!1);case 135:return void this.pop();case 136:return void this.push(this.top());case 137:return void this.push(this.exportThisContext());case 138:return void this.pushNewArray(this.nextByte());case 139:return void this.callPrimBytecode(129);case 140:return s=this.nextByte(),void this.push(this.homeContext.pointers[6+this.nextByte()].pointers[s]);case 141:return s=this.nextByte(),(i=this.homeContext.pointers[6+this.nextByte()]).pointers[s]=this.top(),void(i.dirty=!0);case 142:var i;return s=this.nextByte(),(i=this.homeContext.pointers[6+this.nextByte()]).pointers[s]=this.pop(),void(i.dirty=!0);case 143:return void this.pushClosureCopy();case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:return void(this.pc+=1+(7&e));case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:return void this.jumpIfFalse(1+(7&e));case 160:case 161:case 162:case 163:case 164:case 165:case 166:case 167:return s=this.nextByte(),this.pc+=256*((7&e)-4)+s,void((7&e)<4&&this.interruptCheckCounter--<=0&&this.checkForInterrupts());case 168:case 169:case 170:case 171:return void this.jumpIfTrue(256*(3&e)+this.nextByte());case 172:case 173:case 174:case 175:return void this.jumpIfFalse(256*(3&e)+this.nextByte());case 176:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)+this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 177:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)-this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 178:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 179:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 180:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<=this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 181:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>=this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 182:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)===this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 183:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)!==this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 184:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)*this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 185:return this.success=!0,void(this.pop2AndPushIntResult(this.quickDivide(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 186:return this.success=!0,void(this.pop2AndPushIntResult(this.mod(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 187:return this.success=!0,void(this.primHandler.primitiveMakePoint(1,!0)||this.sendSpecial(15&e));case 188:return this.success=!0,void(this.pop2AndPushIntResult(this.safeShift(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 189:return this.success=!0,void(this.pop2AndPushIntResult(this.div(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 190:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)&this.stackInteger(0))||this.sendSpecial(15&e));case 191:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)|this.stackInteger(0))||this.sendSpecial(15&e));case 192:case 193:case 194:case 195:case 196:case 197:case 198:case 199:case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 207:return void(this.primHandler.quickSendOther(this.receiver,15&e)||this.sendSpecial(16+(15&e)));case 208:case 209:case 210:case 211:case 212:case 213:case 214:case 215:case 216:case 217:case 218:case 219:case 220:case 221:case 222:case 223:return void this.send(this.method.methodGetSelector(15&e),0,!1);case 224:case 225:case 226:case 227:case 228:case 229:case 230:case 231:case 232:case 233:case 234:case 235:case 236:case 237:case 238:case 239:return void this.send(this.method.methodGetSelector(15&e),1,!1);case 240:case 241:case 242:case 243:case 244:case 245:case 246:case 247:case 248:case 249:case 250:case 251:case 252:case 253:case 254:case 255:return void this.send(this.method.methodGetSelector(15&e),2,!1)}throw Error("not a bytecode: "+e)}if(t){if(!this.compiler.enableSingleStepping(this.method))return this.method.compiled=null,this.interpretOne(t);this.breakNow()}this.method.compiled(this)},interpretOneSistaWithExtensions:function(t,e,s){var i,r;this.Squeak;switch(this.byteCodeCount++,i=this.nextByte()){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return void this.push(this.receiver.pointers[15&i]);case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:return void this.push(this.method.methodGetLiteral(15&i).pointers[1]);case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:return void this.push(this.method.methodGetLiteral(31&i));case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:return void this.push(this.homeContext.pointers[6+(7&i)]);case 72:case 73:case 74:case 75:return void this.push(this.homeContext.pointers[6+(3&i)+8]);case 76:return void this.push(this.receiver);case 77:return void this.push(this.trueObj);case 78:return void this.push(this.falseObj);case 79:return void this.push(this.nilObj);case 80:return void this.push(0);case 81:return void this.push(1);case 82:return 0==s?void this.push(this.exportThisContext()):void this.nono();case 83:return void this.push(this.top());case 84:case 85:case 86:case 87:case 217:case 218:case 219:case 220:case 221:case 222:case 223:case 230:case 236:case 246:case 247:case 254:case 255:return void this.nono();case 88:return void this.doReturn(this.receiver);case 89:return void this.doReturn(this.trueObj);case 90:return void this.doReturn(this.falseObj);case 91:return void this.doReturn(this.nilObj);case 92:return void this.doReturn(this.pop());case 93:return void this.doReturn(this.nilObj,this.activeContext.pointers[0]);case 94:return 0==e?void this.doReturn(this.pop(),this.activeContext.pointers[0]):void this.nono();case 95:return;case 96:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)+this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 97:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)-this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 98:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 99:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 100:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<=this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 101:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>=this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 102:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)===this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 103:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)!==this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 104:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)*this.stackIntOrFloat(0))||this.sendSpecial(15&i));case 105:return this.success=!0,void(this.pop2AndPushIntResult(this.quickDivide(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&i));case 106:return this.success=!0,void(this.pop2AndPushIntResult(this.mod(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&i));case 107:return this.success=!0,void(this.primHandler.primitiveMakePoint(1,!0)||this.sendSpecial(15&i));case 108:return this.success=!0,void(this.pop2AndPushIntResult(this.safeShift(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&i));case 109:return this.success=!0,void(this.pop2AndPushIntResult(this.div(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&i));case 110:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)&this.stackInteger(0))||this.sendSpecial(15&i));case 111:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)|this.stackInteger(0))||this.sendSpecial(15&i));case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:return void(this.primHandler.quickSendOther(this.receiver,15&i)||this.sendSpecial(16+(15&i)));case 128:case 129:case 130:case 131:case 132:case 133:case 134:case 135:case 136:case 137:case 138:case 139:case 140:case 141:case 142:case 143:return void this.send(this.method.methodGetSelector(15&i),0,!1);case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:return void this.send(this.method.methodGetSelector(15&i),1,!1);case 160:case 161:case 162:case 163:case 164:case 165:case 166:case 167:case 168:case 169:case 170:case 171:case 172:case 173:case 174:case 175:return void this.send(this.method.methodGetSelector(15&i),2,!1);case 176:case 177:case 178:case 179:case 180:case 181:case 182:case 183:return void(this.pc+=1+(7&i));case 184:case 185:case 186:case 187:case 188:case 189:case 190:case 191:return void this.jumpIfTrue(1+(7&i));case 192:case 193:case 194:case 195:case 196:case 197:case 198:case 199:return void this.jumpIfFalse(1+(7&i));case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 207:return this.receiver.dirty=!0,void(this.receiver.pointers[7&i]=this.pop());case 208:case 209:case 210:case 211:case 212:case 213:case 214:case 215:return void(this.homeContext.pointers[6+(7&i)]=this.pop());case 216:return void this.pop();case 224:return r=this.nextByte(),void this.interpretOneSistaWithExtensions(t,(e<<8)+r,s);case 225:return r=this.nextByte(),void this.interpretOneSistaWithExtensions(t,e,(s<<8)+(r<128?r:r-256));case 226:return r=this.nextByte(),void this.push(this.receiver.pointers[r+(e<<8)]);case 227:return r=this.nextByte(),void this.push(this.method.methodGetLiteral(r+(e<<8)).pointers[1]);case 228:return r=this.nextByte(),void this.push(this.method.methodGetLiteral(r+(e<<8)));case 229:return r=this.nextByte(),void this.push(this.homeContext.pointers[6+r]);case 231:return void this.pushNewArray(this.nextByte());case 232:return r=this.nextByte(),void this.push(r+(s<<8));case 233:return r=this.nextByte(),void this.push(this.image.getCharacter(r+(s<<8)));case 234:return r=this.nextByte(),void this.send(this.method.methodGetSelector((r>>3)+(e<<5)),(7&r)+(s<<3),!1);case 235:r=this.nextByte();var n=this.method.methodGetSelector((r>>3)+(e<<5));return s>=64?void this.sendSuperDirected(n,(7&r)+((63&s)<<3)):void this.send(n,(7&r)+(s<<3),!0);case 237:var a=this.nextByte()+(s<<8);return this.pc+=a,void(a<0&&this.interruptCheckCounter--<=0&&this.checkForInterrupts());case 238:return void this.jumpIfTrue(this.nextByte()+(s<<8));case 239:return void this.jumpIfFalse(this.nextByte()+(s<<8));case 240:return this.receiver.dirty=!0,void(this.receiver.pointers[this.nextByte()+(e<<8)]=this.pop());case 241:return(o=this.method.methodGetLiteral(this.nextByte()+(e<<8))).dirty=!0,void(o.pointers[1]=this.pop());case 242:return void(this.homeContext.pointers[6+this.nextByte()]=this.pop());case 243:return this.receiver.dirty=!0,void(this.receiver.pointers[this.nextByte()+(e<<8)]=this.top());case 244:var o;return(o=this.method.methodGetLiteral(this.nextByte()+(e<<8))).dirty=!0,void(o.pointers[1]=this.top());case 245:return void(this.homeContext.pointers[6+this.nextByte()]=this.top());case 248:return void this.callPrimBytecode(245);case 249:return void this.pushFullClosure(e);case 250:return void this.pushClosureCopyExtended(e,s);case 251:return r=this.nextByte(),void this.push(this.homeContext.pointers[6+this.nextByte()].pointers[r]);case 252:return r=this.nextByte(),(c=this.homeContext.pointers[6+this.nextByte()]).pointers[r]=this.top(),void(c.dirty=!0);case 253:var c;return r=this.nextByte(),(c=this.homeContext.pointers[6+this.nextByte()]).pointers[r]=this.pop(),void(c.dirty=!0)}throw Error("not a bytecode: "+i)},interpret:function(t,e){if(this.frozen)return"frozen";for(this.isIdle=!1,this.breakOutOfInterpreter=!1,this.breakAfter(t||500);!1===this.breakOutOfInterpreter;)this.method.compiled?this.method.compiled(this):this.interpretOne();if("function"==typeof this.breakOutOfInterpreter)return this.breakOutOfInterpreter(e);var s="break"==this.breakOutOfInterpreter?"break":this.isIdle?this.nextWakeupTick?Math.max(1,this.nextWakeupTick-this.primHandler.millisecondClockValue()):"sleep":0;return e&&e(s),s},goIdle:function(){var t=0!==this.nextWakeupTick;this.forceInterruptCheck(),this.checkForInterrupts();var e=0!==this.nextWakeupTick;this.isIdle=e||!t,this.breakOut()},freeze:function(t){var e;this.frozen=!0,this.breakOutOfInterpreter=function(t){if(!t)throw Error("need function to restart interpreter");return e=t,"frozen"}.bind(this);var s=function(){if(this.frozen=!1,!e)throw Error("no continue function");e(0)}.bind(this);return t&&self.setTimeout((function(){t(s)}),0),s},breakOut:function(){this.breakOutOfInterpreter=this.breakOutOfInterpreter||!0},nextByte:function(){return this.method.bytes[this.pc++]},nono:function(){throw Error("Oh No!")},forceInterruptCheck:function(){this.interruptCheckCounter=-1e3},checkForInterrupts:function(){var t=this.primHandler.millisecondClockValue();(t<this.lastTick&&(this.nextPollTick=t+(this.nextPollTick-this.lastTick),this.breakOutTick=t+(this.breakOutTick-this.lastTick),0!==this.nextWakeupTick&&(this.nextWakeupTick=t+(this.nextWakeupTick-this.lastTick))),this.interruptCheckCounter>-100&&(t-this.lastTick<this.interruptChecksEveryNms?this.interruptCheckCounterFeedBackReset+=10:this.interruptCheckCounterFeedBackReset<=1e3?this.interruptCheckCounterFeedBackReset=1e3:this.interruptCheckCounterFeedBackReset-=12),this.interruptCheckCounter=this.interruptCheckCounterFeedBackReset,this.lastTick=t,this.signalLowSpace)&&(this.signalLowSpace=!1,(e=this.specialObjects[17]).isNil||this.primHandler.synchronousSignal(e));this.interruptPending&&(this.interruptPending=!1,(e=this.specialObjects[30]).isNil||this.primHandler.synchronousSignal(e));0!==this.nextWakeupTick&&t>=this.nextWakeupTick&&(this.nextWakeupTick=0,(e=this.specialObjects[29]).isNil||this.primHandler.synchronousSignal(e));if(this.pendingFinalizationSignals>0){var e=this.specialObjects[41];this.pendingFinalizationSignals=0,e.isNil||this.primHandler.synchronousSignal(e)}this.primHandler.semaphoresToSignal.length>0&&this.primHandler.signalExternalSemaphores(),this.method.compiled||this.compileIfPossible(this.method),t>=this.breakOutTick&&this.breakOut()},extendedPush:function(t){var e=63&t;switch(t>>6){case 0:this.push(this.receiver.pointers[e]);break;case 1:this.push(this.homeContext.pointers[6+e]);break;case 2:this.push(this.method.methodGetLiteral(e));break;case 3:this.push(this.method.methodGetLiteral(e).pointers[1])}},extendedStore:function(t){var e=63&t;switch(t>>6){case 0:this.receiver.dirty=!0,this.receiver.pointers[e]=this.top();break;case 1:this.homeContext.pointers[6+e]=this.top();break;case 2:this.nono();break;case 3:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[1]=this.top()}},extendedStorePop:function(t){var e=63&t;switch(t>>6){case 0:this.receiver.dirty=!0,this.receiver.pointers[e]=this.pop();break;case 1:this.homeContext.pointers[6+e]=this.pop();break;case 2:this.nono();break;case 3:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[1]=this.pop()}},doubleExtendedDoAnything:function(t){var e=this.nextByte();switch(t>>5){case 0:this.send(this.method.methodGetSelector(e),31&t,!1);break;case 1:this.send(this.method.methodGetSelector(e),31&t,!0);break;case 2:this.push(this.receiver.pointers[e]);break;case 3:this.push(this.method.methodGetLiteral(e));break;case 4:this.push(this.method.methodGetLiteral(e).pointers[1]);break;case 5:this.receiver.dirty=!0,this.receiver.pointers[e]=this.top();break;case 6:this.receiver.dirty=!0,this.receiver.pointers[e]=this.pop();break;case 7:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[1]=this.top()}},jumpIfTrue:function(t){var e=this.pop();e.isTrue?this.pc+=t:e.isFalse||(this.push(e),this.send(this.specialObjects[25],0,!1))},jumpIfFalse:function(t){var e=this.pop();e.isFalse?this.pc+=t:e.isTrue||(this.push(e),this.send(this.specialObjects[25],0,!1))},sendSpecial:function(t){this.send(this.specialSelectors[2*t],this.specialSelectors[2*t+1],!1)},callPrimBytecode:function(t){this.pc+=2,this.primFailCode&&(this.method.bytes[this.pc]===t&&this.stackTopPut(this.getErrorObjectFromPrimFailCode()),this.primFailCode=0)},getErrorObjectFromPrimFailCode:function(){var t=this.specialObjects[51];if(t&&t.pointers){var e=t.pointers[this.primFailCode-1];if(e)return e}return this.primFailCode}},"closures",{pushNewArray:function(t){var e=t>127,s=127&t,i=this.instantiateClass(this.specialObjects[7],s);if(e){for(var r=0;r<s;r++)i.pointers[r]=this.stackValue(s-r-1);this.popN(s)}this.push(i)},pushClosureCopy:function(){var t=this.nextByte(),e=15&t,s=t>>4,i=256*this.nextByte()+this.nextByte(),r=this.encodeSqueakPC(this.pc,this.method),n=this.newClosure(e,r,s);if(n.pointers[0]=this.activeContext,this.reclaimableContextCount=0,s>0){for(var a=0;a<s;a++)n.pointers[3+a]=this.stackValue(s-a-1);this.popN(s)}this.pc+=i,this.push(n)},pushClosureCopyExtended:function(t,e){var s=this.nextByte(),i=this.nextByte(),r=(7&s)+8*this.mod(t,16),n=(s>>3&7)+8*this.div(t,16),a=i+(e<<8),o=this.encodeSqueakPC(this.pc,this.method),c=this.newClosure(r,o,n);if(c.pointers[0]=this.activeContext,this.reclaimableContextCount=0,n>0){for(var h=0;h<n;h++)c.pointers[3+h]=this.stackValue(n-h-1);this.popN(n)}this.pc+=a,this.push(c)},pushFullClosure:function(t){var e,s=this.nextByte(),i=this.nextByte(),r=s+(t<<8),n=63&i;e=1==(i>>6&1)?this.vm.nilObj:this.activeContext;var a=this.method.methodGetLiteral(r),o=this.newFullClosure(e,n,a);if(1==(i>>7&1))throw Error("on-stack receiver not yet supported");if(o.pointers[3]=this.receiver,this.reclaimableContextCount=0,n>0){for(var c=0;c<n;c++)o.pointers[4+c]=this.stackValue(n-c-1);this.popN(n)}this.push(o)},newClosure:function(t,e,s){var i=this.instantiateClass(this.specialObjects[36],s);return i.pointers[1]=e,i.pointers[2]=t,i},newFullClosure:function(t,e,s){var i=this.instantiateClass(this.specialObjects[37],e);return i.pointers[0]=t,i.pointers[1]=s,i.pointers[2]=s.methodNumArgs(),i}},"sending",{send:function(t,e,s){var i,r=this.stackValue(e);i=s?(i=this.method.methodClassForSuper()).superclass():this.getClass(r);var n=this.findSelectorInClass(t,e,i);n.primIndex&&(this.verifyAtSelector=t,this.verifyAtClass=i),this.executeNewMethod(r,n.method,n.argCount,n.primIndex,n.mClass,t)},sendSuperDirected:function(t,e){var s=this.pop().superclass(),i=this.stackValue(e),r=this.findSelectorInClass(t,e,s);r.primIndex&&(this.verifyAtSelector=t,this.verifyAtClass=s),this.executeNewMethod(i,r.method,r.argCount,r.primIndex,r.mClass,t)},sendAsPrimitiveFailure:function(t,e,s){this.executeNewMethod(t,e,s,0)},findSelectorInClass:function(t,e,s,i=e){this.currentSelector=t;var r=this.findMethodCacheEntry(t,s);if(r.method)return r;for(var n,a=s;!a.isNil;){if((n=a.pointers[1]).isNil){var o=this.specialObjects[34],c=this.createActualMessage(t,e,s);return this.popNandPush(i+1,c),this.findSelectorInClass(o,1,a.superclass())}var h=this.lookupSelectorInDict(n,t);if(!h.isNil)return r.method=h,h.isMethod()?(r.primIndex=h.methodPrimitiveIndex(),r.argCount=h.methodNumArgs()):(r.primIndex=576,r.argCount=e),r.mClass=a,r;a=a.superclass()}var u=this.specialObjects[20];if(t===u)throw Error("Recursive not understood error encountered");var l=this.createActualMessage(t,e,s);if(this.breakOnMessageNotUnderstood){var p=this.stackValue(i);this.breakNow("Message not understood: "+p+" "+s.className()+">>"+t.bytesAsString())}return this.popNandPush(i,l),this.findSelectorInClass(u,1,s)},lookupSelectorInDict:function(t,e){for(var s=t.pointersSize(),i=2+(s-2-1&e.hash),r=!1;;){var n=t.pointers[i];if(n===e)return t.pointers[1].pointers[i-2];if(n.isNil)return this.nilObj;if(++i===s){if(r)return this.nilObj;i=2,r=!0}}},executeNewMethod:function(t,e,s,i,r,n){if(this.sendCount++,e===this.breakOnMethod&&this.breakNow("executing method "+this.printMethod(e,r,n)),this.logSends){for(var a=" ",o=this.activeContext;!o.isNil;)a+="| ",o=o.pointers[0];var c=this.activeContext.pointers.slice(this.sp+1-s,this.sp+1);console.log(this.sendCount+a+this.printMethod(e,r,n,c))}if(this.breakOnContextChanged&&(this.breakOnContextChanged=!1,this.breakNow()),!(i>0&&this.tryPrimitive(i,s,e))){var h=this.allocateOrRecycleContext(e.methodNeedsLargeFrame()),u=e.methodTempCount(),l=6+u-1;if(h.pointers[3]=e,h.pointers[4]=this.nilObj,h.pointers[0]=this.activeContext,this.arrayCopy(this.activeContext.pointers,this.sp-s,h.pointers,5,s+1),this.arrayFill(h.pointers,6+s,6+u,this.nilObj),this.popN(s+1),this.reclaimableContextCount++,this.storeContextRegisters(),this.activeContext=h,this.activeContext.dirty=!0,this.homeContext=h,this.method=e,this.pc=0,this.sp=l,this.receiver=h.pointers[5],this.receiver!==t)throw Error("receivers don't match");e.compiled||this.compileIfPossible(e,r,n),this.interruptCheckCounter--<=0&&this.checkForInterrupts()}},compileIfPossible(t,e,s){!t.compiled&&this.compiler&&this.compiler.compile(t,e,s)},doReturn:function(t,e){if(!e){var s=this.homeContext;if(this.hasClosures)for(var i;!(i=s.pointers[4]).isNil;)s=i.pointers[0];e=s.pointers[0]}if(e.isNil||e.pointers[1].isNil)return this.cannotReturn(t);for(var r,n=this.activeContext.pointers[0];n!==e;){if(n.isNil)return this.cannotReturn(t);if(this.isUnwindMarked(n))return this.aboutToReturnThrough(t,n);n=n.pointers[0]}for(n=this.activeContext;n!==e;)this.breakOnContextReturned===n&&(this.breakOnContextReturned=null,this.breakNow()),r=n.pointers[0],n.pointers[0]=this.nilObj,n.pointers[1]=this.nilObj,this.reclaimableContextCount>0&&(this.reclaimableContextCount--,this.recycleIfPossible(n)),n=r;this.activeContext=n,this.activeContext.dirty=!0,this.fetchContextRegisters(this.activeContext),this.push(t),this.breakOnContextChanged&&(this.breakOnContextChanged=!1,this.breakNow())},aboutToReturnThrough:function(t,e){this.push(this.exportThisContext()),this.push(t),this.push(e);var s=this.specialObjects[48];this.send(s,2)},cannotReturn:function(t){this.push(this.exportThisContext()),this.push(t);var e=this.specialObjects[21];this.send(e,1)},tryPrimitive:function(t,e,s){if(t>255&&t<520){if(t>=264)return this.popNandPush(1,this.top().pointers[t-264]),!0;switch(t){case 256:return!0;case 257:return this.popNandPush(1,this.trueObj),!0;case 258:return this.popNandPush(1,this.falseObj),!0;case 259:return this.popNandPush(1,this.nilObj),!0}return this.popNandPush(1,t-261),!0}var i=this.sp,r=this.activeContext,n=this.primHandler.doPrimitive(t,e,s);return n&&this.sp!==i-e&&r===this.activeContext&&117!==t&&118!==t&&218!==t&&!this.frozen&&this.warnOnce("stack unbalanced after primitive "+t,"error"),n},createActualMessage:function(t,e,s){var i=this.instantiateClass(this.specialObjects[15],0),r=this.instantiateClass(this.specialObjects[7],e);return this.arrayCopy(this.activeContext.pointers,this.sp-e+1,r.pointers,0,e),i.pointers[0]=t,i.pointers[1]=r,i.pointers.length>2&&(i.pointers[2]=s),i},primitivePerform:function(t){var e=this.stackValue(t-1),s=this.stackValue(t),i=t-1,r=this.findSelectorInClass(e,i,this.getClass(s),t);if(r.selector===e){if(r.argCount!==i)return!1;var n=this.activeContext.pointers,a=this.sp-i;this.arrayCopy(n,a+1,n,a,i),this.sp--}else s=this.stackValue(r.argCount);return this.executeNewMethod(s,r.method,r.argCount,r.primIndex,r.mClass,e),!0},primitivePerformWithArgs:function(t,e){var s=e?3:2,i=this.stackValue(s),r=this.stackValue(s-1),n=this.stackValue(s-2);if(n.sqClass!==this.specialObjects[7])return!1;var a=e?this.top():this.getClass(i);if(e)for(var o=this.getClass(i);o!==a;)if((o=o.superclass()).isNil)return!1;var c=n.pointersSize(),h=this.findSelectorInClass(r,c,a,t);if(h.selector===r){if(h.argCount!==c)return!1;var u=this.activeContext.pointers,l=this.sp-(t-1);u[l-1]=i,this.arrayCopy(n.pointers,0,u,l,c),this.sp+=c-t}else i=this.stackValue(h.argCount);return this.executeNewMethod(i,h.method,h.argCount,h.primIndex,h.mClass,r),!0},primitiveInvokeObjectAsMethod:function(t,e){for(var s=this.instantiateClass(this.specialObjects[7],t),i=0;i<t;i++)s.pointers[t-i-1]=this.pop();var r=this.pop(),n=this.currentSelector,a=this.specialObjects[49];return this.push(e),this.push(n),this.push(s),this.push(r),this.send(a,3,!1),!0},findMethodCacheEntry:function(t,e){var s;this.methodCacheRandomish=this.methodCacheRandomish+1&3;for(var i=(t.hash^e.hash)&this.methodCacheMask,r=i,n=0;n<4;n++){if((s=this.methodCache[r]).selector===t&&s.lkupClass===e)return s;n===this.methodCacheRandomish&&(i=r),r=r+t.hash&this.methodCacheMask}return(s=this.methodCache[i]).lkupClass=e,s.selector=t,s.method=null,s},flushMethodCache:function(){for(var t=0;t<this.methodCacheSize;t++)this.methodCache[t].selector=null,this.methodCache[t].method=null;return!0},flushMethodCacheForSelector:function(t){for(var e=0;e<this.methodCacheSize;e++)this.methodCache[e].selector===t&&(this.methodCache[e].selector=null,this.methodCache[e].method=null);return!0},flushMethodCacheForMethod:function(t){for(var e=0;e<this.methodCacheSize;e++)this.methodCache[e].method===t&&(this.methodCache[e].selector=null,this.methodCache[e].method=null);return!0},flushMethodCacheAfterBecome:function(t){this.flushMethodCache()}},"contexts",{isUnwindMarked:function(t){return!!this.isMethodContext(t)&&198==t.pointers[3].methodPrimitiveIndex()},newActiveContext:function(t){this.storeContextRegisters(),this.activeContext=t,this.activeContext.dirty=!0,this.fetchContextRegisters(t),this.breakOnContextChanged&&(this.breakOnContextChanged=!1,this.breakNow())},exportThisContext:function(){return this.storeContextRegisters(),this.reclaimableContextCount=0,this.activeContext},fetchContextRegisters:function(t){var e=t.pointers[3];this.isSmallInt(e)?(this.homeContext=t.pointers[5],e=this.homeContext.pointers[3]):this.homeContext=t,this.receiver=this.homeContext.pointers[5],this.method=e,this.pc=this.decodeSqueakPC(t.pointers[1],e),this.sp=this.decodeSqueakSP(t.pointers[2])},storeContextRegisters:function(){this.activeContext.pointers[1]=this.encodeSqueakPC(this.pc,this.method),this.activeContext.pointers[2]=this.encodeSqueakSP(this.sp)},encodeSqueakPC:function(t,e){return t+4*e.pointers.length+1},decodeSqueakPC:function(t,e){return t-4*e.pointers.length-1},encodeSqueakSP:function(t){return t-5},decodeSqueakSP:function(t){return t+5},recycleIfPossible:function(t){if(this.isMethodContext(t))if(22===t.pointersSize())t.pointers[0]=this.freeContexts,this.freeContexts=t;else{if(62!==t.pointersSize())return;t.pointers[0]=this.freeLargeContexts,this.freeLargeContexts=t}},allocateOrRecycleContext:function(t){var e;return t?this.freeLargeContexts.isNil?(this.nAllocatedContexts++,this.instantiateClass(this.specialObjects[10],56)):(e=this.freeLargeContexts,this.freeLargeContexts=e.pointers[0],this.nRecycledContexts++,e):this.freeContexts.isNil?(this.nAllocatedContexts++,this.instantiateClass(this.specialObjects[10],16)):(e=this.freeContexts,this.freeContexts=e.pointers[0],this.nRecycledContexts++,e)}},"stack access",{pop:function(){return this.activeContext.pointers[this.sp--]},popN:function(t){this.sp-=t},push:function(t){this.activeContext.pointers[++this.sp]=t},popNandPush:function(t,e){this.activeContext.pointers[this.sp-=t-1]=e},top:function(){return this.activeContext.pointers[this.sp]},stackTopPut:function(t){this.activeContext.pointers[this.sp]=t},stackValue:function(t){return this.activeContext.pointers[this.sp-t]},stackInteger:function(t){return this.checkSmallInt(this.stackValue(t))},stackIntOrFloat:function(t){var e=this.stackValue(t);if("number"==typeof e)return e;if(void 0===e)return this.success=!1,0;if(e.isFloat)return this.resultIsFloat=!0,e.float;var s=e.bytes;if(s&&4==s.length){for(var i=0,r=3;r>=0;r--)i=256*i+s[r];if(e.sqClass===this.specialObjects[13])return i;if(e.sqClass===this.specialObjects[42])return-i}return this.success=!1,0},pop2AndPushIntResult:function(t){return!(!this.success||!this.canBeSmallInt(t))&&(this.popNandPush(2,t),!0)},pop2AndPushNumResult:function(t){if(this.success){if(this.resultIsFloat)return this.popNandPush(2,this.primHandler.makeFloat(t)),!0;if(t>=-1073741824&&t<=1073741823)return this.popNandPush(2,t),!0;if(t>=-4294967295&&t<=4294967295){var e=t<0,s=e?-t:t,i=e?42:13,r=this.instantiateClass(this.specialObjects[i],4),n=r.bytes;return n[0]=255&s,n[1]=s>>8&255,n[2]=s>>16&255,n[3]=s>>24&255,this.popNandPush(2,r),!0}}return!1},pop2AndPushBoolResult:function(t){return!!this.success&&(this.popNandPush(2,t?this.trueObj:this.falseObj),!0)}},"numbers",{getClass:function(t){return this.isSmallInt(t)?this.specialObjects[5]:t.sqClass},canBeSmallInt:function(t){return t>=-1073741824&&t<=1073741823},isSmallInt:function(t){return"number"==typeof t},checkSmallInt:function(t){return"number"==typeof t?t:(this.success=!1,1)},quickDivide:function(t,e){if(0===e)return-1342177280;var s=t/e|0;return s*e===t?s:-1342177280},div:function(t,e){return 0===e?-1342177280:Math.floor(t/e)},mod:function(t,e){return 0===e?-1342177280:t-Math.floor(t/e)*e},safeShift:function(t,e){if(e<0)return e<-31?t<0?-1:0:t>>-e;if(e>31)return 0===t?0:-1342177280;var s=t<<e;return s>>e!==t?-1342177280:s}},"utils",{isContext:function(t){return t.sqClass===this.specialObjects[10]||t.sqClass===this.specialObjects[11]},isMethodContext:function(t){return t.sqClass===this.specialObjects[10]},instantiateClass:function(t,e){return this.image.instantiateClass(t,e,this.nilObj)},arrayFill:function(t,e,s,i){for(var r=e;r<s;r++)t[r]=i},arrayCopy:function(t,e,s,i,r){if(t===s&&e<i)for(var n=r-1;n>=0;n--)s[i+n]=t[e+n];else for(n=0;n<r;n++)s[i+n]=t[e+n]},signalLowSpaceIfNecessary:function(t){if(t<this.lowSpaceThreshold&&this.lowSpaceThreshold>0){var e=prompt&&prompt("Out of memory, "+Math.ceil(this.image.totalMemory/1e6)+" MB used.\nEnter additional MB, or 0 to signal low space in image","0");if(e){var s=1e6*parseInt(e,10);this.image.totalMemory+=s,this.signalLowSpaceIfNecessary(this.image.bytesLeft())}else{console.warn("squeak: low memory ("+t+"/"+this.image.totalMemory+" bytes left), signaling low space"),this.signalLowSpace=!0,this.lowSpaceThreshold=0,this.specialObjects[22].isNil&&(this.specialObjects[22]=this.primHandler.activeProcess()),this.forceInterruptCheck()}}}},"debugging",{addMessage:function(t){return this.messages[t]?++this.messages[t]:this.messages[t]=1},warnOnce:function(t,e){if(1==this.addMessage(t))return console[e||"warn"](t),!0},printMethod:function(t,e,s,i){if(t.sqClass!=this.specialObjects[16])return this.printMethod(t.blockOuterCode(),e,s,i);var r;if(s){var n=e.className()+">>",a=s.bytesAsString();if(i&&i.length)for(var o=a.replace(/(:[a-zA-Z])/g,": $1").split(" :"),c=0;c<i.length;c++)c>0&&(n+=" "),n+=o[c]+" "+i[c];else n+=a;return n}return t||(t=this.activeContext.contextMethod()),this.allMethodsDo((function(e,s,i){if(s===t)return r=e.className()+">>"+i.bytesAsString()})),r||(e?"("+e.pointers[5]+")>>?":"?>>?")},allInstancesOf:function(t,e){"string"==typeof t&&(t=this.globalNamed(t));for(var s=[],i=this.image.someInstanceOf(t);i;)e?e(i):s.push(i),i=this.image.nextInstanceAfter(i);return s},globalNamed:function(t){return this.allGlobalsDo((function(e,s){if(e.bytesAsString()===t)return s}))},allGlobalsDo:function(t){for(var e=this.getGlobals(),s=0;s<e.length;s++){var i=e[s];if(!i.isNil){var r=t(i.pointers[0],i.pointers[1]);if(r)return r}}},allMethodsDo:function(t){this.allGlobalsDo((function(e,s){if(s.pointers&&s.pointers.length>=9)for(var i=[s,s.sqClass],r=0;r<i.length;r++){var n=i[r],a=n.pointers[1];if(a.pointers&&a.pointers[1]){var o=a.pointers[1].pointers;if(o){var c=a.pointers;if(o.length+2===c.length)for(var h=0;h<o.length;h++){var u=o[h],l=c[2+h];if(u.isMethod&&u.isMethod())if(l.bytesSize&&l.bytesSize())if(t.call(null,n,u,l))return!0}}}}}))},printStack:function(t,e,s){"number"==typeof t&&(e=t,t=null),t||(t=this.activeContext),e||(e=100);for(var i=[],r=Math.max(e,1e6);!t.isNil&&r-- >0;)i.push(t),t=t.pointers[0];i.length>e+200&&(t.isNil||i.push("..."),i=i.slice(0,e).concat(["..."]).concat(i.slice(-200)));var n=[],a=i.length,o="";for(s&&this.logSends&&(o=Array((""+this.sendCount).length+2).join(" "));a-- >0;){if((t=i[a]).pointers){var c="",h=t.pointers[3];"number"==typeof h?(h=t.pointers[5].pointers[3],c="[] in "):t.pointers[4].isNil||(c="[] in ");var u=c+this.printMethod(h,t);s&&(u=o+u),n.push(u+"\n"),s&&(o+=s)}else n.push("...\n")}return n.join("")},findMethod:function(t){var e,s=t.split(">>")[0],i=t.split(">>")[1];return this.allMethodsDo((function(t,r,n){if(i.length==n.bytesSize()&&i==n.bytesAsString()&&s==t.className())return e=r})),e},breakAfter:function(t){this.breakOutTick=this.primHandler.millisecondClockValue()+t},breakNow:function(t){t&&console.log("Break: "+t),this.breakOutOfInterpreter="break"},breakOn:function(t){return this.breakOnMethod=t&&this.findMethod(t)},breakOnReturnFromThisContext:function(){this.breakOnContextChanged=!1,this.breakOnContextReturned=this.activeContext},breakOnSendOrReturn:function(){this.breakOnContextChanged=!0,this.breakOnContextReturned=null},printContext:function(t,e){if(!this.isContext(t))return"NOT A CONTEXT: "+s(t);function s(t){var s="number"==typeof t||"object"==typeof t?t.sqInstName():"<"+t+">";return(s=JSON.stringify(s).slice(1,-1)).length>e-3&&(s=s.slice(0,e-3)+"..."),s}e||(e=72);for(var i="number"==typeof t.pointers[3],r=t.pointers[4],n=!i&&!r.isNil,a=i?t.pointers[5]:t,o=n?r.pointers[2]:a.pointers[3].methodTempCount(),c=this.decodeSqueakSP(0),h=a.contextSizeWithStack(this)-1,u=c+1,l=u+o-1,p=u+a.pointers[3].methodNumArgs()-1,m="",f=c;f<=h;f++){var d="";f===c?d="=rcvr":(f<=l&&(d="=tmp"+(f-u)),f<=p&&(d+="/arg"+(f-u))),m+="\nctx["+f+"]"+d+": "+s(a.pointers[f])}if(i){m+="\n";var v=t.pointers[3],g=this.decodeSqueakSP(1),b=(p=g+v,t===this.activeContext?this.sp:t.pointers[2]);b<g&&(m+="\nblk <stack empty>");for(f=g;f<=b;f++){d="";f<p&&(d="=arg"+(f-g)),m+="\nblk["+f+"]"+d+": "+s(t.pointers[f])}}return m},printActiveContext:function(t){return this.printContext(this.activeContext,t)},printAllProcesses:function(){for(var t=this.specialObjects[3].pointers[1],e=t.pointers[1],s="Active: "+this.printProcess(e,!0),i=t.pointers[0].pointers,r=i.length-1;r>=0;r--)for(var n=i[r].pointers[0];!n.isNil;)s+="\n------------------------------------------",s+="\nRunnable: "+this.printProcess(n),n=n.pointers[0];for(var a=this.specialObjects[18],o=this.image.someInstanceOf(a),c=[];o;){for(n=o.pointers[0];!n.isNil;)c.push(n),n=n.pointers[0];o=this.image.nextInstanceAfter(o)}c.sort((function(t,e){return e.pointers[2]-t.pointers[2]}));for(var h=0;h<c.length;h++)s+="\n------------------------------------------",s+="\nWaiting: "+this.printProcess(c[h]);return s},printProcess:function(t,e,s){t||(t=this.specialObjects[3].pointers[1].pointers[1],e=!0);var i=e?this.activeContext:t.pointers[1],r=t.pointers[2],n=this.printStack(i,20,s),a=s&&this.logSends?"":this.printContext(i)+"\n";return t.toString()+" at priority "+r+"\n"+n+a},printByteCodes:function(t,e,s,i){return t||(t=this.method),new Squeak.InstructionPrinter(t,this).printInstructions(e,s,i)},logStack:function(){console.log(this.printStack()+this.printActiveContext()+"\n\n"+this.printByteCodes(this.method,"   ","=> ",this.pc),this.activeContext.pointers.slice(0,this.sp+1))},willSendOrReturn:function(){var t=this.method.bytes[this.pc];if(this.method.methodSignFlag()){if(96<=t&&t<=127)s=this.specialSelectors[2*(t-96)];else if(128<=t&&t<=175)s=this.method.methodGetSelector(15&t);else if(234==t||235==t)this.method.methodGetSelector(this.method.bytes[this.pc+1]>>3);else if(88<=t&&t<=94)return!0}else{if(t>=120&&t<=125)return!0;if(t<131||200==t)return!1;if(t>=176)return!0;if(t<=134){var e;if(132===t){if(this.method.bytes[this.pc+1]>>5>1)return!1;e=this.method.bytes[this.pc+2]}else e=this.method.bytes[this.pc+1]&(134===t?63:31);var s=this.method.methodGetLiteral(e);if("blockCopy:"!==s.bytesAsString())return!0}}return!1},nextSendSelector:function(){var t,e=this.method.bytes[this.pc];if(this.method.methodSignFlag())if(96<=e&&e<=127)t=this.specialSelectors[2*(e-96)];else if(128<=e&&e<=175)t=this.method.methodGetSelector(15&e);else{if(234!=e&&235!=e)return null;this.method.methodGetSelector(this.method.bytes[this.pc+1]>>3)}else{if(e<131||200==e)return null;if(e>=208)t=this.method.methodGetLiteral(15&e);else if(e>=176)t=this.specialSelectors[2*(e-176)];else if(e<=134){var s;if(132===e){if(this.method.bytes[this.pc+1]>>5>1)return null;s=this.method.bytes[this.pc+2]}else s=this.method.bytes[this.pc+1]&(134===e?63:31);t=this.method.methodGetLiteral(s)}}if(t){var i=t.bytesAsString();if("blockCopy:"!==i)return i}}}),Object.subclass("Squeak.InterpreterProxy","initialization",{VM_PROXY_MAJOR:1,VM_PROXY_MINOR:11,initialize:function(t){this.vm=t,this.remappableOops=[],Object.defineProperty(this,"successFlag",{get:function(){return t.primHandler.success},set:function(e){t.primHandler.success=e}})},majorVersion:function(){return this.VM_PROXY_MAJOR},minorVersion:function(){return this.VM_PROXY_MINOR}},"success",{failed:function(){return!this.successFlag},primitiveFail:function(){this.successFlag=!1},primitiveFailFor:function(t){this.successFlag=!1},success:function(t){t||(this.successFlag=!1)}},"stack access",{pop:function(t){this.vm.popN(t)},popthenPush:function(t,e){this.vm.popNandPush(t,e)},push:function(t){this.vm.push(t)},pushBool:function(t){this.vm.push(t?this.vm.trueObj:this.vm.falseObj)},pushInteger:function(t){this.vm.push(t)},pushFloat:function(t){this.vm.push(this.floatObjectOf(t))},stackValue:function(t){return this.vm.stackValue(t)},stackIntegerValue:function(t){var e=this.vm.stackValue(t);return"number"==typeof e?e:(this.successFlag=!1,0)},stackFloatValue:function(t){this.vm.success=!0;var e=this.vm.stackIntOrFloat(t);return this.vm.success?e:(this.successFlag=!1,0)},stackObjectValue:function(t){var e=this.vm.stackValue(t);return"number"!=typeof e?e:(this.successFlag=!1,this.vm.nilObj)},stackBytes:function(t){var e=this.vm.stackValue(t);return e.bytes?e.bytes:("number"!=typeof e&&e.isBytes()||(this.successFlag=!1),[])},stackWords:function(t){var e=this.vm.stackValue(t);return e.words?e.words:("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackInt32Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsInt32Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackInt16Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsInt16Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackUint16Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsUint16Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])}},"object access",{isBytes:function(t){return"number"!=typeof t&&t.isBytes()},isWords:function(t){return"number"!=typeof t&&t.isWords()},isWordsOrBytes:function(t){return"number"!=typeof t&&t.isWordsOrBytes()},isPointers:function(t){return"number"!=typeof t&&t.isPointers()},isIntegerValue:function(t){return"number"==typeof t&&t>=-1073741824&&t<=1073741823},isArray:function(t){return t.sqClass===this.vm.specialObjects[7]},isMemberOf:function(t,e){var s=t.sqClass.pointers[6].bytes;if(e.length!==s.length)return!1;for(var i=0;i<e.length;i++)if(e.charCodeAt(i)!==s[i])return!1;return!0},booleanValueOf:function(t){return!!t.isTrue||(t.isFalse||(this.successFlag=!1),!1)},positive32BitValueOf:function(t){return this.vm.primHandler.positive32BitValueOf(t)},positive32BitIntegerFor:function(t){return this.vm.primHandler.pos32BitIntFor(t)},floatValueOf:function(t){return t.isFloat?t.float:(this.successFlag=!1,0)},floatObjectOf:function(t){return this.vm.primHandler.makeFloat(t)},fetchPointerofObject:function(t,e){return e.pointers[t]},fetchBytesofObject:function(t,e){var s=e.pointers[t];return s.bytes?s.bytes:s.words?s.wordsAsUint8Array():("number"!=typeof s&&s.isWordsOrBytes()||(this.successFlag=!1),[])},fetchWordsofObject:function(t,e){var s=e.pointers[t];return s.words?s.words:("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchInt32ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsInt32Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchInt16ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsInt16Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchUint16ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsUint16Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchIntegerofObject:function(t,e){var s=e.pointers[t];return"number"==typeof s?s:(this.successFlag=!1,0)},fetchLong32ofObject:function(t,e){return e.words[t]},fetchFloatofObject:function(t,e){return this.floatValueOf(e.pointers[t])},storeIntegerofObjectwithValue:function(t,e,s){"number"==typeof s?e.pointers[t]=s:this.successFlag=!1},storePointerofObjectwithValue:function(t,e,s){e.pointers[t]=s},stObjectatput:function(t,e,s){if(t.sqClass!==this.classArray())throw Error("Array expected");if(e<1||e>t.pointers.length)return this.successFlag=!1;t.pointers[e-1]=s}},"constant access",{isKindOfInteger:function(t){return"number"==typeof t||t.sqClass==this.classLargeNegativeInteger()||t.sqClass==this.classLargePositiveInteger()},classArray:function(){return this.vm.specialObjects[7]},classBitmap:function(){return this.vm.specialObjects[4]},classSmallInteger:function(){return this.vm.specialObjects[5]},classLargePositiveInteger:function(){return this.vm.specialObjects[13]},classLargeNegativeInteger:function(){return this.vm.specialObjects[42]},classPoint:function(){return this.vm.specialObjects[12]},classString:function(){return this.vm.specialObjects[6]},classByteArray:function(){return this.vm.specialObjects[26]},nilObject:function(){return this.vm.nilObj},falseObject:function(){return this.vm.falseObj},trueObject:function(){return this.vm.trueObj}},"vm functions",{clone:function(t){return this.vm.image.clone(t)},instantiateClassindexableSize:function(t,e){return this.vm.instantiateClass(t,e)},methodArgumentCount:function(){return this.argCount},makePointwithxValueyValue:function(t,e){return this.vm.primHandler.makePointWithXandY(t,e)},pushRemappableOop:function(t){this.remappableOops.push(t)},popRemappableOop:function(){return this.remappableOops.pop()},showDisplayBitsLeftTopRightBottom:function(t,e,s,i,r){if(e<i&&s<r){var n={left:e,top:s,right:i,bottom:r};this.vm.primHandler.displayDirty(t,n)}},ioLoadFunctionFrom:function(t,e){return this.vm.primHandler.loadFunctionFrom(t,e)}}),Object.subclass("Squeak.InstructionStream","initialization",{initialize:function(t,e){this.vm=e,this.method=t,this.pc=0,this.specialConstants=[e.trueObj,e.falseObj,e.nilObj,-1,0,1,2]}},"decoding",{interpretNextInstructionFor:function(t){var e=this.method,s=e.bytes[this.pc++],i=s/16|0,r=s%16;if(0===i)return t.pushReceiverVariable(r);if(1===i)return t.pushTemporaryVariable(r);if(2===i)return t.pushConstant(e.methodGetLiteral(r));if(3===i)return t.pushConstant(e.methodGetLiteral(r+16));if(4===i)return t.pushLiteralVariable(e.methodGetLiteral(r));if(5===i)return t.pushLiteralVariable(e.methodGetLiteral(r+16));if(6===i)return r<8?t.popIntoReceiverVariable(r):t.popIntoTemporaryVariable(r-8);if(7===i){if(0===r)return t.pushReceiver();if(r<8)return t.pushConstant(this.specialConstants[r-1]);if(8===r)return t.methodReturnReceiver();if(r<12)return t.methodReturnConstant(this.specialConstants[r-9]);if(12===r)return t.methodReturnTop();if(13===r)return t.blockReturnTop();if(r>13)throw Error("unusedBytecode")}return 8===i?this.interpretExtension(r,e,t):9===i?r<8?t.jump(r+1):t.jumpIf(!1,r-8+1):10===i?(s=this.method.bytes[this.pc++],r<8?t.jump(256*(r-4)+s):t.jumpIf(r<12,256*(3&r)+s)):11===i?t.send(this.vm.specialSelectors[2*r],this.vm.specialSelectors[2*r+1],!1):12===i?t.send(this.vm.specialSelectors[2*(r+16)],this.vm.specialSelectors[2*(r+16)+1],!1):i>12?t.send(e.methodGetLiteral(r),i-13,!1):void 0},interpretExtension:function(t,e,s){if(t<=6){var i=this.method.bytes[this.pc++];if(t<=2){var r=i/64|0,n=i%64;if(0===t){if(0===r)return s.pushReceiverVariable(n);if(1===r)return s.pushTemporaryVariable(n);if(2===r)return s.pushConstant(this.method.methodGetLiteral(n));if(3===r)return s.pushLiteralVariable(this.method.methodGetLiteral(n))}if(1===t){if(0===r)return s.storeIntoReceiverVariable(n);if(1===r)return s.storeIntoTemporaryVariable(n);if(2===r)throw Error("illegalStore");if(3===r)return s.storeIntoLiteralVariable(this.method.methodGetLiteral(n))}if(2===t){if(0===r)return s.popIntoReceiverVariable(n);if(1===r)return s.popIntoTemporaryVariable(n);if(2===r)throw Error("illegalStore");if(3===r)return s.popIntoLiteralVariable(this.method.methodGetLiteral(n))}}if(3===t)return s.send(this.method.methodGetLiteral(i%32),i/32|0,!1);if(4===t){var a=this.method.bytes[this.pc++];if(0===(r=i/32|0))return s.send(this.method.methodGetLiteral(a),i%32,!1);if(1===r)return s.send(this.method.methodGetLiteral(a),i%32,!0);if(2===r)return s.pushReceiverVariable(a);if(3===r)return s.pushConstant(this.method.methodGetLiteral(a));if(4===r)return s.pushLiteralVariable(this.method.methodGetLiteral(a));if(5===r)return s.storeIntoReceiverVariable(a);if(6===r)return s.popIntoReceiverVariable(a);if(7===r)return s.storeIntoLiteralVariable(this.method.methodGetLiteral(a))}if(5===t)return s.send(this.method.methodGetLiteral(31&i),i>>5,!0);if(6===t)return s.send(this.method.methodGetLiteral(63&i),i>>6,!1)}if(7===t)return s.doPop();if(8===t)return s.doDup();if(9===t)return s.pushActiveContext();i=this.method.bytes[this.pc++];if(10===t)return i<128?s.pushNewArray(i):s.popIntoNewArray(i-128);a=this.method.bytes[this.pc++];if(11===t)return s.callPrimitive(i+256*a);if(12===t)return s.pushRemoteTemp(i,a);if(13===t)return s.storeIntoRemoteTemp(i,a);if(14===t)return s.popIntoRemoteTemp(i,a);var o=this.method.bytes[this.pc++];return s.pushClosureCopy(i>>4,15&i,256*a+o)}}),Squeak.InstructionStream.subclass("Squeak.InstructionStreamSista","decoding",{interpretNextInstructionFor:function(t){return this.interpretNextInstructionExtFor(t,0,0)},interpretNextInstructionExtFor:function(t,e,s){this.Squeak;var i=this.method.bytes[this.pc++];switch(i){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return t.pushReceiverVariable(15&i);case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:return t.pushLiteralVariable(this.method.methodGetLiteral(15&i));case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:return t.pushConstant(this.method.methodGetLiteral(31&i));case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:return t.pushTemporaryVariable(15&i);case 72:case 73:case 74:case 75:return t.pushTemporaryVariable(8+(3&i));case 76:return t.pushReceiver();case 77:return t.pushConstant(this.vm.trueObj);case 78:return t.pushConstant(this.vm.falseObj);case 79:return t.pushConstant(this.vm.nilObj);case 80:return t.pushConstant(0);case 81:return t.pushConstant(1);case 82:return t.pushActiveContext();case 83:return t.doDup();case 88:return t.methodReturnReceiver();case 89:return t.methodReturnConstant(this.vm.trueObj);case 90:return t.methodReturnConstant(this.vm.falseObj);case 91:return t.methodReturnConstant(this.vm.nilObj);case 92:return t.methodReturnTop();case 93:return t.blockReturnConstant(this.vm.nilObj);case 94:if(0===e)return t.blockReturnTop();break;case 95:return t.nop();case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:return t.send(this.vm.specialSelectors[2*(i-96)],this.vm.specialSelectors[2*(i-96)+1],!1);case 128:case 129:case 130:case 131:case 132:case 133:case 134:case 135:case 136:case 137:case 138:case 139:case 140:case 141:case 142:case 143:return t.send(this.method.methodGetLiteral(15&i),0,!1);case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:return t.send(this.method.methodGetLiteral(15&i),1,!1);case 160:case 161:case 162:case 163:case 164:case 165:case 166:case 167:case 168:case 169:case 170:case 171:case 172:case 173:case 174:case 175:return t.send(this.method.methodGetLiteral(15&i),2,!1);case 176:case 177:case 178:case 179:case 180:case 181:case 182:case 183:return t.jump(1+(7&i));case 184:case 185:case 186:case 187:case 188:case 189:case 190:case 191:return t.jumpIf(!0,1+(7&i));case 192:case 193:case 194:case 195:case 196:case 197:case 198:case 199:return t.jumpIf(!1,1+(7&i));case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 207:return t.popIntoReceiverVariable(7&i);case 208:case 209:case 210:case 211:case 212:case 213:case 214:case 215:return t.popIntoTemporaryVariable(i-208);case 216:return t.doPop()}var r=this.method.bytes[this.pc++];switch(i){case 224:return this.interpretNextInstructionExtFor(t,(e<<8)+r,s);case 225:return this.interpretNextInstructionExtFor(t,e,(s<<8)+(r<128?r:r-256));case 226:return t.pushReceiverVariable(r+(e<<8));case 227:return t.pushLiteralVariable(this.method.methodGetLiteral(r+(e<<8)));case 228:return t.pushConstant(this.method.methodGetLiteral(r+(e<<8)));case 229:return t.pushTemporaryVariable(r);case 231:return r<128?t.pushNewArray(r):t.popIntoNewArray(r-128);case 232:return t.pushConstant(r+(s<<8));case 233:var n=r+(s<<8);return t.pushConstant("$"+String.fromCodePoint(n)+" ("+n+")");case 234:return t.send(this.method.methodGetSelector((r>>3)+(e<<5)),(7&r)+(s<<3),!1);case 235:var a=this.method.methodGetSelector((r>>3)+(e<<5));return s>=64?t.sendSuperDirected(a):t.send(a,(7&r)+(s<<3),!0);case 237:return t.jump(r+(s<<8));case 238:return t.jumpIf(!0,r+(s<<8));case 239:return t.jumpIf(!1,r+(s<<8));case 240:return t.popIntoReceiverVariable(r+(e<<8));case 241:return t.popIntoLiteralVariable(this.method.methodGetLiteral(r+(e<<8)));case 242:return t.popIntoTemporaryVariable(r);case 243:return t.storeIntoReceiverVariable(r+(e<<8));case 244:return t.storeIntoLiteralVariable(this.method.methodGetLiteral(r+(e<<8)));case 245:return t.storeIntoTemporaryVariable(r)}var o=this.method.bytes[this.pc++];switch(i){case 248:return t.callPrimitive(r+(o<<8));case 249:var c=r+(e<<8),h=63&o,u=this.method.methodGetLiteral(c);return t.pushFullClosure(c,h,u.methodNumArgs());case 250:var l=(7&r)+8*this.mod(e,16),p=(h=(r>>3&7)+8*this.div(e,16),o+(s<<8));return t.pushClosureCopy(h,l,p);case 251:return t.pushRemoteTemp(r,o);case 252:return t.storeIntoRemoteTemp(r,o);case 253:return t.popIntoRemoteTemp(r,o)}throw Error("Unknown bytecode: "+i)}}),Object.subclass("Squeak.InstructionPrinter","initialization",{initialize:function(t,e){this.method=t,this.vm=e}},"printing",{printInstructions:function(t,e,s){this.indent=t,this.highlight=e,this.highlightPC=s,this.innerIndents={},this.result="",this.scanner=this.method.methodSignFlag()?new Squeak.InstructionStreamSista(this.method,this.vm):new Squeak.InstructionStream(this.method,this.vm),this.oldPC=this.scanner.pc,this.endPC=0,this.done=!1;try{for(;!this.done;)this.scanner.interpretNextInstructionFor(this)}catch(t){this.print("!!! "+t.message)}return this.result},print:function(t){this.oldPC===this.highlightPC?this.highlight&&(this.result+=this.highlight):this.indent&&(this.result+=this.indent),this.result+=this.oldPC;for(var e=0;e<this.innerIndents[this.oldPC];e++)this.result+="   ";this.result+=" <";for(e=this.oldPC;e<this.scanner.pc;e++)e>this.oldPC&&(this.result+=" "),this.result+=(this.method.bytes[e]+256).toString(16).substr(-2).toUpperCase();this.result+="> "+t+"\n",this.oldPC=this.scanner.pc}},"decoding",{blockReturnConstant:function(t){this.print("blockReturn: "+t.toString()),this.done=this.scanner.pc>this.endPC},blockReturnTop:function(){this.print("blockReturn"),this.done=this.scanner.pc>this.endPC},doDup:function(){this.print("dup")},doPop:function(){this.print("pop")},jump:function(t){this.print("jumpTo: "+(this.scanner.pc+t)),this.scanner.pc+t>this.endPC&&(this.endPC=this.scanner.pc+t)},jumpIf:function(t,e){this.print((t?"jumpIfTrue: ":"jumpIfFalse: ")+(this.scanner.pc+e)),this.scanner.pc+e>this.endPC&&(this.endPC=this.scanner.pc+e)},methodReturnReceiver:function(){this.print("return: receiver"),this.done=this.scanner.pc>this.endPC},methodReturnTop:function(){this.print("return: topOfStack"),this.done=this.scanner.pc>this.endPC},methodReturnConstant:function(t){this.print("returnConst: "+t.toString()),this.done=this.scanner.pc>this.endPC},nop:function(){this.print("nop")},popIntoLiteralVariable:function(t){this.print("popIntoBinding: "+t.assnKeyAsString())},popIntoReceiverVariable:function(t){this.print("popIntoInstVar: "+t)},popIntoTemporaryVariable:function(t){this.print("popIntoTemp: "+t)},pushActiveContext:function(){this.print("push: thisContext")},pushConstant:function(t){var e=t.sqInstName?t.sqInstName():t.toString();this.print("pushConst: "+e)},pushLiteralVariable:function(t){this.print("pushBinding: "+t.assnKeyAsString())},pushReceiver:function(){this.print("push: self")},pushReceiverVariable:function(t){this.print("pushInstVar: "+t)},pushTemporaryVariable:function(t){this.print("pushTemp: "+t)},send:function(t,e,s){this.print((s?"superSend: #":"send: #")+(t.bytesAsString?t.bytesAsString():t))},sendSuperDirected:function(t){this.print("directedSuperSend: #"+(t.bytesAsString?t.bytesAsString():t))},storeIntoLiteralVariable:function(t){this.print("storeIntoBinding: "+t.assnKeyAsString())},storeIntoReceiverVariable:function(t){this.print("storeIntoInstVar: "+t)},storeIntoTemporaryVariable:function(t){this.print("storeIntoTemp: "+t)},pushNewArray:function(t){this.print("push: (Array new: "+t+")")},popIntoNewArray:function(t){this.print("pop: "+t+" into: (Array new: "+t+")")},pushRemoteTemp:function(t,e){this.print("push: "+t+" ofTemp: "+e)},storeIntoRemoteTemp:function(t,e){this.print("storeInto: "+t+" ofTemp: "+e)},popIntoRemoteTemp:function(t,e){this.print("popInto: "+t+" ofTemp: "+e)},pushClosureCopy:function(t,e,s){var i=this.scanner.pc,r=i+s;this.print("closure("+i+"-"+(r-1)+"): "+t+" copied, "+e+" args");for(var n=i;n<r;n++)this.innerIndents[n]=(this.innerIndents[n]||0)+1;r>this.endPC&&(this.endPC=r)},pushFullClosure:function(t,e,s){this.print("pushFullClosure: (self literalAt: "+(t+1)+") numCopied: "+e+" numArgs: "+s)},callPrimitive:function(t){this.print("primitive: "+t)}}),Object.subclass("Squeak.Primitives","initialization",{initialize:function(t,e){this.vm=t,this.oldPrims=!this.vm.image.hasClosures,this.allowAccessBeyondSP=this.oldPrims,this.deferDisplayUpdates=!1,this.semaphoresToSignal=[],this.initDisplay(e),this.initAtCache(),this.initModules(),this.initPlugins(),t.image.isSpur&&(this.charFromInt=this.charFromIntSpur,this.charToInt=this.charToIntSpur,this.identityHash=this.identityHashSpur)},initDisplay:function(t){this.display=t},initModules:function(){this.loadedModules={},this.builtinModules={},this.patchModules={},this.interpreterProxy=new Squeak.InterpreterProxy(this.vm)},initPlugins:function(){}},"dispatch",{quickSendOther:function(t,e){switch(this.success=!0,e){case 0:return this.popNandPushIfOK(2,this.objectAt(!0,!0,!1));case 1:return this.popNandPushIfOK(3,this.objectAtPut(!0,!0,!1));case 2:return this.popNandPushIfOK(1,this.objectSize(!0));case 6:return this.popNandPushBoolIfOK(2,this.vm.stackValue(1)===this.vm.stackValue(0));case 7:return this.popNandPushIfOK(1,this.vm.getClass(this.vm.top()));case 8:return this.popNandPushIfOK(2,this.doBlockCopy());case 9:return this.primitiveBlockValue(0);case 10:return this.primitiveBlockValue(1)}return!1},doPrimitive:function(t,e,s){switch(this.success=!0,t){case 1:return this.popNandPushIntIfOK(e+1,this.stackInteger(1)+this.stackInteger(0));case 2:return this.popNandPushIntIfOK(e+1,this.stackInteger(1)-this.stackInteger(0));case 3:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)<this.stackInteger(0));case 4:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)>this.stackInteger(0));case 5:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)<=this.stackInteger(0));case 6:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)>=this.stackInteger(0));case 7:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)===this.stackInteger(0));case 8:return this.popNandPushBoolIfOK(e+1,this.stackInteger(1)!==this.stackInteger(0));case 9:return this.popNandPushIntIfOK(e+1,this.stackInteger(1)*this.stackInteger(0));case 10:return this.popNandPushIntIfOK(e+1,this.vm.quickDivide(this.stackInteger(1),this.stackInteger(0)));case 11:return this.popNandPushIntIfOK(e+1,this.vm.mod(this.stackInteger(1),this.stackInteger(0)));case 12:return this.popNandPushIntIfOK(e+1,this.vm.div(this.stackInteger(1),this.stackInteger(0)));case 13:return this.popNandPushIntIfOK(e+1,this.stackInteger(1)/this.stackInteger(0)|0);case 14:return this.popNandPushIfOK(e+1,this.doBitAnd());case 15:return this.popNandPushIfOK(e+1,this.doBitOr());case 16:return this.popNandPushIfOK(e+1,this.doBitXor());case 17:return this.popNandPushIfOK(e+1,this.doBitShift());case 18:return this.primitiveMakePoint(e,!1);case 19:return!1;case 20:return this.primitiveRemLargeIntegers(e);case 21:return this.primitiveAddLargeIntegers(e);case 22:return this.primitiveSubtractLargeIntegers(e);case 23:return this.primitiveLessThanLargeIntegers(e);case 24:return this.primitiveGreaterThanLargeIntegers(e);case 25:return this.primitiveLessOrEqualLargeIntegers(e);case 26:return this.primitiveGreaterOrEqualLargeIntegers(e);case 27:return this.primitiveEqualLargeIntegers(e);case 28:return this.primitiveNotEqualLargeIntegers(e);case 29:return this.primitiveMultiplyLargeIntegers(e);case 30:return this.primitiveDivideLargeIntegers(e);case 31:return this.primitiveModLargeIntegers(e);case 32:return this.primitiveDivLargeIntegers(e);case 33:return this.primitiveQuoLargeIntegers(e);case 34:return this.vm.warnOnce("missing primitive: 34 (primitiveBitAndLargeIntegers)"),!1;case 35:return this.vm.warnOnce("missing primitive: 35 (primitiveBitOrLargeIntegers)"),!1;case 36:return this.vm.warnOnce("missing primitive: 36 (primitiveBitXorLargeIntegers)"),!1;case 37:return this.vm.warnOnce("missing primitive: 37 (primitiveBitShiftLargeIntegers)"),!1;case 38:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!1));case 39:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!1));case 40:return this.popNandPushFloatIfOK(e+1,this.stackInteger(0));case 41:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)+this.stackFloat(0));case 42:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)-this.stackFloat(0));case 43:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)<this.stackFloat(0));case 44:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)>this.stackFloat(0));case 45:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)<=this.stackFloat(0));case 46:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)>=this.stackFloat(0));case 47:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)===this.stackFloat(0));case 48:return this.popNandPushBoolIfOK(e+1,this.stackFloat(1)!==this.stackFloat(0));case 49:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)*this.stackFloat(0));case 50:return this.popNandPushFloatIfOK(e+1,this.safeFDiv(this.stackFloat(1),this.stackFloat(0)));case 51:return this.popNandPushIfOK(e+1,this.floatAsSmallInt(this.stackFloat(0)));case 52:return this.popNandPushFloatIfOK(e+1,this.floatFractionPart(this.stackFloat(0)));case 53:return this.popNandPushIntIfOK(e+1,this.frexp_exponent(this.stackFloat(0))-1);case 54:return this.popNandPushFloatIfOK(e+1,this.ldexp(this.stackFloat(1),this.stackFloat(0)));case 55:return this.popNandPushFloatIfOK(e+1,Math.sqrt(this.stackFloat(0)));case 56:return this.popNandPushFloatIfOK(e+1,Math.sin(this.stackFloat(0)));case 57:return this.popNandPushFloatIfOK(e+1,Math.atan(this.stackFloat(0)));case 58:return this.popNandPushFloatIfOK(e+1,Math.log(this.stackFloat(0)));case 59:return this.popNandPushFloatIfOK(e+1,Math.exp(this.stackFloat(0)));case 60:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!1));case 61:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!1));case 62:return this.popNandPushIfOK(e+1,this.objectSize(!1));case 63:return this.popNandPushIfOK(e+1,this.objectAt(!1,!0,!1));case 64:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!0,!1));case 65:return this.vm.warnOnce("missing primitive: 65 (primitiveNext)"),!1;case 66:return this.vm.warnOnce("missing primitive: 66 (primitiveNextPut)"),!1;case 67:return this.vm.warnOnce("missing primitive: 67 (primitiveAtEnd)"),!1;case 68:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 69:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 70:return this.popNandPushIfOK(e+1,this.instantiateClass(this.stackNonInteger(0),0));case 71:return this.popNandPushIfOK(e+1,this.instantiateClass(this.stackNonInteger(1),this.stackPos32BitInt(0)));case 72:return this.primitiveArrayBecome(e,!1,!0);case 73:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 74:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 75:return this.popNandPushIfOK(e+1,this.identityHash(this.stackNonInteger(0)));case 76:return this.primitiveStoreStackp(e);case 77:return this.popNandPushIfOK(e+1,this.someInstanceOf(this.stackNonInteger(0)));case 78:return this.popNandPushIfOK(e+1,this.nextInstanceAfter(this.stackNonInteger(0)));case 79:return this.primitiveNewMethod(e);case 80:return this.popNandPushIfOK(e+1,this.doBlockCopy());case 81:return this.primitiveBlockValue(e);case 82:return this.primitiveBlockValueWithArgs(e);case 83:return this.vm.primitivePerform(e);case 84:return this.vm.primitivePerformWithArgs(e,!1);case 85:return this.primitiveSignal();case 86:return this.primitiveWait();case 87:return this.primitiveResume();case 88:return this.primitiveSuspend();case 89:return this.vm.flushMethodCache();case 90:return this.primitiveMousePoint(e);case 91:return this.primitiveTestDisplayDepth(e);case 92:return this.vm.warnOnce("missing primitive: 92 (primitiveSetDisplayMode)"),!1;case 93:return this.primitiveInputSemaphore(e);case 94:return this.primitiveGetNextEvent(e);case 95:return this.primitiveInputWord(e);case 96:return this.namedPrimitive("BitBltPlugin","primitiveCopyBits",e);case 97:return this.primitiveSnapshot(e);case 98:return this.primitiveStoreImageSegment(e);case 99:return this.primitiveLoadImageSegment(e);case 100:return this.vm.primitivePerformWithArgs(e,!0);case 101:return this.primitiveBeCursor(e);case 102:return this.primitiveBeDisplay(e);case 103:return this.primitiveScanCharacters(e);case 104:return this.vm.warnOnce("missing primitive: 104 (primitiveDrawLoop)"),!1;case 105:return this.popNandPushIfOK(e+1,this.doStringReplace());case 106:return this.primitiveScreenSize(e);case 107:return this.primitiveMouseButtons(e);case 108:return this.primitiveKeyboardNext(e);case 109:return this.primitiveKeyboardPeek(e);case 110:return this.popNandPushBoolIfOK(e+1,this.vm.stackValue(1)===this.vm.stackValue(0));case 111:return this.popNandPushIfOK(e+1,this.vm.getClass(this.vm.top()));case 112:return this.popNandPushIfOK(e+1,this.vm.image.bytesLeft());case 113:return this.primitiveQuit(e);case 114:return this.primitiveExitToDebugger(e);case 115:return this.primitiveChangeClass(e);case 116:return this.vm.flushMethodCacheForMethod(this.vm.top());case 117:return this.doNamedPrimitive(e,s);case 118:return this.primitiveDoPrimitiveWithArgs(e);case 119:return this.vm.flushMethodCacheForSelector(this.vm.top());case 120:return this.primitiveCalloutToFFI(e,s);case 121:return this.primitiveImageName(e);case 122:return this.primitiveReverseDisplay(e);case 123:return this.vm.warnOnce("missing primitive: 123 (primitiveValueUninterruptably)"),!1;case 124:return this.popNandPushIfOK(e+1,this.registerSemaphore(17));case 125:return this.popNandPushIfOK(e+1,this.setLowSpaceThreshold());case 126:return this.primitiveDeferDisplayUpdates(e);case 127:return this.primitiveShowDisplayRect(e);case 128:return this.primitiveArrayBecome(e,!0,!0);case 129:return this.popNandPushIfOK(e+1,this.vm.image.specialObjectsArray);case 130:return this.primitiveFullGC(e);case 131:return this.primitivePartialGC(e);case 132:return this.popNandPushBoolIfOK(e+1,this.pointsTo(this.stackNonInteger(1),this.vm.top()));case 133:return this.popNIfOK(e);case 134:return this.popNandPushIfOK(e+1,this.registerSemaphore(30));case 135:return this.popNandPushIfOK(e+1,this.millisecondClockValue());case 136:return this.primitiveSignalAtMilliseconds(e);case 137:return this.popNandPushIfOK(e+1,this.secondClock());case 138:return this.popNandPushIfOK(e+1,this.someObject());case 139:return this.popNandPushIfOK(e+1,this.nextObject(this.vm.top()));case 140:return this.primitiveBeep(e);case 141:return this.primitiveClipboardText(e);case 142:return this.popNandPushIfOK(e+1,this.makeStString(this.filenameToSqueak(Squeak.vmPath)));case 143:case 144:return this.primitiveShortAtAndPut(e);case 145:return this.primitiveConstantFill(e);case 146:return this.namedPrimitive("JoystickTabletPlugin","primitiveReadJoystick",e);case 147:return this.namedPrimitive("BitBltPlugin","primitiveWarpBits",e);case 148:return this.popNandPushIfOK(e+1,this.vm.image.clone(this.vm.top()));case 149:return this.primitiveGetAttribute(e);case 150:if(this.oldPrims)return this.primitiveFileAtEnd(e);case 151:if(this.oldPrims)return this.primitiveFileClose(e);case 152:if(this.oldPrims)return this.primitiveFileGetPosition(e);case 153:if(this.oldPrims)return this.primitiveFileOpen(e);case 154:if(this.oldPrims)return this.primitiveFileRead(e);case 155:if(this.oldPrims)return this.primitiveFileSetPosition(e);case 156:if(this.oldPrims)return this.primitiveFileDelete(e);case 157:if(this.oldPrims)return this.primitiveFileSize(e);break;case 158:return this.oldPrims?this.primitiveFileWrite(e):(this.vm.warnOnce("missing primitive: 158 (primitiveCompareWith)"),!1);case 159:return this.oldPrims?this.primitiveFileRename(e):this.popNandPushIntIfOK(e+1,1664525*this.stackSigned53BitInt(0)&268435455);case 160:return this.oldPrims?this.primitiveDirectoryCreate(e):this.primitiveAdoptInstance(e);case 161:return this.oldPrims?this.primitiveDirectoryDelimitor(e):(this.vm.warnOnce("missing primitive: 161 (primitiveSetIdentityHash)"),!1);case 162:if(this.oldPrims)return this.primitiveDirectoryLookup(e);break;case 163:return this.oldPrims?this.primitiveDirectoryDelete(e):(this.vm.warnOnce("missing primitive: 163 (primitiveGetImmutability)"),!1);case 164:return this.popNandPushIfOK(e+1,this.vm.trueObj);case 165:case 166:return this.primitiveIntegerAtAndPut(e);case 167:return!1;case 168:return this.primitiveCopyObject(e);case 169:return this.oldPrims?this.primitiveDirectorySetMacTypeAndCreator(e):this.popNandPushBoolIfOK(e+1,this.vm.stackValue(1)!==this.vm.stackValue(0));case 170:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundStart",e):this.primitiveAsCharacter(e);case 171:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundStartWithSemaphore",e):this.popNandPushIfOK(e+1,this.stackNonInteger(0).hash);case 172:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundStop",e):(this.vm.warnOnce("missing primitive: 172 (primitiveFetchMourner)"),this.popNandPushIfOK(e,this.vm.nilObj));case 173:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundAvailableSpace",e):this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 174:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundPlaySamples",e):this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 175:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundPlaySilence",e):this.vm.image.isSpur?this.popNandPushIfOK(e+1,this.behaviorHash(this.stackNonInteger(0))):(this.vm.warnOnce("primitive 175 called in non-spur image"),this.popNandPushIfOK(e+1,this.identityHash(this.stackNonInteger(0))));case 176:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primWaveTableSoundmixSampleCountintostartingAtpan",e):this.popNandPushIfOK(e+1,this.vm.image.isSpur?4194303:4095);case 177:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primFMSoundmixSampleCountintostartingAtpan",e):this.popNandPushIfOK(e+1,this.allInstancesOf(this.stackNonInteger(0)));case 178:return!!this.oldPrims&&this.namedPrimitive("SoundGenerationPlugin","primPluckedSoundmixSampleCountintostartingAtpan",e);case 179:if(this.oldPrims)return this.namedPrimitive("SoundGenerationPlugin","primSampledSoundmixSampleCountintostartingAtpan",e);break;case 180:return!!this.oldPrims&&this.namedPrimitive("SoundGenerationPlugin","primitiveMixFMSound",e);case 181:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixPluckedSound",e):this.primitiveSizeInBytesOfInstance(e);case 182:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","oldprimSampledSoundmixSampleCountintostartingAtleftVolrightVol",e):this.primitiveSizeInBytes(e);case 183:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveApplyReverb",e):this.primitiveIsPinned(e);case 184:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixLoopedSampledSound",e):this.primitivePin(e);case 185:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixSampledSound",e):this.primitiveExitCriticalSection(e);case 186:if(this.oldPrims)break;return this.primitiveEnterCriticalSection(e);case 187:if(this.oldPrims)break;return this.primitiveTestAndSetOwnershipOfCriticalSection(e);case 188:if(this.oldPrims)break;return this.primitiveExecuteMethodArgsArray(e);case 189:return!!this.oldPrims&&this.namedPrimitive("SoundPlugin","primitiveSoundInsertSamples",e);case 190:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundStartRecording",e);case 191:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundStopRecording",e);case 192:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundGetRecordingSampleRate",e);case 193:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundRecordSamples",e);case 194:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundSetRecordLevel",e);break;case 195:case 196:case 197:case 198:case 199:return!1;case 200:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveInitializeNetwork",e):this.primitiveClosureCopyWithCopiedValues(e);case 201:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverStartNameLookup",e):this.primitiveClosureValue(e);case 202:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverNameLookupResult",e):this.primitiveClosureValue(e);case 203:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverStartAddressLookup",e):this.primitiveClosureValue(e);case 204:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverAddressLookupResult",e):this.primitiveClosureValue(e);case 205:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverAbortLookup",e):this.primitiveClosureValue(e);case 206:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverLocalAddress",e):this.primitiveClosureValueWithArgs(e);case 207:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverStatus",e):this.primitiveFullClosureValue(e);case 208:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverError",e):this.primitiveFullClosureValueWithArgs(e);case 209:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketCreate",e):this.primitiveFullClosureValueNoContextSwitch(e);case 210:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketDestroy",e):this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!1));case 211:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketConnectionStatus",e):this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!1));case 212:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketError",e):this.popNandPushIfOK(e+1,this.objectSize(!1));case 213:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketLocalAddress",e);case 214:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketLocalPort",e);case 215:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketRemoteAddress",e);case 216:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketRemotePort",e);case 217:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketConnectToPort",e);case 218:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketListenWithOrWithoutBacklog",e):this.primitiveDoNamedPrimitive(e);case 219:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketCloseConnection",e);case 220:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketAbortConnection",e);break;case 221:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketReceiveDataBufCount",e):this.primitiveClosureValueNoContextSwitch(e);case 222:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketReceiveDataAvailable",e):this.primitiveClosureValueNoContextSwitch(e);case 223:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketSendDataBufCount",e);case 224:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketSendDone",e);case 225:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketAccept",e);break;case 230:return this.primitiveRelinquishProcessorForMicroseconds(e);case 231:return this.primitiveForceDisplayUpdate(e);case 232:return this.vm.warnOnce("missing primitive: 232 (primitiveFormPrint)"),!1;case 233:return this.primitiveSetFullScreen(e);case 234:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveDecompressFromByteArray",e);case 235:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveCompareString",e);case 236:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveConvert8BitSigned",e);case 237:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveCompressToByteArray",e);break;case 238:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortOpen",e):this.namedPrimitive("FloatArrayPlugin","primitiveAt",e);case 239:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortClose",e):this.namedPrimitive("FloatArrayPlugin","primitiveAtPut",e);case 240:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortWrite",e):this.popNandPushIfOK(e+1,this.microsecondClockUTC());case 241:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortRead",e):this.popNandPushIfOK(e+1,this.microsecondClockLocal());case 242:if(this.oldPrims)break;return this.primitiveSignalAtUTCMicroseconds(e);case 243:return this.oldPrims?this.namedPrimitive("MiscPrimitivePlugin","primitiveTranslateStringWithTable",e):(this.vm.warnOnce("missing primitive: 243 (primitiveUpdateTimeZone)"),!1);case 244:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveFindFirstInString",e);case 245:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveIndexOfAsciiInString",e);case 246:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveFindSubstring",e);break;case 248:return this.primitiveArrayBecome(e,!1,!1);case 249:return this.primitiveArrayBecome(e,!1,!0);case 254:return this.primitiveVMParameter(e);case 521:return this.namedPrimitive("MIDIPlugin","primitiveMIDIClosePort",e);case 522:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetClock",e);case 523:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortCount",e);case 524:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortDirectionality",e);case 525:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortName",e);case 526:return this.namedPrimitive("MIDIPlugin","primitiveMIDIOpenPort",e);case 527:return this.namedPrimitive("MIDIPlugin","primitiveMIDIParameterGetOrSet",e);case 528:return this.namedPrimitive("MIDIPlugin","primitiveMIDIRead",e);case 529:return this.namedPrimitive("MIDIPlugin","primitiveMIDIWrite",e);case 550:return this.namedPrimitive("ADPCMCodecPlugin","primitiveDecodeMono",e);case 551:return this.namedPrimitive("ADPCMCodecPlugin","primitiveDecodeStereo",e);case 552:return this.namedPrimitive("ADPCMCodecPlugin","primitiveEncodeMono",e);case 553:return this.namedPrimitive("ADPCMCodecPlugin","primitiveEncodeStereo",e);case 571:return this.primitiveUnloadModule(e);case 572:return this.primitiveListBuiltinModule(e);case 573:return this.primitiveListLoadedModule(e);case 575:return this.vm.warnOnce("missing primitive: 575 (primitiveHighBit)"),!1;case 576:return this.vm.primitiveInvokeObjectAsMethod(e,s);case 578:return this.vm.warnOnce("missing primitive: 578 (primitiveSuspendAndBackupPC)"),!1}return console.error("primitive "+t+" not implemented yet"),!1},namedPrimitive:function(t,e,s){var i=""===t?this:this.loadedModules[t],r=!1;void 0===i&&(i=this.loadModule(t),this.loadedModules[t]=i,r=!0);var n=!1,a=this.vm.sp;if(i){this.interpreterProxy.argCount=s,this.interpreterProxy.primitiveName=e;var o=i[e];"function"==typeof o?n=i[e](s):"string"==typeof o?n=this[o](s):this.vm.warnOnce("missing primitive: "+t+"."+e)}else r&&(this.success?this.vm.warnOnce("missing module: "+t+" ("+e+")"):this.vm.warnOnce("failed to load module: "+t+" ("+e+")"));return(!0===n||!1!==n&&this.success)&&this.vm.sp!==a-s&&!this.vm.frozen&&this.vm.warnOnce("stack unbalanced after primitive "+t+"."+e,"error"),!0===n||!1===n?n:this.success},doNamedPrimitive:function(t,e){if(!e.primFunction){if(e.pointersSize()<2)return!1;if(4!==(a=e.pointers[1]).pointersSize())return!1;this.primMethod=e;var s=a.pointers[0].bytesAsString(),i=a.pointers[1].bytesAsString();if(e.primFunction=this.loadFunctionFrom(i,s),!e.primFunction)return!1}this.interpreterProxy.argCount=t;var r=this.vm.sp,n=e.primFunction(t);if((!0===n||!1!==n&&this.success)&&this.vm.sp!==r-t&&!this.vm.frozen){var a;s=(a=e.pointers[1]).pointers[0].bytesAsString(),i=a.pointers[1].bytesAsString();this.vm.warnOnce("stack unbalanced after primitive "+s+"."+i,"error")}return!0===n||!1===n?n:this.success},fakePrimitive:function(t,e,s){return this.vm.warnOnce("faking primitive: "+t),void 0===e?this.vm.popN(s):this.vm.popNandPush(s+1,this.makeStObject(e)),!0}},"modules",{loadModule:function(t){var e=Squeak.externalModules[t]||this.builtinModules[t]||this.loadModuleDynamically(t);if(!e)return null;if(this.patchModules[t]&&this.patchModule(e,t),e.setInterpreter&&!e.setInterpreter(this.interpreterProxy))return console.log("Wrong interpreter proxy version: "+t),null;var s=e.initialiseModule;return"function"==typeof s?e.initialiseModule():"string"==typeof s&&this[s](),this.interpreterProxy.failed()?(console.log("Module initialization failed: "+t),null):(e.getModuleName&&(t=e.getModuleName()),console.log("Loaded module: "+t),e)},loadModuleDynamically:function(t){},patchModule:function(t,e){var s=this.patchModules[e];for(var i in s)t[i]=s[i]},unloadModule:function(t){var e=this.loadedModules[t];if(!t||!e||e===this)return null;delete this.loadedModules[t];var s=e.unloadModule;return"function"==typeof s?e.unloadModule(this):"string"==typeof s&&this[s](this),console.log("Unloaded module: "+t),e},loadFunctionFrom:function(t,e){var s=""===e?this:this.loadedModules[e];if(void 0===s&&(s=this.loadModule(e),this.loadedModules[e]=s),!s)return null;var i=s[t];return"function"==typeof i?i.bind(s):"string"==typeof i?this[i].bind(this):(this.vm.warnOnce("missing primitive: "+e+"."+t),null)},primitiveUnloadModule:function(t){var e=this.stackNonInteger(0).bytesAsString();return!!e&&(this.unloadModule(e),this.popNIfOK(t))},primitiveListBuiltinModule:function(t){var e=this.stackInteger(0)-1;if(!this.success)return!1;var s=Object.keys(this.builtinModules);return this.popNandPushIfOK(t+1,this.makeStObject(s[e]))},primitiveListLoadedModule:function(t){var e=this.stackInteger(0)-1;if(!this.success)return!1;var s=[];for(var i in this.loadedModules){var r=this.loadedModules[i];if(r){var n=r.getModuleName?r.getModuleName():i;s.push(n)}}return this.popNandPushIfOK(t+1,this.makeStObject(s[e]))}},"stack access",{popNIfOK:function(t){return!!this.success&&(this.vm.popN(t),!0)},pop2andPushBoolIfOK:function(t){return this.vm.success=this.success,this.vm.pop2AndPushBoolResult(t)},popNandPushBoolIfOK:function(t,e){return!!this.success&&(this.vm.popNandPush(t,e?this.vm.trueObj:this.vm.falseObj),!0)},popNandPushIfOK:function(t,e){return!(!this.success||null==e)&&(this.vm.popNandPush(t,e),!0)},popNandPushIntIfOK:function(t,e){return!(!this.success||!this.vm.canBeSmallInt(e))&&(this.vm.popNandPush(t,e),!0)},popNandPushFloatIfOK:function(t,e){return!!this.success&&(this.vm.popNandPush(t,this.makeFloat(e)),!0)},stackNonInteger:function(t){return this.checkNonInteger(this.vm.stackValue(t))},stackInteger:function(t){return this.checkSmallInt(this.vm.stackValue(t))},stackPos32BitInt:function(t){return this.positive32BitValueOf(this.vm.stackValue(t))},pos32BitIntFor:function(t){if(t>=0&&t<=1073741823)return t;for(var e=this.vm.specialObjects[13],s=this.vm.instantiateClass(e,4),i=s.bytes,r=0;r<4;r++)i[r]=t>>>8*r&255;return s},pos53BitIntFor:function(t){if(t<=4294967295)return this.pos32BitIntFor(t);if(t>9007199254740991)return console.warn("Out of range: pos53BitIntFor("+t+")"),this.success=!1,0;for(var e=t<=0xffffffffff?5:t<=0xffffffffffff?6:7,s=this.vm.specialObjects[13],i=this.vm.instantiateClass(s,e),r=i.bytes,n=0;n<e;n++)r[n]=255&t,t/=256;return i},stackSigned32BitInt:function(t){var e=this.vm.stackValue(t);if("number"==typeof e)return e;if(4!==e.bytesSize())return this.success=!1,0;for(var s=e.bytes,i=0,r=0,n=1;r<4;r++,n*=256)i+=s[r]*n;return this.isA(e,13)&&i<=2147483647?i:this.isA(e,42)&&-i>=-2147483648?-i:(this.success=!1,0)},signed32BitIntegerFor:function(t){if(t>=-1073741824&&t<=1073741823)return t;for(var e=t<0,s=e?-t:t,i=e?42:13,r=this.vm.instantiateClass(this.vm.specialObjects[i],4),n=r.bytes,a=0;a<4;a++)n[a]=s>>>8*a&255;return r},stackFloat:function(t){return this.checkFloat(this.vm.stackValue(t))},stackBoolean:function(t){return this.checkBoolean(this.vm.stackValue(t))},stackSigned53BitInt:function(t){var e=this.vm.stackValue(t);if("number"==typeof e)return e;var s=e.bytesSize();if(s<=7){for(var i=e.bytes,r=0,n=0,a=1;n<s;n++,a*=256)r+=i[n]*a;if(r<=9007199254740991){if(this.isA(e,13))return r;if(this.isA(e,42))return-r}}return this.success=!1,0}},"numbers",{doBitAnd:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t&e):0},doBitOr:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t|e):0},doBitXor:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t^e):0},doBitShift:function(){var t,e=this.stackPos32BitInt(1),s=this.stackInteger(0);if(!this.success)return 0;if(s<0){if(s<-31)return 0;t=e>>>-s}else{if(s>31)return this.success=!1,0;if((t=e<<s)>>>s!==e)return this.success=!1,0}return this.pos32BitIntFor(t)},safeFDiv:function(t,e){return 0===e?(this.success=!1,1):t/e},floatAsSmallInt:function(t){var e=t>=0?Math.floor(t):Math.ceil(t);return this.ensureSmallInt(e)},floatFractionPart:function(t){return-9007199254740991<=t&&t<=9007199254740991?t-Math.floor(t):(this.success=!1,0)},frexp_exponent:function(t){if(0==t)return 0;var e=new DataView(new ArrayBuffer(8));e.setFloat64(0,t);var s=e.getUint32(0)>>>20&2047;return 0===s&&(e.setFloat64(0,t*Math.pow(2,64)),s=(e.getUint32(0)>>>20&2047)-64),s-1022},ldexp:function(t,e){for(var s=Math.min(3,Math.ceil(Math.abs(e)/1023)),i=t,r=0;r<s;r++)i*=Math.pow(2,Math.floor((e+r)/s));return i},primitiveRemLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(this.stackSigned53BitInt(1)%this.stackSigned53BitInt(0)))},primitiveAddLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(this.stackSigned53BitInt(1)+this.stackSigned53BitInt(0)))},primitiveSubtractLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(this.stackSigned53BitInt(1)-this.stackSigned53BitInt(0)))},primitiveLessThanLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)<this.stackSigned53BitInt(0))},primitiveGreaterThanLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)>this.stackSigned53BitInt(0))},primitiveLessOrEqualLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)<=this.stackSigned53BitInt(0))},primitiveGreaterOrEqualLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)>=this.stackSigned53BitInt(0))},primitiveEqualLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)===this.stackSigned53BitInt(0))},primitiveNotEqualLargeIntegers:function(t){return this.popNandPushBoolIfOK(t+1,this.stackSigned53BitInt(1)!==this.stackSigned53BitInt(0))},primitiveMultiplyLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(this.stackSigned53BitInt(1)*this.stackSigned53BitInt(0)))},primitiveDivideLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(this.stackSigned53BitInt(1)/this.stackSigned53BitInt(0)))},primitiveModLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(Math.floor(this.stackSigned53BitInt(1)%this.stackSigned53BitInt(0))))},primitiveDivLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(Math.floor(this.stackSigned53BitInt(1)/this.stackSigned53BitInt(0))))},primitiveQuoLargeIntegers:function(t){return this.popNandPushIfOK(t+1,this.makeStObject(Math.trunc(this.stackSigned53BitInt(1)/this.stackSigned53BitInt(0))))}},"utils",{floatOrInt:function(t){return t.isFloat?t.float:"number"==typeof t?t:0},positive32BitValueOf:function(t){if("number"==typeof t)return t>=0?t:(this.success=!1,0);if(!this.isA(t,13)||4!==t.bytesSize())return this.success=!1,0;for(var e=t.bytes,s=0,i=0,r=1;i<4;i++,r*=256)s+=e[i]*r;return s},checkFloat:function(t){return t.isFloat?t.float:"number"==typeof t?t:(this.success=!1,0)},checkSmallInt:function(t){return"number"==typeof t?t:(this.success=!1,0)},checkNonInteger:function(t){return"number"!=typeof t?t:(this.success=!1,this.vm.nilObj)},checkBoolean:function(t){return!!t.isTrue||!t.isFalse&&(this.success=!1)},indexableSize:function(t){return"number"==typeof t?-1:t.indexableSize(this)},isA:function(t,e){return t.sqClass===this.vm.specialObjects[e]},isKindOf:function(t,e){for(var s=t.sqClass,i="number"==typeof e?this.vm.specialObjects[e]:e;!s.isNil;){if(s===i)return!0;s=s.superclass()}return!1},isAssociation:function(t){if(this.associationClass&&t.sqClass===this.associationClass)return!0;if(!t.pointers||2!==t.pointers.length)return!1;for(var e=this.vm.specialObjects[3].sqClass;e.superclass().classInstSize()>0;)e=e.superclass();var s=this.isKindOf(t,e);return s&&(this.associationClass=t.sqClass),s},ensureSmallInt:function(t){return t===(0|t)&&this.vm.canBeSmallInt(t)?t:(this.success=!1,0)},charFromInt:function(t){var e=this.vm.specialObjects[24].pointers[t];if(e)return e;var s=this.vm.specialObjects[19];return(e=this.vm.instantiateClass(s,0)).pointers[0]=t,e},charFromIntSpur:function(t){return this.vm.image.getCharacter(t)},charToInt:function(t){return t.pointers[0]},charToIntSpur:function(t){return t.hash},makeFloat:function(t){var e=this.vm.specialObjects[9],s=this.vm.instantiateClass(e,2);return s.float=t,s},makeLargeIfNeeded:function(t){return this.vm.canBeSmallInt(t)?t:this.makeLargeInt(t)},makeLargeInt:function(t){if(t<0)throw Error("negative large ints not implemented yet");if(t>4294967295)throw Error("large large ints not implemented yet");return this.pos32BitIntFor(t)},makePointWithXandY:function(t,e){var s=this.vm.specialObjects[12],i=this.vm.instantiateClass(s,0);return i.pointers[0]=t,i.pointers[1]=e,i},makeStArray:function(t,e){for(var s=this.vm.instantiateClass(this.vm.specialObjects[7],t.length),i=0;i<t.length;i++)s.pointers[i]=this.makeStObject(t[i],e);return s},makeStByteArray:function(t){for(var e=this.vm.instantiateClass(this.vm.specialObjects[26],t.length),s=0;s<t.length;s++)e.bytes[s]=255&t[s];return e},makeStString:function(t){for(var e=this.vm.instantiateClass(this.vm.specialObjects[6],t.length),s=0;s<t.length;++s)e.bytes[s]=255&t.charCodeAt(s);return e},makeStStringFromBytes:function(t,e){var s=t.length;e&&(s=t.indexOf(0))<0&&(s=t.length);for(var i=this.vm.instantiateClass(this.vm.specialObjects[6],s),r=0;r<s;++r)i.bytes[r]=t[r];return i},makeStObject:function(t,e){if(null==t)return this.vm.nilObj;if(!0===t)return this.vm.trueObj;if(!1===t)return this.vm.falseObj;if(t.sqClass)return t;if("number"==typeof t)return t===(0|t)?this.makeLargeIfNeeded(t):this.makeFloat(t);if(e){var s=this.vm.instantiateClass(e,0);return s.jsObject=t,s}if("string"==typeof t||"Uint8Array"===t.constructor.name)return this.makeStString(t);if("Array"===t.constructor.name)return this.makeStArray(t);throw Error("cannot make smalltalk object")},pointsTo:function(t,e){return!!t.pointers&&t.pointers.indexOf(e)>=0},asUint8Array:function(t){if("Uint8Array"===t.constructor.name)return t;if("ArrayBuffer"===t.constructor.name)return new Uint8Array(t);if("string"==typeof t){for(var e=new Uint8Array(t.length),s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}throw Error("unknown buffer type")},filenameToSqueak:function(t){var e="/SqueakJS"+("/"!==t[0]?"/":"")+t;return this.emulateMac&&(e=("Macintosh HD"+e).replace(/\//g,"€").replace(/:/g,"/").replace(/€/g,":")),e},filenameFromSqueak:function(t){var e=this.emulateMac?t.replace(/^[^:]*:/,":").replace(/\//g,"€").replace(/:/g,"/").replace(/€/g,":"):t;return e=e.replace(/^\/*SqueakJS\/?/,"/")}},"indexing",{objectAt:function(t,e,s){var i,r=this.stackNonInteger(1),n=this.stackPos32BitInt(0);if(!this.success)return r;if(t){if((i=this.atCache[r.hash&this.atCacheMask]).array!==r)return this.success=!1,r}else{if(r.isFloat){var a=r.floatData();return 1==n?this.pos32BitIntFor(a.getUint32(0,!1)):2==n?this.pos32BitIntFor(a.getUint32(4,!1)):(this.success=!1,r)}i=this.makeAtCacheInfo(this.atCache,this.vm.specialSelectors[32],r,e,s)}if(n<1||n>i.size)return this.success=!1,r;if(s)return r.pointers[n-1];if(r.isPointers())return r.pointers[n-1+i.ivarOffset];if(r.isWords())return i.convertChars?this.charFromInt(1073741823&r.words[n-1]):this.pos32BitIntFor(r.words[n-1]);if(r.isBytes())return i.convertChars?this.charFromInt(255&r.bytes[n-1]):255&r.bytes[n-1];var o=4*r.pointersSize();return n-1-o<0?(this.success=!1,r):255&r.bytes[n-1-o]},objectAtPut:function(t,e,s){var i,r=this.stackNonInteger(2),n=this.stackPos32BitInt(1);if(!this.success)return r;if(t){if((i=this.atPutCache[r.hash&this.atCacheMask]).array!==r)return this.success=!1,r}else{if(r.isFloat){var a=this.stackPos32BitInt(0);if(!this.success||1!=n&&2!=n)this.success=!1;else{var o=r.floatData();o.setUint32(1==n?0:4,a,!1),r.float=o.getFloat64(0)}return this.vm.stackValue(0)}i=this.makeAtCacheInfo(this.atPutCache,this.vm.specialSelectors[34],r,e,s)}if(n<1||n>i.size)return this.success=!1,r;var c,h=this.vm.stackValue(0);if(s)return r.dirty=!0,r.pointers[n-1]=h;if(r.isPointers())return r.dirty=!0,r.pointers[n-1+i.ivarOffset]=h;if(r.isWords()){if(e){if(h.sqClass!==this.vm.specialObjects[19])return this.success=!1,h;if("number"!=typeof(c=this.charToInt(h)))return this.success=!1,h}else c=this.stackPos32BitInt(0);return this.success&&(r.words[n-1]=c),h}if(e){if(h.sqClass!==this.vm.specialObjects[19])return this.success=!1,h;if("number"!=typeof(c=this.charToInt(h)))return this.success=!1,h}else{if("number"!=typeof h)return this.success=!1,h;c=h}if(c<0||c>255)return this.success=!1,h;if(r.isBytes())return r.bytes[n-1]=c,h;var u=4*r.pointersSize();return n-1-u<0?(this.success=!1,r):(r.bytes[n-1-u]=c,h)},objectSize:function(t){var e=this.vm.stackValue(0),s=-1;return t?e.sqClass===this.vm.specialObjects[7]?s=e.pointersSize():e.sqClass===this.vm.specialObjects[6]&&(s=e.bytesSize()):s=this.indexableSize(e),-1===s?(this.success=!1,-1):this.pos32BitIntFor(s)},initAtCache:function(){this.atCacheSize=32,this.atCacheMask=this.atCacheSize-1,this.atCache=[],this.atPutCache=[],this.nonCachedInfo={};for(var t=0;t<this.atCacheSize;t++)this.atCache.push({}),this.atPutCache.push({})},makeAtCacheInfo:function(t,e,s,i,r){var n;return(n=this.vm.verifyAtSelector===e&&this.vm.verifyAtClass===s.sqClass&&!this.vm.isContext(s)?t[s.hash&this.atCacheMask]:this.nonCachedInfo).array=s,n.convertChars=i,r?(n.size=s.instSize()+Math.max(0,s.indexableSize(this)),n.ivarOffset=0):(n.size=s.indexableSize(this),n.ivarOffset=s.isPointers()?s.instSize():0),n}},"basic",{instantiateClass:function(t,e){return 4*e>this.vm.image.bytesLeft()?(console.warn("squeak: out of memory, failing allocation"),this.success=!1,this.vm.primFailCode=9,null):this.vm.instantiateClass(t,e)},someObject:function(){return this.vm.image.firstOldObject},nextObject:function(t){return this.vm.image.objectAfter(t)||0},someInstanceOf:function(t){var e=this.vm.image.someInstanceOf(t);return e||(this.success=!1,0)},nextInstanceAfter:function(t){var e=this.vm.image.nextInstanceAfter(t);return e||(this.success=!1,0)},allInstancesOf:function(t){var e=this.vm.image.allInstancesOf(t),s=this.vm.instantiateClass(this.vm.specialObjects[7],e.length);return s.pointers=e,s},identityHash:function(t){return t.hash},identityHashSpur:function(t){var e=t.hash;return e>0?e:t.hash=this.newObjectHash()},behaviorHash:function(t){var e=t.hash;return e>0?e:this.vm.image.enterIntoClassTable(t)},newObjectHash:function(t){return Math.floor(4194302*Math.random())+1},primitivePin:function(t){var e=this.stackNonInteger(1),s=this.stackBoolean(0);if(!this.success)return!1;var i=e.pinned;return e.pinned=s,this.popNandPushIfOK(t+1,this.makeStObject(!!i))},primitiveIsPinned:function(t){var e=this.stackNonInteger(0);return!!this.success&&this.popNandPushIfOK(t+1,this.makeStObject(!!e.pinned))},primitiveSizeInBytesOfInstance:function(t){if(t>1)return!1;var e=this.stackNonInteger(t),s=t?this.stackInteger(0):0,i=e.classByteSizeOfInstance(s);return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(i))},primitiveSizeInBytes:function(t){var e=this.stackNonInteger(0).totalBytes();return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(e))},primitiveAsCharacter:function(t){var e=this.stackInteger(0);if(e<0||e>1073741823)return!1;var s=this.charFromInt(e);return!!s&&this.popNandPushIfOK(t+1,s)},primitiveFullGC:function(t){this.vm.image.fullGC("primitive");var e=this.vm.image.bytesLeft();return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(e))},primitivePartialGC:function(t){for(var e=this.vm.image.partialGC("primitive"),s=0;e;)s+=e.totalBytes(),e=e.nextObject;console.log("    old space: "+this.vm.image.oldSpaceBytes.toLocaleString()+" bytes, young space: "+s.toLocaleString()+" bytes, total: "+(this.vm.image.oldSpaceBytes+s).toLocaleString()+" bytes");var i=this.vm.image.bytesLeft()-s;return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(i))},primitiveMakePoint:function(t,e){var s=this.vm.stackValue(1),i=this.vm.stackValue(0);return!(e&&(this.checkFloat(s),this.checkFloat(i),!this.success))&&(this.vm.popNandPush(1+t,this.makePointWithXandY(s,i)),!0)},primitiveStoreStackp:function(t){var e=this.stackNonInteger(1),s=this.stackInteger(0);if(!this.success||s<0||this.vm.decodeSqueakSP(s)>=e.pointers.length)return!1;for(var i=e.pointers[2];i<s;)e.pointers[this.vm.decodeSqueakSP(++i)]=this.vm.nilObj;return e.pointers[2]=s,this.vm.popN(t),!0},primitiveChangeClass:function(t){if(t>2)return!1;var e=this.stackNonInteger(1),s=this.stackNonInteger(0);return!!this.changeClassTo(e,s.sqClass)&&this.popNIfOK(t)},primitiveAdoptInstance:function(t){if(t>2)return!1;var e=this.stackNonInteger(1),s=this.stackNonInteger(0);return!!this.changeClassTo(s,e)&&this.popNIfOK(t)},changeClassTo:function(t,e){if(t.sqClass.isCompact!==e.isCompact)return!1;var s=e.classInstIsPointers();if(t.isPointers()){if(!s)return!1;if(t.sqClass.classInstSize()!==e.classInstSize())return!1}else{if(s)return!1;var i=t.isBytes(),r=e.classInstIsBytes();if(i&&!r){if(t.bytes){if(3&t.bytes.length)return!1;t.words=new Uint32Array(t.bytes.buffer),delete t.bytes}}else!i&&r&&t.words&&(t.bytes=new Uint8Array(t.words.buffer),delete t.words)}return t._format=e.classInstFormat(),t.sqClass=e,!0},primitiveDoPrimitiveWithArgs:function(t){var e=this.stackNonInteger(0),s=this.stackInteger(1);if(!this.success)return!1;var i=e.pointersSize(),r=this.vm.activeContext.pointersSize();if(this.vm.sp+i>=r)return!1;this.vm.popN(2);for(var n=0;n<i;n++)this.vm.push(e.pointers[n]);return!!this.vm.tryPrimitive(s,i)||(this.vm.popN(i),this.vm.push(s),this.vm.push(e),!1)},primitiveDoNamedPrimitive:function(t){var e=this.stackNonInteger(0),s=this.stackNonInteger(1),i=this.stackNonInteger(2);if(!this.success)return!1;var r=e.pointersSize(),n=this.vm.activeContext.pointersSize();if(this.vm.sp+r>=n)return!1;this.vm.popN(3),this.vm.push(s);for(var a=0;a<r;a++)this.vm.push(e.pointers[a]);return!!this.doNamedPrimitive(r,i)||(this.vm.popN(r+1),this.vm.push(i),this.vm.push(s),this.vm.push(e),!1)},primitiveShortAtAndPut:function(t){var e,s=this.stackNonInteger(t),i=this.stackInteger(t-1)-1,r=s.wordsAsInt16Array();if(!this.success||!r||i<0||i>=r.length)return!1;if(t<2)e=r[i];else{if((e=this.stackInteger(0))<-32768||e>32767)return!1;r[i]=e}return this.popNandPushIfOK(t+1,e),!0},primitiveIntegerAtAndPut:function(t){var e,s=this.stackNonInteger(t),i=this.stackInteger(t-1)-1,r=s.wordsAsInt32Array();if(!this.success||!r||i<0||i>=r.length)return!1;if(t<2)e=this.signed32BitIntegerFor(r[i]);else{if(e=this.stackSigned32BitInt(0),!this.success)return!1;r[i]=e}return this.popNandPushIfOK(t+1,e),!0},primitiveConstantFill:function(t){var e=this.stackNonInteger(1),s=this.stackPos32BitInt(0);if(!this.success||!e.isWordsOrBytes())return!1;var i=e.words||e.bytes;if(i){if(i===e.bytes&&s>255)return!1;for(var r=0;r<i.length;r++)i[r]=s}return this.vm.popN(t),!0},primitiveNewMethod:function(t){var e=this.stackInteger(0),s=this.stackInteger(1);if(!this.success)return 0;var i=this.vm.instantiateClass(this.vm.stackValue(2),s);i.pointers=[e];for(var r=i.methodNumLits(),n=0;n<r;n++)i.pointers.push(this.vm.nilObj);return this.vm.popNandPush(1+t,i),this.vm.breakOnNewMethod&&(this.vm.breakOnMethod=i),!0},primitiveExecuteMethodArgsArray:function(t){var e=this.stackNonInteger(0),s=this.stackNonInteger(1),i=this.vm.stackValue(2);if(!this.success||!e.isMethod()||t>4)return!1;var r=e.methodNumArgs();if(r!==s.pointersSize())return!1;this.vm.popNandPush(t+1,i);for(var n=0;n<r;n++)this.vm.push(s.pointers[n]);return this.vm.executeNewMethod(i,e,r,e.methodPrimitiveIndex(),null,null),!0},primitiveArrayBecome:function(t,e,s){var i=this.stackNonInteger(t),r=this.stackNonInteger(t-1);return t>1&&(s=this.stackBoolean(t-2)),!!this.success&&(this.success=this.vm.image.bulkBecome(i.pointers,r.pointers,e,s),this.popNIfOK(t))},doStringReplace:function(){var t=this.stackNonInteger(4),e=this.stackInteger(3)-1,s=this.stackInteger(2)-e,i=this.stackNonInteger(1),r=this.stackInteger(0)-1;if(!this.success)return t;if(!i.sameFormatAs(t))return this.success=!1,t;if(i.isPointers()){var n=i.pointersSize();if((r+=i.instSize())<0||r+s>n)return this.success=!1,t;if(n=t.pointersSize(),(e+=t.instSize())<0||e+s>n)return this.success=!1,t;for(var a=0;a<s;a++)t.pointers[e+a]=i.pointers[r+a];return t}if(i.isWords()){n=i.wordsSize();if(r<0||r+s>n)return this.success=!1,t;if(n=t.wordsSize(),e<0||e+s>n)return this.success=!1,t;if(i.isFloat&&t.isFloat)t.float=i.float;else if(i.isFloat)t.wordsAsFloat64Array()[e]=i.float;else if(t.isFloat)t.float=i.wordsAsFloat64Array()[r];else for(a=0;a<s;a++)t.words[e+a]=i.words[r+a];return t}n=i.bytesSize();if(r<0||r+s>n)return this.success=!1,t;if(n=t.bytesSize(),e<0||e+s>n)return this.success=!1,t;for(a=0;a<s;a++)t.bytes[e+a]=i.bytes[r+a];return t},primitiveCopyObject:function(t){var e=this.stackNonInteger(1),s=this.stackNonInteger(0),i=e.pointersSize();if(!this.success||e.isWordsOrBytes()||e.sqClass!==s.sqClass||i!==s.pointersSize())return!1;for(var r=0;r<i;r++)e.pointers[r]=s.pointers[r];return e.dirty=s.dirty,this.vm.popN(t),!0},primitiveStoreImageSegment:function(t){var e=this.stackNonInteger(2),s=this.stackNonInteger(1),i=this.stackNonInteger(0);return!!(e.pointers&&s.words&&i.pointers)&&(!!this.vm.image.storeImageSegment(s,i,e)&&(this.vm.popN(t),!0))},primitiveLoadImageSegment:function(t){var e=this.stackNonInteger(1),s=this.stackNonInteger(0);if(!e.words||!s.pointers)return!1;var i=this.vm.image.loadImageSegment(e,s);return!!i&&this.popNandPushIfOK(t+1,i)}},"blocks/closures",{doBlockCopy:function(){var t=this.vm.stackValue(1),e=this.stackInteger(0),s=t;if(this.vm.isContext(s)||(this.success=!1),!this.success)return t;"number"==typeof s.pointers[3]&&(s=s.pointers[5]);var i=s.pointersSize()-s.instSize(),r=this.vm.instantiateClass(this.vm.specialObjects[11],i),n=this.vm.encodeSqueakPC(this.vm.pc+2,this.vm.method);return r.pointers[4]=n,r.pointers[1]=n,r.pointers[2]=0,r.pointers[3]=e,r.pointers[5]=s,r.pointers[0]=this.vm.nilObj,r},primitiveBlockValue:function(t){var e=this.vm.stackValue(t);if(!this.isA(e,11))return!1;var s=e,i=s.pointers[3];if("number"!=typeof i)return!1;if(i!=t)return!1;if(!s.pointers[0].isNil)return!1;this.vm.arrayCopy(this.vm.activeContext.pointers,this.vm.sp-t+1,s.pointers,6,t);var r=s.pointers[4];return s.pointers[1]=r,s.pointers[2]=t,s.pointers[0]=this.vm.activeContext,this.vm.popN(t+1),this.vm.newActiveContext(s),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0},primitiveBlockValueWithArgs:function(t){var e=this.vm.stackValue(1),s=this.vm.stackValue(0);if(!this.isA(e,11))return!1;if(!this.isA(s,7))return!1;var i=e.pointers[3];if("number"!=typeof i)return!1;if(i!=s.pointersSize())return!1;if(!e.pointers[0].isNil)return!1;this.vm.arrayCopy(s.pointers,0,e.pointers,6,i);var r=e.pointers[4];return e.pointers[1]=r,e.pointers[2]=i,e.pointers[0]=this.vm.activeContext,this.vm.popN(t+1),this.vm.newActiveContext(e),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0},primitiveClosureCopyWithCopiedValues:function(t){this.vm.breakNow("primitiveClosureCopyWithCopiedValues");debugger;return!1},primitiveClosureValue:function(t){var e=this.vm.stackValue(t);return t===e.pointers[2]&&(this.activateNewClosureMethod(e,t),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0)},primitiveClosureValueWithArgs:function(t){var e=this.vm.top(),s=e.pointersSize(),i=this.vm.stackValue(t);if(s!==i.pointers[2])return!1;this.vm.pop();for(var r=0;r<s;r++)this.vm.push(e.pointers[r]);return this.activateNewClosureMethod(i,s),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0},primitiveClosureValueNoContextSwitch:function(t){var e=this.vm.stackValue(t);return t===e.pointers[2]&&(this.activateNewClosureMethod(e,t),!0)},primitiveFullClosureValue:function(t){var e=this.vm.stackValue(t);return t===e.pointers[2]&&(this.activateNewFullClosure(e,t),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0)},primitiveFullClosureValueWithArgs:function(t){var e=this.vm.top(),s=e.pointersSize(),i=this.vm.stackValue(t);if(s!==i.pointers[2])return!1;this.vm.pop();for(var r=0;r<s;r++)this.vm.push(e.pointers[r]);return this.activateNewFullClosure(i,s),this.vm.interruptCheckCounter--<=0&&this.vm.checkForInterrupts(),!0},primitiveFullClosureValueNoContextSwitch:function(t){var e=this.vm.stackValue(t);return t===e.pointers[2]&&(this.activateNewFullClosure(e,t),!0)},activateNewClosureMethod:function(t,e){var s=t.pointers[0],i=s.pointers[3],r=this.vm.allocateOrRecycleContext(i.methodNeedsLargeFrame()),n=t.pointers.length-3;r.pointers[0]=this.vm.activeContext,r.pointers[1]=t.pointers[1],r.pointers[2]=e+n,r.pointers[3]=s.pointers[3],r.pointers[4]=t,r.pointers[5]=s.pointers[5];for(var a=6,o=0;o<e;o++)r.pointers[a++]=this.vm.stackValue(e-o-1);for(o=0;o<n;o++)r.pointers[a++]=t.pointers[3+o];this.vm.popN(e+1),this.vm.newActiveContext(r)},activateNewFullClosure:function(t,e){var s=t.pointers[1],i=this.vm.allocateOrRecycleContext(s.methodNeedsLargeFrame()),r=t.pointers.length-4;i.pointers[0]=this.vm.activeContext,i.pointers[1]=this.vm.encodeSqueakPC(0,s),i.pointers[2]=s.methodTempCount(),i.pointers[3]=s,i.pointers[4]=t,i.pointers[5]=t.pointers[3];for(var n=6,a=0;a<e;a++)i.pointers[n++]=this.vm.stackValue(e-a-1);for(a=0;a<r;a++)i.pointers[n++]=t.pointers[4+a];this.vm.popN(e+1),this.vm.newActiveContext(i),s.compiled||this.vm.compileIfPossible(s)}},"scheduling",{primitiveResume:function(){return this.resume(this.vm.top()),!0},primitiveSuspend:function(){var t=this.vm.top();if(t===this.activeProcess())this.vm.popNandPush(1,this.vm.nilObj),this.transferTo(this.wakeHighestPriority());else{var e=t.pointers[3];if(e.isNil)return!1;if(this.removeProcessFromList(t,e),!this.success)return!1;t.pointers[3]=this.vm.nilObj,this.vm.popNandPush(1,e)}return!0},getScheduler:function(){return this.vm.specialObjects[3].pointers[1]},activeProcess:function(){return this.getScheduler().pointers[1]},resume:function(t){var e=this.activeProcess(),s=e.pointers[2];t.pointers[2]>s?(this.putToSleep(e),this.transferTo(t)):this.putToSleep(t)},putToSleep:function(t){var e=t.pointers[2],s=this.getScheduler().pointers[0].pointers[e-1];this.linkProcessToList(t,s)},transferTo:function(t){var e=this.getScheduler(),s=e.pointers[1];e.pointers[1]=t,e.dirty=!0,s.pointers[1]=this.vm.activeContext,s.dirty=!0,this.vm.newActiveContext(t.pointers[1]),t.pointers[1]=this.vm.nilObj,this.oldPrims||(t.pointers[3]=this.vm.nilObj),this.vm.reclaimableContextCount=0,this.vm.breakOnContextChanged&&(this.vm.breakOnContextChanged=!1,this.vm.breakNow()),this.vm.logProcess&&console.log("\n============= Process Switch ==================\n"+this.vm.printProcess(t,!0,this.vm.logSends?"| ":"")+"===============================================")},wakeHighestPriority:function(){var t,e=this.getScheduler().pointers[0],s=e.pointersSize()-1;do{if(s<0)throw Error("scheduler could not find a runnable process");t=e.pointers[s--]}while(this.isEmptyList(t));return this.removeFirstLinkOfList(t)},linkProcessToList:function(t,e){if(this.isEmptyList(e))e.pointers[0]=t;else{var s=e.pointers[1];s.pointers[0]=t,s.dirty=!0}e.pointers[1]=t,e.dirty=!0,t.pointers[3]=e,t.dirty=!0},isEmptyList:function(t){return t.pointers[0].isNil},removeFirstLinkOfList:function(t){var e=t.pointers[0];if(e===t.pointers[1])t.pointers[0]=this.vm.nilObj,t.pointers[1]=this.vm.nilObj;else{var s=e.pointers[0];t.pointers[0]=s,t.dirty=!0}return e.pointers[0]=this.vm.nilObj,e},removeProcessFromList:function(t,e){var s=e.pointers[0],i=e.pointers[1];if(t===s){var r=t.pointers[0];e.pointers[0]=r,t===i&&(e.pointers[1]=this.vm.nilObj)}else{for(var n=s;;){if(n.isNil)return void(this.oldPrims&&(this.success=!1));if((r=n.pointers[0])===t)break;n=r}r=t.pointers[0],n.pointers[0]=r,t===i&&(e.pointers[1]=n)}t.pointers[0]=this.vm.nilObj},registerSemaphore:function(t){var e=this.vm.top();return this.isA(e,18)?this.vm.specialObjects[t]=e:this.vm.specialObjects[t]=this.vm.nilObj,this.vm.stackValue(1)},primitiveWait:function(){var t=this.vm.top();if(!this.isA(t,18))return!1;var e=t.pointers[2];return e>0?t.pointers[2]=e-1:(this.linkProcessToList(this.activeProcess(),t),this.transferTo(this.wakeHighestPriority())),!0},primitiveSignal:function(){var t=this.vm.top();return!!this.isA(t,18)&&(this.synchronousSignal(t),!0)},synchronousSignal:function(t){this.isEmptyList(t)?t.pointers[2]++:this.resume(this.removeFirstLinkOfList(t))},signalAtMilliseconds:function(t,e){this.isA(t,18)?(this.vm.specialObjects[29]=t,this.vm.nextWakeupTick=e):(this.vm.specialObjects[29]=this.vm.nilObj,this.vm.nextWakeupTick=0)},primitiveSignalAtMilliseconds:function(t){var e=this.stackInteger(0),s=this.stackNonInteger(1);return!!this.success&&(this.signalAtMilliseconds(s,e),this.vm.popN(t),!0)},primitiveSignalAtUTCMicroseconds:function(t){var e=this.stackSigned53BitInt(0),s=this.stackNonInteger(1);if(!this.success)return!1;var i=e/1e3+Squeak.EpochUTC-this.vm.startupTime&536870911;return this.signalAtMilliseconds(s,i),this.vm.popN(t),!0},signalSemaphoreWithIndex:function(t){this.semaphoresToSignal.push(t)},signalExternalSemaphores:function(){for(var t=this.vm.specialObjects[38].pointers,e=this.vm.specialObjects[18];this.semaphoresToSignal.length;){var s=t[this.semaphoresToSignal.shift()-1];s.sqClass==e&&this.synchronousSignal(s)}},primitiveEnterCriticalSection:function(t){if(t>1)return!1;var e=this.vm.stackValue(t),s=t?this.vm.top():this.activeProcess(),i=e.pointers[2];return i.isNil?(e.pointers[2]=s,e.dirty=!0,this.popNandPushIfOK(t+1,this.vm.falseObj)):i===s?this.popNandPushIfOK(t+1,this.vm.trueObj):(this.popNandPushIfOK(t+1,this.vm.falseObj),this.linkProcessToList(s,e),this.transferTo(this.wakeHighestPriority())),!0},primitiveExitCriticalSection:function(t){var e=this.vm.top();if(this.isEmptyList(e))e.pointers[2]=this.vm.nilObj;else{var s=this.removeFirstLinkOfList(e);e.pointers[2]=s,e.dirty=!0,this.resume(s)}return!0},primitiveTestAndSetOwnershipOfCriticalSection:function(t){if(t>1)return!1;var e=this.vm.stackValue(t),s=t?this.vm.top():this.activeProcess(),i=e.pointers[2];return i.isNil?(e.pointers[2]=s,e.dirty=!0,this.popNandPushIfOK(t+1,this.vm.falseObj)):i===s?this.popNandPushIfOK(t+1,this.vm.trueObj):this.popNandPushIfOK(t+1,this.vm.nilObj),!0}},"vm functions",{primitiveGetAttribute:function(t){var e=this.stackInteger(0);if(!this.success)return!1;var s=this.display.argv,i=this.display.vmOptions,r=null;switch(e){case 0:r=s&&s[0]||this.filenameToSqueak(Squeak.vmPath+Squeak.vmFile);break;case 1:r=s&&s[1]||this.display.documentName;break;case 2:r=s&&s[2]||this.display.documentName;break;case 1001:r=this.vm.options.unix?"unix":Squeak.platformName;break;case 1002:r=Squeak.osVersion;break;case 1003:r=Squeak.platformSubtype;break;case 1004:r=Squeak.vmVersion+" "+Squeak.vmMakerVersion;break;case 1005:r=Squeak.windowSystem;break;case 1006:r=Squeak.vmBuild;break;case 1007:r=Squeak.vmInterpreterVersion;break;case 1009:r=Squeak.vmVersion+" Date: "+Squeak.vmDate;break;default:if(e>=0&&s&&s.length>e)r=s[e];else{if(!(e<0&&i&&i.length>-e-1))return!1;r=i[-e-1]}}return this.vm.popNandPush(t+1,this.makeStObject(r)),!0},setLowSpaceThreshold:function(){var t=this.stackInteger(0);return this.success&&(this.vm.lowSpaceThreshold=t),this.vm.stackValue(1)},primitiveVMParameter:function(t){var e=this.vm.image.isSpur?71:44;switch(t){case 0:for(var s=this.vm.instantiateClass(this.vm.specialObjects[7],e),i=0;i<e;i++)s.pointers[i]=this.makeStObject(this.vmParameterAt(i+1));return this.popNandPushIfOK(1,s);case 1:var r=this.stackInteger(0);return!(r<1||r>e)&&this.popNandPushIfOK(2,this.makeStObject(this.vmParameterAt(r)));case 2:return this.popNandPushIfOK(3,0)}return!1},vmParameterAt:function(t){switch(t){case 1:case 2:return this.vm.image.oldSpaceBytes;case 3:case 67:return this.vm.image.totalMemory;case 4:return this.vm.image.allocationCount+this.vm.image.newSpaceCount;case 7:return this.vm.image.gcCount;case 8:return this.vm.image.gcMilliseconds;case 9:return this.vm.image.pgcCount;case 10:return this.vm.image.pgcMilliseconds;case 11:return this.vm.image.gcTenured;case 15:case 16:case 17:case 18:case 19:case 20:case 22:case 44:case 46:case 48:case 65:return 0;case 23:return this.vm.image.extraVMMemory;case 40:return 4;case 41:return this.vm.image.formatVersion();case 54:return this.vm.image.bytesLeft()}return null},primitiveImageName:function(t){return 0==t?this.popNandPushIfOK(1,this.makeStString(this.filenameToSqueak(this.vm.image.name))):(this.vm.image.name=this.filenameFromSqueak(this.vm.top().bytesAsString()),Squeak.Settings.squeakImageName=this.vm.image.name,this.vm.popN(t),!0)},primitiveSnapshot:function(t){this.vm.popNandPush(1,this.vm.trueObj),this.vm.storeContextRegisters(),this.activeProcess().pointers[1]=this.vm.activeContext,this.vm.image.fullGC("snapshot");var e=this.vm.image.writeToBuffer();return Squeak.flushAllFiles&&(Squeak.flushAllFiles(),Squeak.filePut(this.vm.image.name,e)),this.vm.popNandPush(1,this.vm.falseObj),!0},primitiveQuit:function(t){return Squeak.flushAllFiles&&Squeak.flushAllFiles(),this.display.quitFlag=!0,this.vm.breakNow("quit"),!0},primitiveExitToDebugger:function(t){this.vm.breakNow("debugger primitive");debugger;return!0},primitiveSetGCBiasToGrow:function(t){return this.fakePrimitive(".primitiveSetGCBiasToGrow",0,t)},primitiveSetGCBiasToGrowGCLimit:function(t){return this.fakePrimitive(".primitiveSetGCBiasToGrowGCLimit",0,t)}},"time",{primitiveRelinquishProcessorForMicroseconds:function(t){return this.vm.popN(t),this.vm.goIdle(),!0},millisecondClockValue:function(){return Date.now()-this.vm.startupTime&536870911},millisecondClockValueSet:function(t){this.vm.startupTime=Date.now()-t},secondClock:function(){return this.pos32BitIntFor(Squeak.totalSeconds())},microsecondClock:function(t){var e=Date.now()-t.epoch;if("object"!=typeof performance)return this.pos53BitIntFor(1e3*e);var s=1e3*performance.now()%1e3|0,i=t.millis,r=t.micros;return i>e&&(e=i),e===i&&s<r&&e++,t.millis=e,t.micros=s,this.pos53BitIntFor(1e3*e+s)},microsecondClockUTC:function(){return this.microsecondClockUTCState||(this.microsecondClockUTCState={epoch:Squeak.EpochUTC,millis:0,micros:0}),this.microsecondClock(this.microsecondClockUTCState)},microsecondClockLocal:function(){return this.microsecondClockLocalState||(this.microsecondClockLocalState={epoch:Squeak.Epoch,millis:0,micros:0}),this.microsecondClock(this.microsecondClockLocalState)},primitiveUtcWithOffset:function(t){var e=new Date,s=this.pos53BitIntFor(1e3*e.getTime()),i=-60*e.getTimezoneOffset();if(t>0){var r=this.vm.stackValue(0);return r.pointers[0]=s,r.pointers[1]=i,this.popNandPushIfOK(t+1,r),!0}var n=[s,i];return this.popNandPushIfOK(t+1,this.makeStArray(n)),!0}}),Object.subclass("Squeak.Compiler","initialization",{initialize:function(t){this.vm=t,this.comments=!!Squeak.Compiler.comments,this.specialSelectors=["+","-","<",">","<=",">=","=","~=","*","/","\\\\","@","bitShift:","//","bitAnd:","bitOr:","at:","at:put:","size","next","nextPut:","atEnd","==","class","blockCopy:","value","value:","do:","new","new:","x","y"],this.doitCounter=0,this.blockCounter=0}},"accessing",{compile:function(t,e,s){if(void 0===t.compiled)t.compiled=!1;else{var i,r,n;if(this.singleStep=!1,this.debug=this.comments,this.debug&&!e){var a=t.sqClass===this.vm.specialObjects[16];this.vm.allMethodsDo((function(i,r,n){if(a?r===t:r.pointers.includes(t))return e=i,s=n,!0}))}if(e)if(i=e.className(),r=s.bytesAsString(),this.debug)(a=t.sqClass===this.vm.specialObjects[16])||(i="[] in "+i),n=e.allInstVarNames();t.compiled=this.generate(t,i,r,n)}},enableSingleStepping:function(t,e,s){if(!t.compiled||!t.compiled.canSingleStep){this.singleStep=!0,this.debug=!0,e||this.vm.allMethodsDo((function(i,r,n){if(r===t)return e=i,s=n,!0}));var i=e&&e.className(),r=s&&s.bytesAsString(),n=e&&e.allInstVarNames();t.compiled=this.generate(t,i,r,n),t.compiled.canSingleStep=!0}return!0},functionNameFor:function(t,e){return void 0===t||"?"===t?this.method.sqClass===this.vm.specialObjects[16]?"DOIT_"+ ++this.doitCounter:"BLOCK_"+ ++this.blockCounter:(t=t.replace(/ /g,"_").replace("[]","Block"),/[^a-zA-Z0-9:_]/.test(e)?t+"__"+e.replace(/./g,(function(t){return{"|":"OR","~":"NOT","<":"LT","=":"EQ",">":"GT","&":"AND","@":"AT","*":"TIMES","+":"PLUS","\\":"MOD","-":"MINUS",",":"COMMA","/":"DIV","?":"IF"}[t]||"OPERATOR"}))+"__":t+"_"+e.replace(/:/g,"ː"))}},"generating",{generate:function(t,e,s,i){this.method=t,this.sista=t.methodSignFlag(),this.pc=0,this.endPC=0,this.prevPC=0,this.source=[],this.sourceLabels={},this.needsLabel={},this.sourcePos={},this.needsVar={},this.needsBreak=!1,e&&s&&this.source.push("// ",e,">>",s,"\n"),this.instVarNames=i,this.allVars=["context","stack","rcvr","inst[","temp[","lit["],this.sourcePos.context=this.source.length,this.source.push("var context = vm.activeContext;\n"),this.sourcePos.stack=this.source.length,this.source.push("var stack = context.pointers;\n"),this.sourcePos.rcvr=this.source.length,this.source.push("var rcvr = vm.receiver;\n"),this.sourcePos["inst["]=this.source.length,this.source.push("var inst = rcvr.pointers;\n"),this.sourcePos["temp["]=this.source.length,this.source.push("var temp = vm.homeContext.pointers;\n"),this.sourcePos["lit["]=this.source.length,this.source.push("var lit = vm.method.pointers;\n"),this.sourcePos["loop-start"]=this.source.length,this.source.push("while (true) switch (vm.pc) {\ncase 0:\n"),this.sista?this.generateSista(t):this.generateV3(t);var r=this.functionNameFor(e,s);this.singleStep?(this.debug&&this.source.push("// all valid PCs have a label;\n"),this.source.push("default: throw Error('invalid PC');\n}")):(this.sourcePos["loop-end"]=this.source.length,this.source.push("default: vm.interpretOne(true); return;\n}"),this.deleteUnneededLabels()),this.deleteUnneededVariables();var n="'use strict';\nreturn function "+r+"(vm) {\n"+this.source.join("")+"}";return new Function(n)()},generateV3:function(t){for(this.done=!1;!this.done;){var e=t.bytes[this.pc++],s=0;switch(248&e){case 0:case 8:this.generatePush("inst[",15&e,"]");break;case 16:case 24:this.generatePush("temp[",6+(15&e),"]");break;case 32:case 40:case 48:case 56:this.generatePush("lit[",1+(31&e),"]");break;case 64:case 72:case 80:case 88:this.generatePush("lit[",1+(31&e),"].pointers[1]");break;case 96:this.generatePopInto("inst[",7&e,"]");break;case 104:this.generatePopInto("temp[",6+(7&e),"]");break;case 112:switch(e){case 112:this.generatePush("rcvr");break;case 113:this.generatePush("vm.trueObj");break;case 114:this.generatePush("vm.falseObj");break;case 115:this.generatePush("vm.nilObj");break;case 116:this.generatePush("-1");break;case 117:this.generatePush("0");break;case 118:this.generatePush("1");break;case 119:this.generatePush("2")}break;case 120:switch(e){case 120:this.generateReturn("rcvr");break;case 121:this.generateReturn("vm.trueObj");break;case 122:this.generateReturn("vm.falseObj");break;case 123:this.generateReturn("vm.nilObj");break;case 124:this.generateReturn("stack[vm.sp]");break;case 125:this.generateBlockReturn();break;default:throw Error("unusedBytecode "+e)}break;case 128:case 136:this.generateV3Extended(e);break;case 144:this.generateJump(1+(7&e));break;case 152:this.generateJumpIf(!1,1+(7&e));break;case 160:s=t.bytes[this.pc++],this.generateJump(256*((7&e)-4)+s);break;case 168:s=t.bytes[this.pc++],this.generateJumpIf(e<172,256*(3&e)+s);break;case 176:case 184:this.generateNumericOp(e);break;case 192:case 200:this.generateQuickPrim(e);break;case 208:case 216:this.generateSend("lit[",1+(15&e),"]",0,!1);break;case 224:case 232:this.generateSend("lit[",1+(15&e),"]",1,!1);break;case 240:case 248:this.generateSend("lit[",1+(15&e),"]",2,!1)}}},generateV3Extended:function(t){var e,s;switch(t){case 128:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generatePush("inst[",63&e,"]");case 1:return void this.generatePush("temp[",6+(63&e),"]");case 2:return void this.generatePush("lit[",1+(63&e),"]");case 3:return void this.generatePush("lit[",1+(63&e),"].pointers[1]")}return;case 129:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generateStoreInto("inst[",63&e,"]");case 1:return void this.generateStoreInto("temp[",6+(63&e),"]");case 2:throw Error("illegal store into literal");case 3:return void this.generateStoreInto("lit[",1+(63&e),"].pointers[1]")}return;case 130:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generatePopInto("inst[",63&e,"]");case 1:return void this.generatePopInto("temp[",6+(63&e),"]");case 2:throw Error("illegal pop into literal");case 3:return void this.generatePopInto("lit[",1+(63&e),"].pointers[1]")}return;case 131:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(31&e),"]",e>>5,!1);case 132:switch(e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],e>>5){case 0:return void this.generateSend("lit[",1+s,"]",31&e,!1);case 1:return void this.generateSend("lit[",1+s,"]",31&e,!0);case 2:return void this.generatePush("inst[",s,"]");case 3:return void this.generatePush("lit[",1+s,"]");case 4:return void this.generatePush("lit[",1+s,"].pointers[1]");case 5:return void this.generateStoreInto("inst[",s,"]");case 6:return void this.generatePopInto("inst[",s,"]");case 7:return void this.generateStoreInto("lit[",1+s,"].pointers[1]")}return;case 133:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(31&e),"]",e>>5,!0);case 134:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(63&e),"]",e>>6,!1);case 135:return void this.generateInstruction("pop","vm.sp--");case 136:return this.needsVar.stack=!0,void this.generateInstruction("dup","var dup = stack[vm.sp]; stack[++vm.sp] = dup");case 137:return this.needsVar.stack=!0,void this.generateInstruction("push thisContext","stack[++vm.sp] = vm.exportThisContext()");case 138:var i=(e=this.method.bytes[this.pc++])>127,r=127&e;return void this.generateClosureTemps(r,i);case 139:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generateCallPrimitive(e+256*s,129);case 140:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generatePush("temp[",6+s,"].pointers[",e,"]");case 141:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generateStoreInto("temp[",6+s,"].pointers[",e,"]");case 142:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generatePopInto("temp[",6+s,"].pointers[",e,"]");case 143:var n=15&(e=this.method.bytes[this.pc++]),a=e>>4,o=(s=this.method.bytes[this.pc++])<<8|this.method.bytes[this.pc++];return void this.generateClosureCopy(n,a,o)}},generateSista:function(){var t,e,s,i=this.method.bytes,r=0,n=0;for(this.done=!1;!this.done;){switch(t=i[this.pc++]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:this.generatePush("inst[",15&t,"]");break;case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:this.generatePush("lit[",1+(15&t),"].pointers[1]");break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.generatePush("lit[",1+(31&t),"]");break;case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:this.generatePush("temp[",6+(7&t),"]");break;case 72:case 73:case 74:case 75:this.generatePush("temp[",6+(3&t)+8,"]");break;case 76:this.generatePush("rcvr");break;case 77:this.generatePush("vm.trueObj");break;case 78:this.generatePush("vm.falseObj");break;case 79:this.generatePush("vm.nilObj");break;case 80:this.generatePush(0);break;case 81:this.generatePush(1);break;case 82:this.needsVar.stack=!0,this.generateInstruction("push thisContext","stack[++vm.sp] = vm.exportThisContext()");break;case 83:this.needsVar.stack=!0,this.generateInstruction("dup","var dup = stack[vm.sp]; stack[++vm.sp] = dup");break;case 84:case 85:case 86:case 87:case 218:case 219:case 220:case 221:case 222:case 223:case 246:case 247:case 254:case 255:throw Error("unusedBytecode "+t);case 88:this.generateReturn("rcvr");break;case 89:this.generateReturn("vm.trueObj");break;case 90:this.generateReturn("vm.falseObj");break;case 91:this.generateReturn("vm.nilObj");break;case 92:this.generateReturn("stack[vm.sp]");break;case 93:this.generateBlockReturn("vm.nilObj");break;case 94:this.generateBlockReturn();break;case 95:break;case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:this.generateNumericOp(t);break;case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:this.generateQuickPrim(t);break;case 128:case 129:case 130:case 131:case 132:case 133:case 134:case 135:case 136:case 137:case 138:case 139:case 140:case 141:case 142:case 143:this.generateSend("lit[",1+(15&t),"]",0,!1);break;case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:this.generateSend("lit[",1+(15&t),"]",1,!1);break;case 160:case 161:case 162:case 163:case 164:case 165:case 166:case 167:case 168:case 169:case 170:case 171:case 172:case 173:case 174:case 175:this.generateSend("lit[",1+(15&t),"]",2,!1);break;case 176:case 177:case 178:case 179:case 180:case 181:case 182:case 183:this.generateJump(1+(7&t));break;case 184:case 185:case 186:case 187:case 188:case 189:case 190:case 191:this.generateJumpIf(!0,1+(7&t));break;case 192:case 193:case 194:case 195:case 196:case 197:case 198:case 199:this.generateJumpIf(!1,1+(7&t));break;case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 207:this.generatePopInto("inst[",7&t,"]");break;case 208:case 209:case 210:case 211:case 212:case 213:case 214:case 215:this.generatePopInto("temp[",6+(7&t),"]");break;case 216:this.generateInstruction("pop","vm.sp--");break;case 217:throw Error("unumplementedBytecode: 0xD9 (unconditional trap)");case 224:r=256*r+(e=i[this.pc++]);continue;case 225:n=256*n+((e=i[this.pc++])<128?e:e-256);continue;case 226:e=i[this.pc++],this.generatePush("inst[",e+256*r,"]");break;case 227:e=i[this.pc++],this.generatePush("lit[",1+e+256*r,"].pointers[1]");break;case 228:e=i[this.pc++],this.generatePush("lit[",1+e+256*r,"]");break;case 229:e=i[this.pc++],this.generatePush("temp[",6+e,"]");break;case 230:throw Error("unusedBytecode 0xE6");case 231:var a=(e=i[this.pc++])>127,o=127&e;this.generateClosureTemps(o,a);break;case 232:e=i[this.pc++],this.generatePush(e+256*n);break;case 233:e=i[this.pc++],this.generatePush("vm.image.getCharacter(",e+256*n,")");break;case 234:e=i[this.pc++],this.generateSend("lit[",1+(e>>3)+(r<<5),"]",(7&e)+(n<<3),!1);break;case 235:var c=((e=i[this.pc++])>>3)+(r<<5),h=(7&e)+((63&n)<<3),u=n>=64;this.generateSend("lit[",1+c,"]",h,!u||"directed");break;case 236:throw Error("unimplemented bytecode: 0xEC (class trap)");case 237:e=i[this.pc++],this.generateJump(e+256*n);break;case 238:e=i[this.pc++],this.generateJumpIf(!0,e+256*n);break;case 239:e=i[this.pc++],this.generateJumpIf(!1,e+256*n);break;case 240:e=i[this.pc++],this.generatePopInto("inst[",e+256*r,"]");break;case 241:e=i[this.pc++],this.generatePopInto("lit[",1+e+256*r,"].pointers[1]");break;case 242:e=i[this.pc++],this.generatePopInto("temp[",6+e,"]");break;case 243:e=i[this.pc++],this.generateStoreInto("inst[",e+256*r,"]");break;case 244:e=i[this.pc++],this.generateStoreInto("lit[",1+e+256*r,"].pointers[1]");break;case 245:e=i[this.pc++],this.generateStoreInto("temp[",6+e,"]");break;case 248:e=i[this.pc++],s=i[this.pc++],this.generateCallPrimitive(e+256*s,245);break;case 249:e=i[this.pc++],s=i[this.pc++],this.generatePushFullClosure(e+255*r,s);break;case 250:h=(7&(e=i[this.pc++]))+8*(15&r);var l=(e>>3&7)+8*(r>>4),p=(s=i[this.pc++])+(n<<8);this.generateClosureCopy(h,l,p);break;case 251:e=i[this.pc++],s=i[this.pc++],this.generatePush("temp[",6+s,"].pointers[",e,"]");break;case 252:e=i[this.pc++],s=i[this.pc++],this.generateStoreInto("temp[",6+s,"].pointers[",e,"]");break;case 253:e=i[this.pc++],s=i[this.pc++],this.generatePopInto("temp[",6+s,"].pointers[",e,"]");break;default:throw Error("illegal bytecode: "+t)}r=0,n=0}},generatePush:function(t,e,s,i,r){this.debug&&this.generateDebugCode("push",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push("stack[++vm.sp] = ",t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(";\n")},generateStoreInto:function(t,e,s,i,r){this.debug&&this.generateDebugCode("store into",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push(t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(" = stack[vm.sp];\n"),this.generateDirty(t,e,s)},generatePopInto:function(t,e,s,i,r){this.debug&&this.generateDebugCode("pop into",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push(t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(" = stack[vm.sp--];\n"),this.generateDirty(t,e,s)},generateReturn:function(t){this.debug&&this.generateDebugCode("return",t),this.generateLabel(),this.needsVar[t]=!0,this.source.push("vm.pc = ",this.pc,"; vm.doReturn(",t,"); return;\n"),this.needsBreak=!1,this.done=this.pc>this.endPC},generateBlockReturn:function(t){this.debug&&this.generateDebugCode("block return"),this.generateLabel(),t||(this.needsVar.stack=!0,t="stack[vm.sp--]"),this.needsVar.context=!0,this.source.push("vm.pc = ",this.pc,"; vm.doReturn(",t,", context.pointers[0]); return;\n"),this.needsBreak=!1,this.done=this.pc>this.endPC},generateJump:function(t){var e=this.pc+t;this.debug&&this.generateDebugCode("jump to "+e),this.generateLabel(),this.needsVar.context=!0,this.source.push("vm.pc = ",e,"; "),t<0&&this.source.push("\nif (vm.interruptCheckCounter-- <= 0) {\n","   vm.checkForInterrupts();\n","   if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n","}\n"),this.singleStep&&this.source.push("\nif (vm.breakOutOfInterpreter) return;\n"),this.source.push("continue;\n"),this.needsBreak=!1,this.needsLabel[e]=!0,e>this.endPC&&(this.endPC=e)},generateJumpIf:function(t,e){var s=this.pc+e;this.debug&&this.generateDebugCode("jump if "+t+" to "+s),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var cond = stack[vm.sp--]; if (cond === vm.",t,"Obj) {vm.pc = ",s,"; "),this.singleStep&&this.source.push("if (vm.breakOutOfInterpreter) return; else "),this.source.push("continue}\n","else if (cond !== vm.",!t,"Obj) {vm.sp++; vm.pc = ",this.pc,"; vm.send(vm.specialObjects[25], 0, false); return}\n"),this.needsLabel[this.pc]=!0,this.needsLabel[s]=!0,s>this.endPC&&(this.endPC=s)},generateQuickPrim:function(t){switch(this.debug&&this.generateDebugCode("quick send #"+this.specialSelectors[16+(15&t)]),this.generateLabel(),15&t){case 0:return this.needsVar.stack=!0,this.source.push("var a, b; if ((a=stack[vm.sp-1]).sqClass === vm.specialObjects[7] && a.pointers && typeof (b=stack[vm.sp]) === 'number' && b>0 && b<=a.pointers.length) {\n","  stack[--vm.sp] = a.pointers[b-1];","} else { var c = vm.primHandler.objectAt(true,true,false); if (vm.primHandler.success) stack[--vm.sp] = c; else {\n","  vm.pc = ",this.pc,"; vm.sendSpecial(16); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return; }}\n"),void(this.needsLabel[this.pc]=!0);case 1:return this.needsVar.stack=!0,this.source.push("var a, b; if ((a=stack[vm.sp-2]).sqClass === vm.specialObjects[7] && a.pointers && typeof (b=stack[vm.sp-1]) === 'number' && b>0 && b<=a.pointers.length) {\n","  var c = stack[vm.sp]; stack[vm.sp-=2] = a.pointers[b-1] = c; a.dirty = true;","} else { vm.primHandler.objectAtPut(true,true,false); if (vm.primHandler.success) stack[vm.sp-=2] = c; else {\n","  vm.pc = ",this.pc,"; vm.sendSpecial(17); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return; }}\n"),void(this.needsLabel[this.pc]=!0);case 2:return this.needsVar.stack=!0,this.source.push("if (stack[vm.sp].sqClass === vm.specialObjects[7]) stack[vm.sp] = stack[vm.sp].pointersSize();\n","else if (stack[vm.sp].sqClass === vm.specialObjects[6]) stack[vm.sp] = stack[vm.sp].bytesSize();\n","else { vm.pc = ",this.pc,"; vm.sendSpecial(18); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return; }\n"),void(this.needsLabel[this.pc]=!0);case 6:return this.needsVar.stack=!0,void this.source.push("var cond = stack[vm.sp-1] === stack[vm.sp];\nstack[--vm.sp] = cond ? vm.trueObj : vm.falseObj;\n");case 7:return this.needsVar.stack=!0,void this.source.push("stack[vm.sp] = typeof stack[vm.sp] === 'number' ? vm.specialObjects[5] : stack[vm.sp].sqClass;\n");case 8:return this.needsVar.rcvr=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,")) ","{vm.sendSpecial(",16+(15&t),"); return}\n"),this.needsLabel[this.pc]=!0,void(this.needsLabel[this.pc+2]=!0);case 9:case 10:case 11:return this.needsVar.rcvr=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,")) vm.sendSpecial(",16+(15&t),"); return;\n"),void(this.needsLabel[this.pc]=!0)}this.needsVar.rcvr=!0,this.needsVar.context=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,"))"," vm.sendSpecial(",16+(15&t),");\n","if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n"),this.needsBreak=!1,this.needsLabel[this.pc]=!0},generateNumericOp:function(t){switch(this.debug&&this.generateDebugCode("quick send #"+this.specialSelectors[15&t]),this.generateLabel(),this.needsLabel[this.pc]=!0,15&t){case 0:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = vm.primHandler.signed32BitIntegerFor(a + b);\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(0); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 1:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = vm.primHandler.signed32BitIntegerFor(a - b);\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(1); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 2:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a < b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(2); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 3:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a > b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(3); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 4:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a <= b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(4); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 5:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a >= b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(5); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 6:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a === b ? vm.trueObj : vm.falseObj;\n","} else if (a === b && a.float === a.float) {\n","   stack[--vm.sp] = vm.trueObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(6); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 7:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a !== b ? vm.trueObj : vm.falseObj;\n","} else if (a === b && a.float === a.float) {\n","   stack[--vm.sp] = vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(7); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 8:return void this.source.push("vm.success = true; vm.resultIsFloat = false; if(!vm.pop2AndPushNumResult(vm.stackIntOrFloat(1) * vm.stackIntOrFloat(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(8); return}\n");case 9:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.quickDivide(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(9); return}\n");case 10:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.mod(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(10); return}\n");case 11:return void this.source.push("vm.success = true; if(!vm.primHandler.primitiveMakePoint(1, true)) { vm.pc = ",this.pc,"; vm.sendSpecial(11); return}\n");case 12:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.safeShift(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(12); return}\n");case 13:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.div(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(13); return}\n");case 14:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.stackInteger(1) & vm.stackInteger(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(14); return}\n");case 15:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.stackInteger(1) | vm.stackInteger(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(15); return}\n")}},generateSend:function(t,e,s,i,r){this.debug&&this.generateDebugCode(("directed"===r?"directed super send ":r?"super send ":"send ")+("lit["===t?this.method.pointers[e].bytesAsString():"...")),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.context=!0,this.source.push("vm.pc = ",this.pc),"directed"===r?this.source.push("; vm.sendSuperDirected(",t,e,s,", ",i,"); "):this.source.push("; vm.send(",t,e,s,", ",i,", ",r,"); "),this.source.push("if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n"),this.needsBreak=!1,this.needsLabel[this.pc]=!0},generateClosureTemps:function(t,e){if(this.debug&&this.generateDebugCode("closure temps"),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var array = vm.instantiateClass(vm.specialObjects[7], ",t,");\n"),e){for(var s=0;s<t;s++)this.source.push("array.pointers[",s,"] = stack[vm.sp - ",t-s-1,"];\n");this.source.push("stack[vm.sp -= ",t-1,"] = array;\n")}else this.source.push("stack[++vm.sp] = array;\n")},generateClosureCopy:function(t,e,s){var i=this.pc,r=i+s;if(this.debug&&this.generateDebugCode("push closure("+i+"-"+(r-1)+"): "+e+" copied, "+t+" args"),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var closure = vm.instantiateClass(vm.specialObjects[36], ",e,");\n","closure.pointers[0] = context; vm.reclaimableContextCount = 0;\n","closure.pointers[1] = ",i+4*this.method.pointers.length+1,";\n","closure.pointers[2] = ",t,";\n"),e>0){for(var n=0;n<e;n++)this.source.push("closure.pointers[",n+3,"] = stack[vm.sp - ",e-n-1,"];\n");this.source.push("stack[vm.sp -= ",e-1,"] = closure;\n")}else this.source.push("stack[++vm.sp] = closure;\n");this.source.push("vm.pc = ",r,";\n"),this.singleStep&&this.source.push("if (vm.breakOutOfInterpreter) return;\n"),this.source.push("continue;\n"),this.needsBreak=!1,this.needsLabel[i]=!0,this.needsLabel[r]=!0,r>this.endPC&&(this.endPC=r)},generatePushFullClosure:function(t,e){this.debug&&this.generateDebugCode("push full closure "+(t+1)),this.generateLabel(),this.needsVar["lit["]=!0,this.needsVar.rcvr=!0,this.needsVar.stack=!0;var s,i=63&e;if(s=1==(e>>6&1)?"vm.nilObj":"context",1==(e>>7&1))throw Error("on-stack receiver not yet supported");if(this.source.push("var closure = vm.newFullClosure(",s,", ",i,", lit[",1+t,"]);\n"),this.source.push("closure.pointers[",3,"] = rcvr;\n"),"context"===s&&this.source.push("vm.reclaimableContextCount = 0;\n"),i>0){for(var r=0;r<i;r++)this.source.push("closure.pointers[",r+4,"] = stack[vm.sp - ",i-r-1,"];\n");this.source.push("stack[vm.sp -= ",i-1,"] = closure;\n")}else this.source.push("stack[++vm.sp] = closure;\n")},generateCallPrimitive:function(t,e){this.debug&&this.generateDebugCode("call primitive "+t),this.generateLabel(),this.method.bytes[this.pc]===e&&(this.needsVar.stack=!0,this.source.push("if (vm.primFailCode) {stack[vm.sp] = vm.getErrorObjectFromPrimFailCode(); vm.primFailCode = 0;}\n"))},generateDirty:function(t,e,s){switch(t){case"inst[":this.source.push("rcvr.dirty = true;\n");break;case"lit[":this.source.push(t,e,"].dirty = true;\n");break;case"temp[":"]"!==s&&this.source.push(t,e,"].dirty = true;\n");break;default:throw Error("unexpected target "+t)}},generateLabel:function(){this.prevPC&&(this.sourceLabels[this.prevPC]=this.source.length,this.source.push("case ",this.prevPC,":\n")),this.prevPC=this.pc},generateDebugCode:function(t,e,s,i,r,n){this.needsBreak&&(this.source.push("if (vm.breakOutOfInterpreter) {vm.pc = ",this.prevPC,"; return}\n"),this.needsLabel[this.prevPC]=!0);for(var a=[],o=this.prevPC;o<this.pc;o++)a.push((this.method.bytes[o]+256).toString(16).slice(-2).toUpperCase());if(this.source.push("// ",this.prevPC," <",a.join(" "),"> ",t),void 0!==e)switch(this.source.push(" "),e){case"vm.nilObj":this.source.push("nil");break;case"vm.trueObj":this.source.push("true");break;case"vm.falseObj":this.source.push("false");break;case"rcvr":this.source.push("self");break;case"stack[vm.sp]":this.source.push("top of stack");break;case"inst[":this.instVarNames?this.source.push(this.instVarNames[s]):this.source.push("inst var ",s);break;case"temp[":this.source.push("tmp",s-6),"]"!==i&&this.source.push("[",r,"]");break;case"lit[":var c=this.method.pointers[s];"]"===i?this.source.push(c):this.source.push(c.pointers[0].bytesAsString());break;default:this.source.push(e)}this.source.push("\n"),this.needsBreak=this.singleStep},generateInstruction:function(t,e){this.debug&&this.generateDebugCode(t),this.generateLabel(),this.source.push(e,";\n")},deleteUnneededLabels:function(){var t=!1;for(var e in this.sourceLabels)if(this.needsLabel[e])t=!0;else for(var s=0;s<3;s++)this.source[this.sourceLabels[e]+s]="";t||(this.source[this.sourcePos["loop-start"]]="",this.source[this.sourcePos["loop-end"]]="")},deleteUnneededVariables:function(){this.needsVar.stack&&(this.needsVar.context=!0),this.needsVar["inst["]&&(this.needsVar.rcvr=!0);for(var t=0;t<this.allVars.length;t++){var e=this.allVars[t];this.needsVar[e]||(this.source[this.sourcePos[e]]="")}}}),Object.extend(Squeak,"known classes",{BitBlt_dest:0,BitBlt_source:1,BitBlt_halftone:2,BitBlt_combinationRule:3,BitBlt_destX:4,BitBlt_destY:5,BitBlt_width:6,BitBlt_height:7,BitBlt_sourceX:8,BitBlt_sourceY:9,BitBlt_clipX:10,BitBlt_clipY:11,BitBlt_clipW:12,BitBlt_clipH:13,BitBlt_colorMap:14,BitBlt_warpBase:15,Form_bits:0,Form_width:1,Form_height:2,Form_depth:3,Form_offset:4}),Object.extend(Squeak.Primitives.prototype,"display",{displayDirty:function(){}}),Object.extend(Squeak.Primitives.prototype,"display",{primitiveScreenSize:function(){return!1},primitiveScreenDepth:function(){return!1},primitiveTestDisplayDepth:function(){return!1},primitiveBeDisplay:function(t){return this.vm.popN(t),!0},primitiveReverseDisplay:function(){return!1},primitiveDeferDisplayUpdates:function(){return!1},primitiveForceDisplayUpdate:function(){return!1},primitiveScanCharacters:function(){return!1},primitiveSetFullScreen:function(){return!1},primitiveShowDisplayRect:function(){return!1},primitiveBeCursor:function(t){return this.vm.popN(t),!0}}),Object.extend(Squeak,"events",{Mouse_Blue:1,Mouse_Yellow:2,Mouse_Red:4,Keyboard_Shift:8,Keyboard_Ctrl:16,Keyboard_Alt:32,Keyboard_Cmd:64,Mouse_All:7,Keyboard_All:120,EventTypeNone:0,EventTypeMouse:1,EventTypeKeyboard:2,EventTypeDragDropFiles:3,EventKeyChar:0,EventKeyDown:1,EventKeyUp:2,EventDragEnter:1,EventDragMove:2,EventDragLeave:3,EventDragDrop:4,EventTypeWindow:5,EventTypeComplex:6,EventTypeMouseWheel:7,WindowEventMetricChange:1,WindowEventClose:2,WindowEventIconise:3,WindowEventActivated:4,WindowEventPaint:5,WindowEventScreenChange:6,EventTouchDown:1,EventTouchUp:2,EventTouchMoved:3,EventTouchStationary:4,EventTouchCancelled:5}),Object.extend(Squeak.Primitives.prototype,"input",{primitiveMouseButtons:function(){return!1},primitiveMousePoint:function(){return!1},primitiveKeyboardNext:function(){return!1},primitiveKeyboardPeek:function(){return!1},primitiveInputSemaphore:function(t){return this.vm.popNandPush(t+1,this.vm.nilObj),!0},primitiveInputWord:function(){return!1},primitiveGetNextEvent:function(){return!1},primitiveBeep:function(){return!1},primitiveClipboardText:function(){return!1}}),Object.extend(Squeak.Primitives.prototype,"initialization",{initPlugins:function(){Object.extend(this.builtinModules,{JavaScriptPlugin:this.findPluginFunctions("js_"),FilePlugin:this.findPluginFunctions("","primitive(Disable)?(File|Directory)"),DropPlugin:this.findPluginFunctions("","primitiveDropRequest"),SoundPlugin:this.findPluginFunctions("snd_"),JPEGReadWriter2Plugin:this.findPluginFunctions("jpeg2_"),SqueakFFIPrims:this.findPluginFunctions("ffi_","",!0),HostWindowPlugin:this.findPluginFunctions("hostWindow_"),SecurityPlugin:{primitiveDisableImageWrite:this.fakePrimitive.bind(this,"SecurityPlugin.primitiveDisableImageWrite",0),primitiveGetUntrustedUserDirectory:this.fakePrimitive.bind(this,"SecurityPlugin.primitiveGetUntrustedUserDirectory","/SqueakJS")},LocalePlugin:{primitiveTimezoneOffset:this.fakePrimitive.bind(this,"LocalePlugin.primitiveTimezoneOffset",0)}}),Object.extend(this.patchModules,{ScratchPlugin:this.findPluginFunctions("scratch_")})},findPluginFunctions:function(t,e,s){e=e||"(initialise|shutdown|prim)";var i={},r=new RegExp("^"+t+e,"i");for(var n in this)if(r.test(n)&&"function"==typeof this[n]){var a=n;t&&(a=n[t.length].toLowerCase()+n.slice(t.length+1)),i[a]=s?n:this[n].bind(this)}return i}}),function(){var t=1,e=11;function s(t){return"number"==typeof t?h.classSmallInteger():t.sqClass}function i(t){return t.bytes?t.bytes.length:t.words?4*t.words.length:0}function r(t,e){return 0|Math.floor(t/e)}function n(t,e){return t-r(t,e)*e|0}function a(t,e){return e>31?0:t<<e}function o(t,e){return e>31?0:t>>>e}var c=0,h=null,u="LargeIntegers v1.5 (e)",l=1,p=2;function m(t,e,s){var r,c,u,l,p,m,f,d;if(e<1||s<1)return h.primitiveFail();if(c=t,m=Math.min(s,function(t){return b(t.bytes,i(t))}(c)),e>m)return!1;if(p=1+(e-1>>3),r=1+(m-1>>3),l=n(e-1,8),u=7-n(m-1,8),p===r)return f=a(255,l)&o(255,u),0!=(E(c,p)&f);if(0!==o(E(c,p),l))return!0;for(d=p+1;d<=r-1;d++)if(0!==E(c,d))return!0;return 0!=(255&a(E(c,r),u))}function f(t,e){var r,n,a;return a=h.instantiateClassindexableSize(s(t),e),n=(r=i(t))<e?r:e,g(t.bytes,a.bytes,n),a}function d(t,e){var s,i,r;return"number"==typeof t?(s=(i=t)<0?h.classLargeNegativeInteger():h.classLargePositiveInteger(),function(t,e){var s,i,r;for(s=e.bytes,i=1,r=k(t);i<=r;i++)s[i-1]=y(t,i)}(i,r=h.instantiateClassindexableSize(s,e))):r=f(t,e),r}function v(t,e,s){var i,r,n;for(n=s-1;n>=0;){if((r=e[n])!==(i=t[n]))return r<i?1:-1;--n}return 0}function g(t,e,s){var i,r;for(i=s-1,r=0;r<=i;r++)e[r]=t[r];return 0}function b(t,e){var s,i;for(i=e;0===(s=t[i-1]);)if(0==--i)return 0;return P(s)+8*(i-1)}function k(t){return t<256&&t>-256?1:t<65536&&t>-65536?2:t<16777216&&t>-16777216?3:4}function y(t,e){return e<1&&h.primitiveFail(),e>4?0:t<0?255&o(0-t,8*(e-1)):255&o(t,8*(e-1))}function S(t,e,s,i,r){return function(){for(var n=s-e+1,a=0;a<n;a++)t[a+e]=i[a+r];return 0}()}function P(t){var e,s;return s=0,(e=t)<65536||(e>>>=16,s+=16),e<256||(e>>>=8,s+=8),e<16||(e>>>=4,s+=4),e<4||(e>>>=2,s+=2),e<2||(e>>>=1,++s),s+e}function C(t){var e,s,i,r,n,a;for(n=(a=t)<0?h.classLargeNegativeInteger():h.classLargePositiveInteger(),e=k(a),i=(s=h.instantiateClassindexableSize(n,e)).bytes,r=1;r<=e;r++)i[r-1]=y(a,r);return s}function I(t,e){var r,c,u,l;return c=i(t),0===(l=b(t.bytes,c))?0:(r=l+e+7>>3,u=h.instantiateClassindexableSize(s(t),r),function(t,e,s,i,r){var c,h,u,l,p,m,f;for(c=t>>3,p=n(t,8),f=c-1,l=0;l<=f;l++)i[l]=0;if(0===p)return S(i,c,r-1,e,0);for(m=8-p,h=0,f=s-1,l=0;l<=f;l++)u=e[l],i[l+c]=255&(h|a(u,p)),h=o(u,m);0!==h&&(i[r-1]=h)}(e,t.bytes,c,u.bytes,r),u)}function O(t,e,i){var r,c,u,l,p;return c=(p=b(t.bytes,i))+7>>3,(l=p-e)<=0?h.instantiateClassindexableSize(s(t),0):(u=l+7>>3,r=h.instantiateClassindexableSize(s(t),u),function(t,e,s,i,r){var c,h,u,l,p,m,f,d;if(h=t>>3,0===(p=n(t,8)))return S(i,0,r-1,e,h);for(m=8-p,u=o(e[h],p),f=s-1,c=d=h+1;c<=f;c++)l=e[c],i[c-d]=255&(u|a(l,m)),u=o(l,p);0!==u&&(i[r-1]=u)}(e,t.bytes,c,r.bytes,u),r)}function x(t,e){var r,n,a,o,c,u,l,p,m,f;return p=i(t),m=i(e),c=s(t),p<=m?(o=t,n=p,f=e,l=m):(o=e,n=m,f=t,l=p),r=h.instantiateClassindexableSize(c,l),a=function(t,e,s,i,r){var n,a,o;for(o=0,a=e-1,n=0;n<=a;n++)o=(o>>>8)+t[n]+s[n],r[n]=255&o;for(a=i-1,n=e;n<=a;n++)o=(o>>>8)+s[n],r[n]=255&o;return o>>>8}(o.bytes,n,f.bytes,l,r.bytes),a>0&&(u=h.instantiateClassindexableSize(c,l+1),g(r.bytes,u.bytes,l),(r=u).bytes[l]=a),r}function w(t,e,r){var n,a,o,u,m,f,d,v,g;if("number"==typeof t){if(t<0)return h.primitiveFail();o=C(t)}else{if(s(t)===h.classLargeNegativeInteger())return h.primitiveFail();o=t}if("number"==typeof e){if(e<0)return h.primitiveFail();u=C(e)}else{if(s(e)===h.classLargeNegativeInteger())return h.primitiveFail();u=e}return(d=i(o))<(v=i(u))?(n=d,a=o,m=v,f=u):(n=v,a=u,m=d,f=o),g=h.instantiateClassindexableSize(h.classLargePositiveInteger(),m),function(t,e,s,i,r,n){var a,o;if(o=s-1,t===c){for(a=0;a<=o;a++)n[a]=e[a]&i[a];for(o=r-1,a=s;a<=o;a++)n[a]=0;return 0}if(t===l){for(a=0;a<=o;a++)n[a]=e[a]|i[a];for(o=r-1,a=s;a<=o;a++)n[a]=i[a];return 0}if(t===p){for(a=0;a<=o;a++)n[a]=e[a]^i[a];for(o=r-1,a=s;a<=o;a++)n[a]=i[a];return 0}h.primitiveFail()}(r,a.bytes,n,f.bytes,m,g.bytes),h.failed()?0:L(g)}function j(t,e){var s,r;return r=i(t),(s=i(e))!==r?s>r?-1:1:v(t.bytes,e.bytes,r)}function V(t,e,s){var a,o,c,u,l,p,m,f,v;return v=i(t),f=i(e),a=s?h.classLargeNegativeInteger():h.classLargePositiveInteger(),(m=v-f+1)<=0?(o=h.instantiateClassindexableSize(h.classArray(),2),h.stObjectatput(o,1,0),h.stObjectatput(o,2,t),o):(u=d(u=I(e,p=8-P(pt(e,f))),N(u)+1),N(c=I(t,p))===v&&(c=d(c,v+1)),l=h.instantiateClassindexableSize(a,m),function(t,e,s,i,a,o){var c,h,u,l,p,m,f,d,v,g,b,k,y,S,P,C,I,O;for(P=o,I=t[(S=e-1)-1],l=1===S?0:t[S-2],b=1;b<=P;b++){if(s[(k=i+1-b)-1]===I)h=255;else for(O=n(C=((C=s[k-1])<<8)+s[k-2],I),m=(d=(h=r(C,I))*l)>>>8,p=255&d,f=k<3?0:s[k-3];O<m||O===m&&f<p?(--h,p<l?(--m,p=p+256-l):p-=l,v=m>=I):v=!1,v;)m-=I;for(g=k-S,u=0,y=1;y<=e;y++)m=t[y-1]*(h>>>8),p=t[y-1]*(255&h),c=s[g-1]-u-(255&p),s[g-1]=255&c,u=m+(p>>>8)-(c>>=8),++g;if(u>0)for(--h,g=k-S,u=0,y=1;y<=e;y++)u=(u>>>8)+s[g-1]+t[y-1],s[g-1]=255&u,++g;a[o-b]=h}}(u.bytes,N(u),c.bytes,N(c),l.bytes,N(l)),c=O(c,p,N(u)-1),o=h.instantiateClassindexableSize(h.classArray(),2),h.stObjectatput(o,1,l),h.stObjectatput(o,2,c),o)}function N(t){return"number"==typeof t?k(t):i(t)}function A(t,e,s,r){var n,a,o,c;return o=i(t),c=i(e),o<=(a=i(s))&&c<=a&&r>=0&&r<=255?(n=h.instantiateClassindexableSize(h.classLargePositiveInteger(),a),function(t,e,s,i,r,n,a,o){var c,h,u,l,p,m,f,d;for(m=e-1,p=i-1,l=n-1,u=0,h=0;h<=m;h++){for(d=o[0]+t[h]*s[0],d+=(f=d*a&255)*r[0],c=1;c<=p;c++)d=(d>>>8)+o[c]+t[h]*s[c]+f*r[c],o[c-1]=255&d;for(c=i;c<=l;c++)d=(d>>>8)+o[c]+f*r[c],o[c-1]=255&d;d=(d>>>8)+u,o[l]=255&d,u=d>>>8}for(h=e;h<=l;h++){for(d=o[0],d+=(f=d*a&255)*r[0],c=1;c<=l;c++)d=(d>>>8)+o[c]+f*r[c],o[c-1]=255&d;d=(d>>>8)+u,o[l]=255&d,u=d>>>8}if(0!==u||1!==v(r,o,n))for(d=0,h=0;h<=l;h++)d=d+o[h]-r[h],o[h]=255&d,d>>=8}(t.bytes,o,e.bytes,c,s.bytes,a,r,n.bytes),L(n)):h.primitiveFail()}function F(t,e,s){var r,n,a,o,c,u,l,p;return(p=i(t))<=(l=i(e))?(o=t,a=p,r=e,c=l):(o=e,a=l,r=t,c=p),n=s?h.classLargeNegativeInteger():h.classLargePositiveInteger(),u=h.instantiateClassindexableSize(n,c+a),function(t,e,s,i,r){var n,a,o,c,h,u,l,p;if(1===e&&0===t[0])return 0;if(1===i&&0===s[0])return 0;for(p=e-1,u=i-1,h=0;h<=p;h++)if(0!==(o=t[h])){for(l=h,c=0,a=0;a<=u;a++)c=(n=(n=s[a])*o+c+r[l])>>>8,r[l]=255&n,++l;r[l]=c}}(o.bytes,a,r.bytes,c,u.bytes),M(u)}function E(t,e){return e>i(t)?0:pt(t,e)}function T(t,e){var r,n,a,o,c,u,l,p,m,f;if(l=s(t)===h.classLargeNegativeInteger(),(p=i(t))===(m=i(e))){for(;p>1&&E(t,p)===E(e,p);)--p;m=p}return p<m||p===m&&E(t,p)<E(e,p)?(n=e,u=m,o=t,r=p,f=!1===l):(n=t,u=p,o=e,r=m,f=l),c=u,a=h.instantiateClassindexableSize(f?h.classLargeNegativeInteger():h.classLargePositiveInteger(),c),function(t,e,s,i,r){var n,a;for(a=0,n=0;n<=e-1;n++)a=a+s[n]-t[n],r[n]=255&a,a>>=8;for(n=e;n<=i-1;n++)a+=s[n],r[n]=255&a,a>>=8}(o.bytes,r,n.bytes,u,a.bytes),f?R(a):L(a)}function B(){return u}function _(t){var e,i,r;if("number"==typeof t)return!0;if(0===(i=N(t)))return!1;if(0===pt(t,i))return!1;if(4,i>4)return!0;if(i<4)return!1;if(s(t)===h.classLargePositiveInteger())return 1073741823,pt(t,4)>y(1073741823,4);if(r=-1073741824,pt(t,4)<y(r,4))return!1;for(e=1;e<=4;e++)if(pt(t,e)!==y(r,e))return!0;return!1}function M(t){return s(t)===h.classLargePositiveInteger()?L(t):R(t)}function R(t){var e,s,i,r,n;for(s=r=N(t);0!==s&&0===pt(t,s);)--s;if(0===s)return 0;if(4,s<=4){if(i=-1073741824,s<4||E(t,4)<y(i,4)){for(n=0,e=s;e>=1;e+=-1)n=256*n-pt(t,e);return n}for(e=1;e<=4;e++)if(E(t,e)!==y(i,e))return s<r?f(t,s):t;return i}return s<r?f(t,s):t}function L(t){var e,s,i,r;for(s=r=N(t);0!==s&&0===pt(t,s);)--s;if(0===s)return 0;if(4,s<=4&&E(t,4)<=y(1073741823,4)){for(i=0,e=s;e>=1;e+=-1)i=256*i+pt(t,e);return i}return s<r?f(t,s):t}function q(){var t,e,s,i;return e=h.stackIntegerValue(1),s=h.stackIntegerValue(0),h.success(h.isKindOfInteger(h.stackValue(2))),t=h.stackValue(2),h.failed()?null:(i=m("number"==typeof t?C(t):t,e,s)?h.trueObject():h.falseObject(),h.failed()||h.popthenPush(3,i),null)}function D(){var t,e;return h.success(h.isKindOfInteger(h.stackValue(0))),t=h.stackValue(0),h.failed()?null:"number"==typeof t?(e=C(t),h.failed()||h.popthenPush(2,e),null):(h.failed()||h.popthenPush(2,t),null)}function z(){var t;return t=h.trueObject(),h.failed()||h.popthenPush(1,t),null}function K(){var t,e,s,r;return h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),s=h.stackIntegerValue(0),h.failed()?null:(t="number"==typeof e?C(e):e,s>=0?(r=I(t,s),h.failed()||h.popthenPush(3,r),null):(r=M(O(t,0-s,i(t))),h.failed()||h.popthenPush(3,r),null))}function W(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.failed()?null:(s=x("number"==typeof t?C(t):t,"number"==typeof e?C(e):e),h.failed()||h.popthenPush(2,s),null)}function U(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.failed()?null:(s=x("number"==typeof t?C(t):t,"number"==typeof e?C(e):e),h.failed()||h.popthenPush(3,s),null)}function G(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.failed()?null:(s=w(t,e,c),h.failed()||h.popthenPush(2,s),null)}function H(){var t,e,s,i;return h.success(h.isKindOfInteger(h.stackValue(2))),t=h.stackValue(2),h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),s=h.stackIntegerValue(0),h.failed()?null:(i=w(t,e,s),h.failed()||h.popthenPush(4,i),null)}function J(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.failed()?null:(s=w(t,e,l),h.failed()||h.popthenPush(2,s),null)}function Y(){var t,e,s,r;return s=h.stackIntegerValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),h.failed()?null:(t="number"==typeof e?C(e):e,s>=0?(r=I(t,s),h.failed()||h.popthenPush(2,r),null):(r=M(O(t,0-s,i(t))),h.failed()||h.popthenPush(2,r),null))}function X(){var t,e,s,r;return s=h.stackIntegerValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),h.failed()?null:(t="number"==typeof e?C(e):e,s>=0?(r=I(t,s),h.failed()||h.popthenPush(2,r),null):(r=M(O(t,0-s,i(t))),h.failed()||h.popthenPush(2,r),null))}function $(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.failed()?null:(s=w(t,e,p),h.failed()||h.popthenPush(2,s),null)}function Z(){var t,e,s,i,r;return h.success(h.isKindOfInteger(h.stackValue(0))),i=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),h.failed()?null:"number"==typeof e?"number"==typeof i?(t=e)>(s=i)?(r=1,h.failed()||h.popthenPush(2,r),null):t<s?(r=-1,h.failed()||h.popthenPush(2,r),null):(r=0,h.failed()||h.popthenPush(2,r),null):(r=-1,h.failed()||h.popthenPush(2,r),null):"number"==typeof i?(r=1,h.failed()||h.popthenPush(2,r),null):(r=j(e,i),h.failed()||h.popthenPush(2,r),null)}function Q(){var t,e,s,i,r;return h.success(h.isKindOfInteger(h.stackValue(1))),s=h.stackValue(1),h.success(h.isKindOfInteger(h.stackValue(0))),i=h.stackValue(0),h.failed()?null:"number"==typeof s?"number"==typeof i?(t=s)>(e=i)?(r=1,h.failed()||h.popthenPush(3,r),null):t<e?(r=-1,h.failed()||h.popthenPush(3,r),null):(r=0,h.failed()||h.popthenPush(3,r),null):(r=-1,h.failed()||h.popthenPush(3,r),null):"number"==typeof i?(r=1,h.failed()||h.popthenPush(3,r),null):(r=j(s,i),h.failed()||h.popthenPush(3,r),null)}function tt(){var t,e,s,i,r,n;if(h.success(h.isKindOfInteger(h.stackValue(1))),i=h.stackValue(1),r=h.booleanValueOf(h.stackValue(0)),h.success(h.isKindOfInteger(h.stackValue(2))),e=h.stackValue(2),h.failed())return null;if(!_(e))return h.primitiveFail(),null;if(!_(i))return h.primitiveFail(),null;if(t="number"==typeof e?C(e):e,"number"==typeof i){if(0===i)return h.primitiveFail(),null;s=C(i)}else s=i;return n=V(t,s,r),h.failed()||h.popthenPush(3,n),null}function et(){var t,e,s,i,r,n;if(h.success(h.isKindOfInteger(h.stackValue(2))),s=h.stackValue(2),h.success(h.isKindOfInteger(h.stackValue(1))),i=h.stackValue(1),r=h.booleanValueOf(h.stackValue(0)),h.failed())return null;if(t="number"==typeof s?C(s):s,"number"==typeof i){if(0===i)return h.primitiveFail(),null;e=C(i)}else e=i;return n=V(t,e,r),h.failed()||h.popthenPush(4,n),null}function st(){var t,e,s,i;return h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),s=h.booleanValueOf(h.stackValue(0)),h.success(h.isKindOfInteger(h.stackValue(2))),t=h.stackValue(2),h.failed()?null:(i=F("number"==typeof t?C(t):t,"number"==typeof e?C(e):e,s),h.failed()||h.popthenPush(3,i),null)}function it(){var t,e,s,i;return h.success(h.isKindOfInteger(h.stackValue(2))),t=h.stackValue(2),h.success(h.isKindOfInteger(h.stackValue(1))),e=h.stackValue(1),s=h.booleanValueOf(h.stackValue(0)),h.failed()?null:(i=F("number"==typeof t?C(t):t,"number"==typeof e?C(e):e,s),h.failed()||h.popthenPush(4,i),null)}function rt(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.failed()?null:(s=T("number"==typeof t?C(t):t,"number"==typeof e?C(e):e),h.failed()||h.popthenPush(2,s),null)}function nt(){var t,e,s;return h.success(h.isKindOfInteger(h.stackValue(1))),t=h.stackValue(1),h.success(h.isKindOfInteger(h.stackValue(0))),e=h.stackValue(0),h.failed()?null:(s=T("number"==typeof t?C(t):t,"number"==typeof e?C(e):e),h.failed()||h.popthenPush(3,s),null)}function at(){var t,e,s,i;for(e=B().length,t=(i=h.instantiateClassindexableSize(h.classString(),e)).bytes,s=0;s<=e-1;s++)t[s]=B()[s];return h.failed()||h.popthenPush(1,i),null}function ot(){var t,e,s,i,r;return h.success(h.isKindOfInteger(h.stackValue(2))),e=h.stackValue(2),h.success(h.isKindOfInteger(h.stackValue(1))),s=h.stackValue(1),i=h.stackIntegerValue(0),h.success(h.isKindOfInteger(h.stackValue(3))),t=h.stackValue(3),h.failed()?null:(r=A("number"==typeof t?C(t):t,"number"==typeof e?C(e):e,"number"==typeof s?C(s):s,i),h.failed()||h.popthenPush(4,r),null)}function ct(){var t,e;return h.success(h.isKindOfInteger(h.stackValue(0))),t=h.stackValue(0),h.failed()?null:"number"==typeof t?(h.failed()||h.popthenPush(2,t),null):(e=M(t),h.failed()||h.popthenPush(2,e),null)}function ht(){var t,e;return h.success(h.stackValue(0).sqClass===h.classLargeNegativeInteger()),t=h.stackValue(0),h.failed()?null:(e=R(t),h.failed()||h.popthenPush(1,e),null)}function ut(){var t,e;return h.success(h.stackValue(0).sqClass===h.classLargePositiveInteger()),t=h.stackValue(0),h.failed()?null:(e=L(t),h.failed()||h.popthenPush(1,e),null)}function lt(s){return!1!=((h=s).majorVersion()==t)&&h.minorVersion()>=e}function pt(t,e){return t.bytes[e-1]}!function t(){"object"==typeof Squeak&&Squeak.registerExternalModule?Squeak.registerExternalModule("LargeIntegers",{primDigitAddWith:U,primDigitBitShiftMagnitude:X,primGetModuleName:at,primDigitBitLogicWithOp:H,primCheckIfCModuleExists:z,primDigitCompare:Z,primDigitMultiplyNegative:st,primDigitBitShift:Y,primNormalizePositive:ut,primDigitSubtractWith:nt,_primDigitBitShift:K,primDigitMultiplyWithNegative:it,primDigitSubtract:rt,primDigitDivNegative:tt,primNormalizeNegative:ht,primDigitBitOr:J,primMontgomeryTimesModulo:ot,primDigitBitAnd:G,primDigitDivWithNegative:et,setInterpreter:lt,primNormalize:ct,primDigitBitXor:$,primDigitCompareWith:Q,primDigitAdd:W,getModuleName:B,primAsLargeInteger:D,primAnyBitFromTo:q}):self.setTimeout(t,100)}()}(),Object.extend(Squeak.Interpreter.prototype,"syncProcess",{activeProcess:function(){return this.schedulerPointers||(this.schedulerPointers=this.specialObjects[3].pointers[1].pointers),this.schedulerPointers[1]},setIdleProcess:function(t){this.idleProcess=t},inIdleProcess:function(){return this.idleProcess===this.activeProcess()},handleUncaught:function(){if(this.uncaughtInstanceContext){var t=this.image.clone(this.uncaughtInstanceContext);t.pointers[0]=this.activeContext,Squeak.externalModules.CpSystemPlugin.newProcessForContext(t).run(),this.runInterpreter(!0)}}}),Object.extend(Squeak.Image.prototype,"fixes",{fixFloat:function(){this.origInitImmediateClasses=this.initImmediateClasses,this.initImmediateClasses=function(t,e,s){var i=t.get(e.get(s.oop)[9]);i.hash=34,i.classInstProto("Float"),this.origInitImmediateClasses(t,e,s)}}}),function t(){"object"==typeof Squeak&&Squeak.registerExternalModule?Squeak.registerExternalModule("CpSystemPlugin",{getModuleName:function(){return"CpSystemPlugin"},interpreterProxy:null,primHandler:null,setInterpreter:function(t){return this.interpreterProxy=t,this.vm=t.vm,this.primHandler=this.vm.primHandler,this.characterClass=this.vm.globalNamed("Character"),this.symbolClass=this.vm.globalNamed("Symbol"),this.symbolTable=Object.create(null),this.stringClass=this.vm.globalNamed("String"),this.byteStringClass=this.vm.globalNamed("ByteString"),this.wideStringClass=this.vm.globalNamed("WideString"),this.arrayClass=this.vm.globalNamed("Array"),this.byteArrayClass=this.vm.globalNamed("ByteArray"),this.wordArrayClass=this.vm.globalNamed("WordArray"),this.associationClass=this.vm.globalNamed("Association"),this.dictionaryClass=this.vm.globalNamed("Dictionary"),this.orderedDictionaryClass=this.vm.globalNamed("OrderedDictionary"),this.largePositiveIntegerClass=this.vm.globalNamed("LargePositiveInteger"),this.largeNegativeIntegerClass=this.vm.globalNamed("LargeNegativeInteger"),this.contextClass=this.vm.globalNamed("Context"),this.processClass=this.vm.globalNamed("Process"),this.scheduler=this.primHandler.getScheduler(),this.syncProcessPriority=this.scheduler.pointers[0].pointersSize(),this.globalProxyClasses={},this.lastException=null,this.updateStringSupport(),this.updateMakeStObject(),this.updateMakeStArray(),!0},makeProcessSynchronous:function(t){var e=this;t.isSync=!0,t.run=function(){var s=e.scheduler.pointers[1],i=e.primHandler;if(s!==t){var r=s.pointers[2],n=e.scheduler.pointers[0].pointers[r-1];if(i.isEmptyList(n))n.pointers[1]=s;else{var a=n.pointers[0];s.pointers[0]=a}n.pointers[0]=s,n.dirty=!0,s.pointers[3]=n,s.dirty=!0,i.transferTo(t)}e.vm.runInterpreter(!0)}},newProcessForContext:function(t){var e=this.vm.instantiateClass(this.processClass,0);return e.pointers[2]=this.syncProcessPriority,e.pointers[1]=t,e.dirty=!0,this.makeProcessSynchronous(e),e},signalSemaphoreWithIndex:function(t){this.primHandler.signalSemaphoreWithIndex(t),this.vm.runInterpreter(!0)},updateStringSupport:function(){this.stringClass.classInstProto().prototype.asString=function(){for(var t=[],e=this.bytes||this.words||[],s=0;s<e.length;)t.push(String.fromCodePoint.apply(null,e.subarray(s,s+=16348)));return t.join("")};var t=this;Squeak.Primitives.prototype.makeStString=function(e){for(var s=!1,i=Array.from(e).map((function(t){var e=t.codePointAt(0);return e>=256&&(s=!0),e})),r=t.vm.instantiateClass(s?t.wideStringClass:t.byteStringClass,i.length),n=r.bytes||r.words||[],a=0;a<i.length;a++)n[a]=i[a];return r}},updateMakeStObject:function(){var t=this,e=this.vm.image.version>=68e3;this.minSmallInteger=e?Number.MIN_SAFE_INTEGER:-1073741824,this.maxSmallInteger=e?Number.MAX_SAFE_INTEGER:1073741823,this.primHandler.makeStObject=function(e,s,i){if(null==e)return this.vm.nilObj;if(!0===e)return this.vm.trueObj;if(!1===e)return this.vm.falseObj;if(e.sqClass)return e;if(e.constructor===Number){if(Number.isInteger(e)){if(e>t.maxSmallInteger||e<t.minSmallInteger){var r=e<0;r&&(e=-e);for(var n=[],a=0;e>0;){var o=255&e;n[a++]=o,e=(e-o)/256}var c=this.vm.instantiateClass(this.vm.specialObjects[r?42:13],n.length);return c.bytes=n,c}return e}return this.makeFloat(e)}var h;if(i=i||[],void 0!==(h=t.findSeenObj(i,e)))return h;if(e.substring)return t.addSeenObj(i,e,this.makeStString(e));if(e.slice&&void 0!==e.length){if(!e.BYTES_PER_ELEMENT)return t.addSeenObj(i,e,this.makeStArray(e,s,i));if(e.constructor===Float32Array||e.constructor===Float64Array)return t.addSeenObj(i,e,this.makeStArray(e,null,i));switch(e.BYTES_PER_ELEMENT){case 1:return t.addSeenObj(i,e,this.makeStByteArray(e));case 2:case 4:return t.addSeenObj(i,e,t.makeStWordArray(e));default:return console.error("No support for TypedArrays with bytes per element: "+e.BYTES_PER_ELEMENT,e),this.vm.nilObj}}return e.constructor===Object&&!t.hasFunctions(e)||void 0===e.constructor&&"object"==typeof e?t.makeStOrderedDictionary(e,i):(s||(s=t.getProxyClassFor(e)),s?((h=this.vm.instantiateClass(s,0)).jsObj=e,t.addSeenObj(i,e,h)):(console.error("Can't create Smalltalk object for the following object (answering nil)",e),this.vm.nilObj))}},updateMakeStArray:function(){var t=this;this.primHandler.makeStArray=function(e,s,i){i=i||[];var r=t.findSeenObj(i,e);if(void 0!==r)return r;var n=this.vm.instantiateClass(t.arrayClass,e.length);i.push({jsObj:e,stObj:n});for(var a=0;a<e.length;a++)n.pointers[a]=this.makeStObject(e[a],s,i);return n.dirty=e.length>0,n}},makeStWordArray:function(t){for(var e=this.vm.instantiateClass(this.wordArrayClass,t.length),s=0;s<t.length;s++)e.words[s]=4294967295&t[s];return e},makeStAssociation:function(t,e,s){var i;s=s||[],t&&!t.sqClass&&void 0!==(i=this.findSeenObj(s,t))&&(t=i),e&&!e.sqClass&&void 0!==(i=this.findSeenObj(s,e))&&(e=i);var r=this.vm.instantiateClass(this.associationClass,0);return r.pointers[0]=this.primHandler.makeStObject(t,void 0,s),r.pointers[1]=this.primHandler.makeStObject(e,void 0,s),r.dirty=!0,r},makeStOrderedDictionary:function(t,e){e=e||[];var s=this.findSeenObj(e,t);if(void 0!==s)return s;var i=this.vm.instantiateClass(this.orderedDictionaryClass,0);e.push({jsObj:t,stObj:i});var r=this.makeStDictionary(t,[]);i.pointers[0]=r;var n=this.primHandler.makeStArray(Object.keys(t),void 0,e);return i.pointers[1]=n,i.dirty=Object.keys(t).length>0,i},makeStDictionary:function(t,e){e=e||[];var s=this.findSeenObj(e,t);if(void 0!==s)return s;var i=this.vm.instantiateClass(this.dictionaryClass,0);e.push({jsObj:t,stObj:i});var r=Object.keys(t),n=Math.floor(4*(r.length+1)/3),a=Array(n).fill(null),o=this;return r.forEach((function(s){for(var i=o.makeStAssociation(s,t[s],e),r=o.stringHash(Array.from(s).map((function(t){return t.codePointAt(0)})))%n,c=r,h=!1;!h&&c<n;)null===a[c]?h=!0:c++;if(!h)for(c=0;!h&&c<r;)null===a[c]?h=!0:c++;a[c]=i})),i.pointers[0]=r.length,i.pointers[1]=this.primHandler.makeStArray(a,void 0,e),i.dirty=r.length>0,i},findSeenObj:function(t,e){var s=t.find((function(t){return t.jsObj===e}));if(void 0!==s)return s.stObj},addSeenObj:function(t,e,s){return t.push({jsObj:e,stObj:s}),s},hasFunctions:function(t){return Object.keys(t).some((function(t){return t&&t.apply}))},answer:function(t,e){return this.interpreterProxy.popthenPush(t+1,this.primHandler.makeStObject(e)),!0},answerSelf:function(t){return this.interpreterProxy.pop(t),!0},asJavaScriptObject:function(t){return t.isNil?null:!!t.isTrue||!t.isFalse&&("number"==typeof t?t:t.isFloat?t.float:t.jsObj?t.jsObj:this.isKindOf(t.sqClass,this.stringClass)?t.asString():t.sqClass===this.arrayClass?this.arrayAsJavaScriptObject(t):this.isKindOf(t.sqClass,this.orderedDictionaryClass)?this.orderedDictionaryAsJavaScriptObject(t):this.isKindOf(t.sqClass,this.dictionaryClass)?this.dictionaryAsJavaScriptObject(t):t.domElement?t.domElement:this.isKindOf(t.sqClass,this.contextClass)?this.contextAsJavaScriptFunction(t):t.sqClass===this.largePositiveIntegerClass?this.largeInteger(t):t.sqClass===this.largeNegativeIntegerClass?-this.largeInteger(t):t.bytes?t.bytes:t.words?t.words:t)},arrayAsJavaScriptObject:function(t){var e=this;return(t.pointers||[]).map((function(t){return e.asJavaScriptObject(t)}))},orderedDictionaryAsJavaScriptObject:function(t){var e=this.dictionaryAsJavaScriptObject(t.pointers[0]);return this.arrayAsJavaScriptObject(t.pointers[1]).reduce((function(t,s){return t[s]=e[s],t}),{})},dictionaryAsJavaScriptObject:function(t){var e=this,s=t.pointers.find((function(t){return t&&t.sqClass===e.arrayClass}));if(!s||!s.pointers||!s.pointers.forEach)throw Error("Dictionary has unexpected structure");var i={};return s.pointers.forEach((function(t){t.isNil||(i[e.asJavaScriptObject(t.pointers[0])]=e.asJavaScriptObject(t.pointers[1]))})),i},contextAsJavaScriptFunction:function(t){var e=this,s=function(...i){var r=e.vm.image.clone(t),n=i.map((function(t){return e.primHandler.makeStObject(t)}));s.__cp_func_arguments=n,e.newProcessForContext(r).run(),e.vm.deferRunInterpreter();var a,o,c=s.__cp_func_result;if(void 0===c&&(c=s.__cp_func_result=new Promise((function(t,e){a=t,o=e})),s.__cp_func_result.__cp_resolve=a,s.__cp_func_result.__cp_reject=o),c instanceof Error&&c.cause&&c.cause.sqClass)throw c;return c};return s},isKindOf:function(t,e){for(;t&&!t.isNil;){if(t===e)return!0;t=t.superclass()}return!1},largeInteger:function(t){for(var e=0,s=t.bytes||[],i=s.length,r=0,n=1;r<i;r++,n*=256)e+=s[r]*n;return e},smalltalkPerform:function(t,e,s){if(void 0===Function.smalltalkPerformer)return console.warn("No Smalltalk performer installed yet!"),void console.log("When trying to perform:",arguments);Function.smalltalkPerformer(t,e.sqClass?e:this.symbolFromString(e.toString()),s??[])},"primitiveObjectTraceCr:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return console.log((new Date).toISOString()+" "+e),this.answerSelf(t)},"primitiveObjectWarnCr:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return console.warn((new Date).toISOString()+" "+e),this.answerSelf(t)},"primitiveObjectErrorCr:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return console.error((new Date).toISOString()+" "+e),this.answerSelf(t)},primitiveProcessBeIdleProcess:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return this.vm.setIdleProcess(e),this.answerSelf(t)},primitiveProcessIsSyncProcess:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return this.answer(t,!!e.isSync)},primitiveProcessAllowAwaitPromise:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return this.answer(t,!e.failOnAwait)},symbolFromString:function(t){var e=this.symbolTable[t];if(void 0!==e)return e;for(var s=this.vm.instantiateClass(this.symbolClass,t.length),i=0;i<t.length;i++)s.bytes[i]=255&t.charCodeAt(i);return this.symbolTable[t]=s,s},"primitiveSymbolRegister:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.asString();if(this.symbolTable[s])throw Error("Registered non-unique Symbol: "+s);return this.symbolTable[s]=e,this.answerSelf(t)},"primitiveSymbolFromString:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return this.answer(t,this.symbolFromString(e))},"primitiveSymbolEquals:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=this.interpreterProxy.stackValue(1),i=e===s;if(!i){var r=s.bytes||s.words||[],n=e.bytes||e.words||[];if(r.length===n.length){var a=0;for(i=!0;a<r.length&&i;)r[a]!==n[a]?i=!1:a++}}return this.answer(t,i)},primitiveSymbolIsLiteralSymbol:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.bytes||e.words||[],i=1,r=s.length>0;if(r){var n=function(t){return t>=65&&t<=90||t>=97&&t<=122},a=function(t){return[33,37,38,42,43,44,45,47,60,61,62,63,64,92,96,124,215,247].indexOf(t)>=0||t>=126&&t<=191&&[170,181,186].indexOf(t)<0},o=n(s[0])?function(t){return n(t)||function(t){return t>=48&&t<=57}(t)||function(t){return 58===t}(t)}:a(s[0])?function(t){return a(t)}:null;for(r=null!==o;i<s.length&&r;)r=o(s[i]),i++}return this.answer(t,r)},primitiveByteArrayAsString:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return this.answer(t,e.asString())},"primitiveNumberRaisedTo:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=null;return e.isFloat?i=e.float:"number"==typeof e&&(i=e),null!==i&&this.answer(t,Math.pow(i,s))},primitiveNumberPrintString:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=null;return e.isFloat?s=e.float:"number"==typeof e&&(s=e),null!==s&&this.answer(t,s.toString())},"primitiveNumberPrintStringBase:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0);if("number"!=typeof e||e<2||e>36)return!1;var s=this.interpreterProxy.stackValue(1),i=null;return s.isFloat?10===e&&(i=s.float.toString()):"number"==typeof s&&(i=s.toString(e)),null!==i&&this.answer(t,10!==e?e+"r"+i:i)},primitiveIntegerAtRandom:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return"number"==typeof e&&this.answer(t,Math.floor(Math.random()*(e-1)+1))},"primitiveStringFromWordArray:":function(t){if(1!==t)return!1;for(var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0).words||[],i=this.vm.instantiateClass(e,s.length),r=i.bytes||i.words,n=0;n<s.length;n++)r[n]=s[n];return this.answer(t,i)},"primitiveStringConcatenate:":function(t){if(1!==t)return!1;for(var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=e.bytes||e.words||[],r=s.bytes||s.words||[],n=e.words||s.words||!1,a=this.vm.instantiateClass(n?this.wideStringClass:this.byteStringClass,i.length+r.length),o=a.bytes||a.words,c=0;c<i.length;c++)o[c]=i[c];for(var h=0;h<r.length;h++,c++)o[c]=r[h];return this.answer(t,a)},"primitiveStringAsciiCompare:":function(t){if(1!==t)return!1;for(var e=this.interpreterProxy.stackValue(0),s=this.interpreterProxy.stackValue(1),i=s.bytes||s.words||[],r=e.bytes||e.words||[],n=Math.min(i.length,r.length),a=0;a<n;a++){var o=i[a]-r[a];if(o>0)return this.answer(t,3);if(o<0)return this.answer(t,1)}return i.length>n?this.answer(t,3):r.length>n?this.answer(t,1):this.answer(t,2)},primitiveStringAsUppercase:function(t){if(0!==t)return!1;for(var e=this.interpreterProxy.stackValue(0),s=e.bytes||e.words||[],i=this.vm.instantiateClass(e.sqClass,s.length),r=e.bytes?i.bytes:i.words,n=0;n<s.length;n++)r[n]=String.fromCodePoint(s[n]).toUpperCase().codePointAt(0);return this.answer(t,i)},primitiveStringAsLowercase:function(t){if(0!==t)return!1;for(var e=this.interpreterProxy.stackValue(0),s=e.bytes||e.words||[],i=this.vm.instantiateClass(e.sqClass,s.length),r=e.bytes?i.bytes:i.words,n=0;n<s.length;n++)r[n]=String.fromCodePoint(s[n]).toLowerCase().codePointAt(0);return this.answer(t,i)},primitiveStringAsNumber:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=null;if("NaN"===e)s=Number.NaN;else if("Infinity"===e)s=Number.POSITIVE_INFINITY;else if("-Infinity"===e)s=Number.NEGATIVE_INFINITY;else{var i=e.match(/^(\d+r)?(-?\d+(?:\.\d+)?(?:e-?\d)?)$/);if(i)if(i[1]){var r=Number.parseInt(i[1]);r>=2&&r<=36&&i[2].indexOf(".")<0&&i[2].indexOf("e")<0&&(s=Number.parseInt(i[2],r))}else s=+i[2]}return null!==s&&this.answer(t,s)},"primitiveStringFindTokens:":function(t){if(1!==t)return!1;for(var e=this.interpreterProxy.stackValue(1),s=e.bytes||e.words||[],i=this.interpreterProxy.stackValue(0),r=i.bytes||i.words||[],n=[],a=0;a<s.length;){var o=this.skipDelimiters(s,r,a);o<(a=this.findDelimiters(s,r,o))&&n.push(this.createSubstring(s,o,a))}return this.answer(t,n)},"primitiveStringIndexOf:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=this.interpreterProxy.stackValue(1).asString();return this.answer(t,e.sqClass===this.characterClass?s.indexOf(String.fromCodePoint(e.hash))+1:0)},"primitiveStringIncludesSubstring:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString(),s=this.interpreterProxy.stackValue(0).asString();return this.answer(t,e.indexOf(s)>=0)},primitiveStringHash:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.bytes||e.words||[],i=this.stringHash(s);return this.answer(t,i)},primitiveStringTrim:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return this.answer(t,e.trim())},primitiveStringTrimLeft:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return this.answer(t,e.trimStart())},primitiveStringTrimRight:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return this.answer(t,e.trimEnd())},skipDelimiters:function(t,e,s){for(;s<t.length;s++)if(e.indexOf(t[s])<0)return s;return t.length+1},findDelimiters:function(t,e,s){for(;s<t.length;s++)if(e.indexOf(t[s])>=0)return s;return t.length+1},createSubstring:function(t,e,s){for(var i=t.slice(e,s),r=i.some((function(t){return t>=256})),n=this.vm.instantiateClass(r?this.wideStringClass:this.byteStringClass,i.length),a=n.bytes||n.words||[],o=0;o<i.length;o++)a[o]=i[o];return n},stringHash:function(t){for(var e=13312,s=0;s<t.length;s++){var i=16383&(e+=t[s]);e=9741*i+16384*(9741*Math.floor(e/16384)+101*i&16383)&268435455}return e},"primitiveWideStringFrom:":function(t){if(1!==t)return!1;for(var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=s.bytes||s.words||[],r=this.vm.instantiateClass(e,i.length),n=r.words,a=0;a<i.length;a++)n[a]=i[a];return this.answer(t,r)},"primitiveJavaScriptObjectRegisterProxyClass:forClassName:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1);if(e.isNil)return!1;var s=this.interpreterProxy.stackValue(0).asString();return!!s&&(this.globalProxyClasses[s]=e,Function.prototype.applyPassThrough||(Function.prototype.applyPassThrough=function(t,e){return this.apply(t,e)}),this.answerSelf(t))},getProxyClassFor:function(t){var e=t&&t.constructor;if(!e)return null;var s=Object.keys(this.globalProxyClasses);if(0===s.length)return null;for(var i=void 0;e;)i=s.find((function(t){return e.__cp_className===t||globalThis[t]===e})),e=i?null:Object.getPrototypeOf(e);return i||(i="Object"),this.globalProxyClasses[i]},"primitiveJavaScriptObjectApply:withArguments:resultAs:":function(t){if(3!==t)return!1;var e=this.interpreterProxy.stackValue(3).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(2).asString();if(!s)return!1;var i=e.constructor===Function&&"applyPassThrough"===s?[null,this.interpreterProxy.stackValue(1).pointers[1].pointers.map((function(t){return t}))]:this.asJavaScriptObject(this.interpreterProxy.stackValue(1))||[],r=this.interpreterProxy.stackValue(0),n=void 0;try{this.lastException=null;var a=e[s];if(a&&a.apply)n=a.apply(e,i);else{var o=this.getSelectorNamed(e,s);if(!o){var c=s.indexOf(":");c>0&&(o=this.getSelectorNamed(e,s.slice(0,c)))}if(!o)return!1;if(o.get&&0===i.length)n=o.get.apply(e);else if(o.set&&1===i.length)n=o.set.apply(e,i);else if(o.value&&o.value.constructor===Function)n=o.value.apply(e,i);else{if(void 0===o.writable)return!1;0===i.length?n=o.value:1===i.length&&o.writable&&(n=e[s]=i[0])}}}catch(t){return this.lastException=t,!1}if(null!=n&&!r.isNil){var h=this.vm.instantiateClass(r,0);h.jsObj=n,n=h}return this.answer(t,n)},"primitiveJavaScriptObjectLastExceptionAs:":function(t){if(1!==t)return!1;var e=this.lastException;if(null!==e){var s=this.getProxyClassFor(e);s&&s!==this.globalProxyClasses.Object||(s=this.interpreterProxy.stackValue(0));var i=this.vm.instantiateClass(s,0);i.jsObj=e,e=i,this.lastException=null}return this.answer(t,e)},"primitiveJavaScriptObjectPropertyAt:resultAs:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(1).asString(),i=this.interpreterProxy.stackValue(0),r=e[s];if(null!=r&&!i.isNil){var n=this.vm.instantiateClass(i,0);n.jsObj=r,r=n}return this.answer(t,r)},"primitiveJavaScriptObjectPropertyAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(1).asString(),i=this.asJavaScriptObject(this.interpreterProxy.stackValue(0));return e[s]=i,this.answerSelf(t)},"primitiveJavaScriptObjectRawPropertyAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1).jsObj;if(void 0===e)return!1;var s=e[this.interpreterProxy.stackValue(0).asString()];return null==s||s.isNil?(this.interpreterProxy.popthenPush(t+1,this.vm.nilObj),!0):!!(s.sqClass||"number"==typeof s&&s>=this.minSmallInteger&&s<=this.maxSmallInteger)&&(this.interpreterProxy.popthenPush(t+1,s),!0)},"primitiveJavaScriptObjectRawPropertyAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(1).asString(),i=this.interpreterProxy.stackValue(0);return e[s]=i,this.answerSelf(t)},primitiveJavaScriptObjectGetSelectorNames:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).jsObj;if(void 0===e)return!1;for(var s=Object.create(null);e;)Object.getOwnPropertyNames(e).forEach((function(t){s[t]=!0})),e=Object.getPrototypeOf(e);return this.answer(t,Object.keys(s))},"primitiveJavaScriptObjectGetSelectorType:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(0).asString();if(!s)return!1;var i=this.getSelectorNamed(e,s);if(!i)return this.answer(t,null);var r=void 0;return r=i.get?i.set?"read-write-prop":"read-prop":i.set?"write-prop":void 0!==i.writable?i.value&&i.value.constructor===Function?"function":i.writable?"read-write-attr":"read-attr":"unknown",this.answer(t,this.symbolFromString(r))},"primitiveJavaScriptObjectGetClassRefFrom:resultAs:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).jsObj;if(void 0===e)return!1;var s=this.interpreterProxy.stackValue(1).asString();if(!s)return!1;var i=this.interpreterProxy.stackValue(0);if(i.isNil)return!1;var r=e[s];if(!r)return!1;var n=this.vm.instantiateClass(i,0);return n.jsObj=r,this.answer(t,n)},getSelectorNamed:function(t,e){for(var s=void 0;t&&!s;)(s=Object.getOwnPropertyDescriptor(t,e))||(t=Object.getPrototypeOf(t));return s},"primitiveJavaScriptClassNewInstanceWithArguments:resultAs:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).jsObj,s=this.asJavaScriptObject(this.interpreterProxy.stackValue(1))||[],i=this.interpreterProxy.stackValue(0),r=void 0;try{var n=Reflect.construct(e,s);(r=this.vm.instantiateClass(i.isNil?this.getProxyClassFor(n):i,0)).jsObj=n}catch(t){console.error("Failed to instantiate class "+e,t)}return this.answer(t,r)},"primitiveJavaScriptFunctionArguments:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=this.interpreterProxy.stackValue(1).jsObj;if(!s)return!1;for(var i=s.__cp_func_arguments.slice(0,e);i.length<e;)i.push(null);return this.answer(t,i)},"primitiveJavaScriptFunctionSetBlock:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0);return e.__cp_block=s,this.answerSelf(t)},primitiveJavaScriptFunctionBlock:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return this.answer(t,e.__cp_block)},"primitiveJavaScriptFunctionSetResult:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1).jsObj;if(!e)return!1;var s=this.asJavaScriptObject(this.interpreterProxy.stackValue(0));return e.__cp_func_result&&e.__cp_func_result.__cp_resolve?s instanceof Error&&s.cause&&s.cause.sqClass?e.__cp_func_result.__cp_reject(s):e.__cp_func_result.__cp_resolve(s):e.__cp_func_result=s,this.answerSelf(t)},primitiveJavaScriptFunctionValue:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).jsObj;if(!e)return!1;try{return this.answer(t,e())}catch(t){return this.lastException=t,!1}},"primitiveJavaScriptFunctionValue:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.asJavaScriptObject(this.interpreterProxy.stackValue(0)),i=e.jsObj;if(!i)return!1;try{return this.answer(t,i(s))}catch(t){return this.lastException=t,!1}},"primitiveJavaScriptFunctionValue:value:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2),s=this.asJavaScriptObject(this.interpreterProxy.stackValue(1)),i=this.asJavaScriptObject(this.interpreterProxy.stackValue(0)),r=e.jsObj;if(!r)return!1;try{return this.answer(t,r(s,i))}catch(t){return this.lastException=t,!1}},"primitiveJavaScriptFunctionValue:value:value:":function(t){if(3!==t)return!1;var e=this.interpreterProxy.stackValue(3),s=this.asJavaScriptObject(this.interpreterProxy.stackValue(2)),i=this.asJavaScriptObject(this.interpreterProxy.stackValue(1)),r=this.asJavaScriptObject(this.interpreterProxy.stackValue(0)),n=e.jsObj;if(!n)return!1;try{return this.answer(t,n(s,i,r))}catch(t){return this.lastException=t,!1}},"primitiveJavaScriptFunctionValueWithArguments:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.asJavaScriptObject(this.interpreterProxy.stackValue(0)),i=e.jsObj;if(!i)return!1;try{return this.answer(t,i(...s))}catch(t){return this.lastException=t,!1}},"primitiveJavaScriptPromiseThen:onRejected:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2),s=this.interpreterProxy.stackValue(1),i=this.interpreterProxy.stackValue(0),r=e.jsObj.then(this.asJavaScriptObject(s),this.asJavaScriptObject(i));return this.promiseAttachSenderMethod(r,e),this.answer(t,r)},"primitiveJavaScriptPromiseCatch:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=e.jsObj.catch(this.asJavaScriptObject(s));return this.promiseAttachSenderMethod(i,e),this.answer(t,i)},"primitiveJavaScriptPromiseFinally:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=e.jsObj.finally(this.asJavaScriptObject(s));return this.promiseAttachSenderMethod(i,e),this.answer(t,i)},promiseAttachSenderMethod:function(t,e){var s,i=e.sqClass,r=e.jsObj,n=this.vm.activeContext;do{if(!(n=n.pointers[0])||n.isNil)return void(r.__cp_compiled_code&&(t.__cp_compiled_code=r.__cp_compiled_code));if(!(s=n.pointers[3])||s.isNil||!s.methodClassForSuper)return void(r.__cp_compiled_code&&(t.__cp_compiled_code=r.__cp_compiled_code))}while(s.methodClassForSuper()===i);t.__cp_compiled_code=s},primitiveJavaScriptErrorUncaughtObject:function(t){if(0!==t)return!1;var e=globalThis.__cp_uncaught;return delete globalThis.__cp_uncaught,this.answer(t,e)},"primitiveJavaScriptErrorRegisterUncaughtInstanceContext:":function(t){return 1===t&&(this.vm.uncaughtInstanceContext=this.interpreterProxy.stackValue(0),this.answerSelf(t))},"primitiveEnvironmentVariableAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=globalThis.sessionStorage.getItem(e);return this.answer(t,s)},"primitiveEnvironmentVariableAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(0).asString();return!!s&&(globalThis.sessionStorage.setItem(e,s),this.answerSelf(t))},primitiveEnvironmentVariableNames:function(t){if(0!==t)return!1;for(var e=new Array(globalThis.sessionStorage.length),s=0;s<globalThis.sessionStorage.length;s++)e[s]=globalThis.sessionStorage.key(s);return this.answer(t,e)},"primitiveEnvironmentRemoveVariableAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return!!e&&(globalThis.sessionStorage.removeItem(e),this.answerSelf(t))},"primitiveEnvironmentPersistentVariableAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=globalThis.localStorage.getItem(e);return this.answer(t,s)},"primitiveEnvironmentPersistentVariableAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(0).asString();return!!s&&(globalThis.localStorage.setItem(e,s),this.answerSelf(t))},"primitiveEnvironmentRemovePersistentVariableAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return!!e&&(globalThis.localStorage.removeItem(e),this.answerSelf(t))},"primitiveEnvironmentAlert:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return globalThis.alert?globalThis.alert(e):console.warn(e),this.answerSelf(t)},"primitiveEnvironmentConfirm:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();return!!globalThis.confirm&&this.answer(t,!0===globalThis.confirm(e))},"primitiveEnvironmentGlobalApply:withArguments:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.asJavaScriptObject(this.interpreterProxy.stackValue(0))||[],i=globalThis[e];if(!i||!i.apply)return!1;var r=void 0;try{r=i.apply(globalThis,s)}catch(t){console.error("Failed to perform apply:withArguments on global object:",t,"Selector:",e,"Arguments:",s)}return this.answer(t,r)},primitiveEnvironmentReload:function(t){return 0===t&&"undefined"!=typeof window&&(window.document.location.reload(!0),this.answerSelf(t))},"primitiveWebSocketConnectToUrl:withEventSemaphore:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2),s=this.interpreterProxy.stackValue(1).asString(),i=this.interpreterProxy.stackIntegerValue(0);return e.webSocketHandle={webSocket:new WebSocket(s),url:s,semaIndex:i,buffers:[]},this.setupWebSocket(e.webSocketHandle),this.answerSelf(t)},setupWebSocket:function(t){var e=this,s=t.webSocket;s.onopen=function(){e.signalSemaphoreWithIndex(t.semaIndex)},s.onclose=function(){e.signalSemaphoreWithIndex(t.semaIndex)},s.onerror=function(s){console.error("Failure on WebSocket for url ["+t.url+"]: ",s),e.signalSemaphoreWithIndex(t.semaIndex)},s.onmessage=function(s){new Response(s.data).arrayBuffer().then((function(s){t.buffers.push(new Uint8Array(s)),e.signalSemaphoreWithIndex(t.semaIndex),e.vm.forceInterruptCheck()})).catch((function(s){console.error("Failed to read websocket message",s),e.signalSemaphoreWithIndex(t.semaIndex)}))}},primitiveWebSocketReceivedMessage:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).webSocketHandle;if(!e)return!1;var s=e.buffers.splice(0,1)[0],i=s?this.primHandler.makeStByteArray(s):this.vm.nilObj;return this.answer(t,i)},"primitiveWebSocketSend:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackObjectValue(0),i=e.webSocketHandle;if(!i)return!1;var r=!1;if(1===i.webSocket.readyState)try{i.webSocket.send(s.bytes),r=!0}catch(t){console.error("Failed to write websocket message",t),this.signalSemaphoreWithIndex(i.semaIndex)}return this.answer(t,r)},primitiveWebSocketReadyState:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).webSocketHandle;if(!e)return!1;var s=e.webSocket.readyState;return this.answer(t,s)},primitiveWebSocketClose:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).webSocketHandle;if(!e)return!1;var s=!1;try{e.webSocket&&(e.webSocket.close(),s=!0)}catch(t){console.error("Failed to close websocket",t),this.signalSemaphoreWithIndex(e.semaIndex)}return this.answer(t,s)}}):globalThis.setTimeout(t,100)}(),function t(){"object"==typeof Squeak&&Squeak.registerExternalModule?Squeak.registerExternalModule("CpDOMPlugin",{getModuleName:function(){return"CpDOMPlugin"},interpreterProxy:null,primHandler:null,customTagMap:{},nestedTags:{},customElementClassMappers:[],eventClassMap:{},eventsReceived:[],throttleEventTypes:["pointermove","touchmove","wheel","gesturechange"],transitionStartTick:performance.now(),elementsToInitialize:[],namespaces:[{prefix:"xlink",uri:"http://www.w3.org/1999/xlink",elementClass:null},{prefix:"xmlns",uri:"http://www.w3.org/2000/xmlns/",elementClass:null}],domElementMap:new WeakMap,setInterpreter:function(t){return this.interpreterProxy=t,this.vm=t.vm,this.primHandler=this.vm.primHandler,this.pointClass=this.vm.globalNamed("Point"),this.domElementClass=null,this.domRectangleClass=null,this.systemPlugin=Squeak.externalModules.CpSystemPlugin,this.updateMakeStObject(),this.runUpdateProcess(),!0},answer:function(t,e){return this.interpreterProxy.popthenPush(t+1,this.primHandler.makeStObject(e)),!0},answerSelf:function(t){return this.interpreterProxy.pop(t),!0},updateMakeStObject:function(){if(!this.originalMakeStObject){var t=this;this.originalMakeStObject=this.primHandler.makeStObject,this.primHandler.makeStObject=function(e,s,i){if(null!=e){if(e.querySelectorAll)return t.instanceForElement(e);if(void 0!==e.bubbles&&e.currentTarget&&t.eventClassMap[e.type]){let s=t.eventClassMap[e.type],i=t.vm.instantiateClass(s,0);return i.event=e,i}}return t.originalMakeStObject.call(this,e,s,i)},window.document.localName="document"}},namespaceForURI:function(t){return this.namespaces.find((function(e){return e.uri===t}))},namespaceForPrefix:function(t){return this.namespaces.find((function(e){return e.prefix===t}))},namespaceURIFromName:function(t){var e=t.indexOf(":");if(e<0)return null;var s=t.slice(0,e);return this.namespaceForPrefix(s)},tagNameFromClass:function(t){var e=t.className();return"CpView"===e?"cp-view":e.replace(/View$/,"").replace(/([a-z])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z][a-z])/g,"$1-$2").replace(/^([A-Za-z0-9]*)$/,"x-$1").toLowerCase()},initializePendingElements:function(){if(this.initializeRunner){window.clearTimeout(this.initializeRunner);var t=this.elementsToInitialize;this.elementsToInitialize=[],this.initializeRunner=null;var e=this;t.forEach((function(t){e.systemPlugin.smalltalkPerform(e.instanceForElement(t),"initialize")}))}},getPointX:function(t){return t.pointers[0]},getPointY:function(t){return t.pointers[1]},getDomElementClass:function(){return this.domElementClass||(this.domElementClass=this.vm.globalNamed("CpDomElement")),this.domElementClass},getDomRectangleClass:function(){return this.domRectangleClass||(this.domRectangleClass=this.vm.globalNamed("CpDomRectangle")),this.domRectangleClass},addElementClassMapper:function(t){this.customElementClassMappers.push(t)},instanceForElement:function(t){if(!t)return null;if(t.__cp_element)return t.__cp_element;var e=this.domElementMap.get(t);if(void 0===e){var s=this.customTagMap[t.localName];if(s||this.customElementClassMappers.some((function(e){return null!==(s=e(t))})),!s){var i=this.namespaceForURI(t.namespaceURI);s=i?i.elementClass:this.getDomElementClass()}(e=this.vm.instantiateClass(s,0)).domElement=t,this.domElementMap.set(t,e)}return e},makeDomRectangle:function(t){let e=this.getDomRectangleClass(),s=this.vm.instantiateClass(e,0),i=this.primHandler;return e.allInstVarNames().forEach((function(e,r){void 0!==t[e]&&(s.pointers[r]=i.makeStObject(t[e]),s.dirty=!0)})),s},"primitiveDomElementRegisterNamespace:forPrefix:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(0).asString();if(!s)return!1;if(this.namespaceForPrefix(s))return console.error("The prefix "+s+" is already installed in the browser"),!1;var i=this.interpreterProxy.stackValue(2);return this.namespaces.push({prefix:s,uri:e,elementClass:i}),this.answerSelf(t)},"primitiveDomElementNewWithTag:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=e.indexOf(":"),i=s>=0?e.slice(0,s):e;s>=0&&"xmlns"!==i&&(e=e.slice(s+1));var r,n=this.namespaceForPrefix(i);if(n&&"xhtml"!==i)r=window.document.createElementNS(n.uri,e);else{var a=window.customElements.get(e);r=a?a.stClass?new a(!0):new a:window.document.createElement(e)}return this.initializePendingElements(),this.answer(t,this.instanceForElement(r))},primitiveDomElementDocument:function(t){return 0===t&&this.answer(t,this.instanceForElement(window.document))},"primitiveDomElementElementsFromPoint:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0);if(e.sqClass!==this.pointClass)return!1;var s=this,i=window.document.elementsFromPoint(this.getPointX(e),this.getPointY(e)).map((function(t){return s.instanceForElement(t)}));return this.answer(t,i)},"primitiveDomElementElementWithId:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;if(!s||void 0===s.activeElement)return!1;var i=s.getElementById(e);return this.answer(t,this.instanceForElement(i))},"primitiveDomElementAllDescendantsMatching:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;if(!s)return!1;var i=this,r=Array.from(s.querySelectorAll(e)).map((function(t){return i.instanceForElement(t)}));return this.answer(t,r)},"primitiveDomElementFirstDescendantMatching:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;if(!s)return!1;var i=s.querySelector(e);return this.answer(t,this.instanceForElement(i))},"primitiveDomElementMatches:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&this.answer(t,s.matches(e))},primitiveDomElementHost:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=e.getRootNode().host;return this.answer(t,this.instanceForElement(s))},primitiveDomElementParent:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=e.parentElement;return this.answer(t,this.instanceForElement(s))},primitiveDomElementChildren:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=this,i=Array.from(e.children).map((function(t){return s.instanceForElement(t)}));return this.answer(t,i)},primitiveDomElementPreviousSibling:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=e.previousElementSibling;return this.answer(t,this.instanceForElement(s))},primitiveDomElementNextSibling:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=e.nextElementSibling;return this.answer(t,this.instanceForElement(s))},"primitiveDomElementIsDescendantOf:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&this.answer(t,e!==s&&e.contains(s))},primitiveDomElementTagName:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,e.localName||e.tagName||"--shadow--")},primitiveDomElementId:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,e.id)},"primitiveDomElementId:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.id=e,this.answerSelf(t))},primitiveDomElementTextContent:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,e.textContent)},"primitiveDomElementTextContent:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.textContent=e,this.answerSelf(t))},primitiveDomElementLocalTextContent:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=Array.prototype.filter.call(e.childNodes,(function(t){return t.nodeType===Node.TEXT_NODE})).map((function(t){return t.textContent})).join("");return this.answer(t,s)},primitiveDomElementMarkupContent:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,e.innerHTML)},"primitiveDomElementMarkupContent:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.innerHTML=e,this.initializePendingElements(),this.answerSelf(t))},"primitiveDomElementIsClassed:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&this.answer(t,s.classList.contains(e))},"primitiveDomElementAddClass:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.classList.add(e),this.answerSelf(t))},"primitiveDomElementRemoveClass:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.classList.remove(e),this.answerSelf(t))},"primitiveDomElementAttributeAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;if(!s)return!1;var i,r=this.namespaceURIFromName(e);return i=r?s.getAttributeNS(r,e):s.getAttribute(e),this.answer(t,i)},"primitiveDomElementAttributeAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(0),i=s.isNil?null:s.asString(),r=this.interpreterProxy.stackValue(2).domElement;if(!r)return!1;var n=this.namespaceURIFromName(e);return null===i?n?r.removeAttributeNS(n,e):r.removeAttribute(e):n?r.setAttributeNS(n,e,i):r.setAttribute(e,i),this.answerSelf(t)},"primitiveDomElementRemoveAttributeAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;if(!s)return!1;var i=this.namespaceURIFromName(e);return i?s.removeAttributeNS(i,e):s.removeAttribute(e),this.answerSelf(t)},"primitiveDomElementStyleAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&this.answer(t,s.style.getPropertyValue(e)||window.getComputedStyle(s).getPropertyValue(e))},"primitiveDomElementStyleAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(0),i=s.isNil?null:s.asString(),r=this.interpreterProxy.stackValue(2).domElement;return!!r&&(null===i?r.style.removeProperty(e):r.style.setProperty(e,i),this.answerSelf(t))},"primitiveDomElementRemoveStyleAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&(s.style.removeProperty(e),this.answerSelf(t))},"primitiveDomElementPropertyAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).domElement;return!!s&&this.answer(t,s[e])},"primitiveDomElementPropertyAt:put:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString();if(!e)return!1;var s=this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(0)),i=this.interpreterProxy.stackValue(2).domElement;return!!i&&(i[e]=s,this.answerSelf(t))},primitiveDomElementBoundingClientRectangle:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,this.makeDomRectangle(e.getBoundingClientRect()))},primitiveDomElementClone:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=e.cloneNode(!1);s.removeAttribute("id");for(var i=e.firstChild;i&&3!==i.nodeType;)i=i.nextSibling;return i&&(s.textContent=i.textContent),this.answer(t,this.instanceForElement(s))},"primitiveDomElementAppendChild:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.domElement;if(!s)return!1;var i=this.interpreterProxy.stackValue(1).domElement;return!!i&&(0===i.children.length&&i.childNodes.length>0&&(i.textContent=""),i.appendChild(s),this.answer(t,e))},"primitiveDomElementInsertChild:before:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=e.domElement;if(!s)return!1;var i=this.interpreterProxy.stackValue(0).domElement;if(!i)return!1;var r=this.interpreterProxy.stackValue(2).domElement;return!(!r||i.parentElement!==r)&&(r.insertBefore(s,i),this.answer(t,e))},"primitiveDomElementReplaceWith:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.domElement;if(!s)return!1;var i=this.interpreterProxy.stackValue(1).domElement;return!!i&&(i.replaceWith(s),this.answer(t,e))},"primitiveDomElementReplaceChild:with:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).domElement;if(!e)return!1;var s=this.interpreterProxy.stackValue(0),i=s.domElement;if(!i)return!1;var r=this.interpreterProxy.stackValue(2).domElement;return!(!r||e.parentElement!==r)&&(r.replaceChild(i,e),this.answer(t,s))},"primitiveDomElementRemoveChild:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.domElement;if(!s)return!1;var i=this.interpreterProxy.stackValue(1).domElement;return!!i&&s.parentElement===i&&(i.removeChild(s),this.answer(t,e))},primitiveDomElementUnregisterAllInterest:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&(e.__cp_event_listeners&&(e.__cp_event_listeners.forEach((function(t,s){t.forEach((function(t){e.removeEventListener(s.type,t)}))})),delete e.__cp_event_listeners),this.answerSelf(t))},"primitiveDomElementApply:withArguments:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2).domElement;if(!e)return!1;var s=this.interpreterProxy.stackValue(1).asString();if(!s)return!1;var i=this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(0))||[];return this.domElementApply(t,e,s,i)},"primitiveDomElementApply:withArguments:resultAs:":function(t){if(3!==t)return!1;var e=this.interpreterProxy.stackValue(3).domElement;if(!e)return!1;var s=this.interpreterProxy.stackValue(2).asString();if(!s)return!1;var i=this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(1))||[],r=this.interpreterProxy.stackValue(0);return this.domElementApply(t,e,s,i,r)},domElementApply:function(t,e,s,i,r){var n=e[s];if(!n||!n.apply)return!1;var a=void 0;try{a=n.apply(e,i)}catch(t){console.error("Failed to perform apply:withArguments:"+(r?"resultAs:":"")+" on object:",t,"Selector:",s,"Arguments:",i)}return this.answer(t,this.primHandler.makeStObject(a,r))},primitiveHtmlElementDocumentHead:function(t){if(0!==t)return!1;var e=window.document.head;return this.answer(t,this.instanceForElement(e))},primitiveHtmlElementDocumentBody:function(t){if(0!==t)return!1;var e=window.document.body;return this.answer(t,this.instanceForElement(e))},"primitiveWebComponentRegisterWithInitialize:thirdParty:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(2);if(void 0!==e.customTag)return console.error("Registering a WebComponent which already has a custom tag: "+e.customTag),!1;var s=!0===this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(1)),i=!0===this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(0)),r=this.tagNameFromClass(e);e.customTag=r,this.customTagMap[r]=e;var n=this;if(!i)try{var a=class extends HTMLElement{constructor(t){super(),n.ensureShadowRoot(e,this),window.customElements.upgrade(this.shadowRoot),!0!==t&&s&&(n.elementsToInitialize.push(this),n.initializeRunner||(n.initializeRunner=window.setTimeout((function(){n.initializePendingElements()}),0)))}connectedCallback(){var t=this;window.setTimeout((function(){t.dispatchEvent(new Event("connected"))}),0)}disconnectedCallback(){var t=this;window.setTimeout((function(){t.dispatchEvent(new Event("disconnected"))}),0)}};window.customElements.define(r,a),a.stClass=e}catch(t){return console.error("Failed to create new custom element with tag "+e.customTag,t),!1}return this.answerSelf(t)},"primitiveWebComponentIsRegistered:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=window.customElements.get(e);return this.answer(t,!!s)},primitiveWebComponentTagName:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=this.tagNameFromClass(e);return this.answer(t,s)},primitiveWebComponentShadowRoot:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;return!!e&&this.answer(t,this.instanceForElement(e.shadowRoot))},primitiveWebComponentTextContent:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;for(var s="",i=e.firstChild;i;)(1===i.nodeType&&!i.slot||3===i.nodeType)&&(s+=i.textContent),i=i.nextSibling;return this.answer(t,s)},"primitiveWebComponentTextContent:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1).domElement;if(!s)return!1;for(var i=s.firstChild;i;){var r=i.nextSibling;1===i.nodeType&&i.slot||i.parentNode.removeChild(i),i=r}return s.appendChild(window.document.createTextNode(e)),this.answerSelf(t)},ensureShadowRoot:function(t,e){if(!e.shadowRoot){var s=e.attachShadow({mode:"open"});t.templateElement&&(s.appendChild(t.templateElement.cloneNode(!0)),this.initializePendingElements())}},"primitiveTemplateComponentInstallStyle:andTemplate:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).asString(),s=this.interpreterProxy.stackValue(0).asString(),i=this.interpreterProxy.stackValue(2);return i.style=e,this.installTemplate(i,s),this.renderAllInstances(i),this.answerSelf(t)},"primitiveTemplateComponentInstallStyle:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1);return s.style=e,this.installStyleInTemplate(s),this.styleAllInstances(s),this.answerSelf(t)},installStyleInTemplate:function(t){var e=t.templateElement;if(e){var s=window.document.createElement("style");s.id="cp-css--"+t.customTag,s.textContent=t.style;var i=e.querySelector("#"+s.id);i?i.parentNode.replaceChild(s,i):e.insertBefore(s,e.firstElementChild)}},"primitiveTemplateComponentInstallTemplate:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1);return this.installTemplate(s,e),this.renderAllInstances(s),this.answerSelf(t)},installTemplate:function(t,e){var s=(new DOMParser).parseFromString("<template>"+(e||"")+"</template>","text/html").querySelector("template").content;Object.keys(this.customTagMap).some((function(t){return null!==s.querySelector(t)}))?this.nestedTags[t.customTag]=!0:delete this.nestedTags[t.customTag],t.templateElement=s,this.installStyleInTemplate(t)},primitiveTemplateComponentRenderAllInstances:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0);return!!e.templateElement&&(this.renderAllInstances(e),this.answerSelf(t))},allInstancesDo:function(t,e,s){var i=this;e.querySelectorAll(t.customTag).forEach(s),Object.keys(this.nestedTags).forEach((function(r){e.querySelectorAll(r).forEach((function(e){e.shadowRoot&&i.allInstancesDo(t,e.shadowRoot,s)}))}))},renderAllInstances:function(t){var e=t.templateElement,s=this;this.allInstancesDo(t,window.document,(function(i){s.renderTemplateOnElement(t,e,i)}))},renderTemplateOnElement:function(t,e,s){var i=s.shadowRoot,r="cp-css--"+t.customTag;for(s=i.firstElementChild;s;)if("style"!==s.localName||s.id===r){var n=s;s=s.nextElementSibling,n.remove()}else s=s.nextElementSibling;i.appendChild(e.cloneNode(!0)),this.initializePendingElements()},styleAllInstances:function(t){var e=t.templateElement,s="#cp-css--"+t.customTag,i=e.querySelector(s);if(i){var r=i.textContent,n=this;this.allInstancesDo(t,window.document,(function(t){n.updateStyleOnElement(r,s,t)}))}else console.warn("Styling all instance of <"+t.customTag+">, but no style present")},updateStyleOnElement:function(t,e,s){var i=s.shadowRoot.querySelector(e);if(i)i.textContent=t;else{var r=window.document.createElement("style");r.id=e.slice(1),r.textContent=t,s.insertBefore(r,s.firstElementChild)}},primitiveTemplateComponentEnsureShadowRoot:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0),s=e.domElement;return!!s&&(this.ensureShadowRoot(e.sqClass,s),this.answerSelf(t))},runUpdateProcess:function(){let t=this;window.requestAnimationFrame((function(){t.handleEvents(),t.handleTransitions(),t.runUpdateProcess()}))},handleEvents:function(){if(this.eventsReceived.length>0&&this.eventHandlerProcess&&!this.eventHandlerProcess.isRunning)try{this.eventHandlerProcess.isRunning=!0,this.eventHandlerProcess.run()}finally{this.eventHandlerProcess.isRunning=!1}},"primitiveEventRegisterProcess:":function(t){return 1===t&&(this.eventHandlerProcess=this.interpreterProxy.stackValue(0),this.systemPlugin.makeProcessSynchronous(this.eventHandlerProcess),this.eventHandlerProcess.failOnAwait=!0,this.answerSelf(t))},"primitiveEventRegisterClass:forType:":function(t){if(2!==t)return!1;let e=this.interpreterProxy.stackValue(0).asString(),s=this.interpreterProxy.stackValue(1);return s.type=e,this.eventClassMap[e]=s,this.answerSelf(t)},"primitiveEventAddListenerTo:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0),i=s.domElement;if(!i)return!1;i.__cp_element=s;var r=this,n=function(t){var e=t.type,s=t.currentTarget;if(t.__cp_current_target!==s){t.__cp_current_target=s;var i=r.throttleEventTypes.includes(e),n=r.eventsReceived;if(i){var a=n.findIndex((function(t){return t.type===e&&t.__cp_current_target===s}));a>=0?n[a]=t:n.push(t)}else n.push(t);i||r.handleEvents()}};if(i.__cp_event_listeners){var a=i.__cp_event_listeners.get(e);a?a.push(n):i.__cp_event_listeners.set(e,[n])}else i.__cp_event_listeners=new Map,i.__cp_event_listeners.set(e,[n]);return i.addEventListener(e.type,n),this.answerSelf(t)},"primitiveEventRemoveListenerFrom:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0).domElement;if(!s)return!1;if(s.__cp_event_listeners){var i=s.__cp_event_listeners.get(e);if(i){var r=i.pop();s.removeEventListener(e.type,r)}}return this.answerSelf(t)},"primitiveEventIsListenedToOn:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(1),s=this.interpreterProxy.stackValue(0).domElement;return!!s&&this.answer(t,!(!s.__cp_event_listeners||!s.__cp_event_listeners.has(e)))},primitiveEventLatestEvents:function(t){if(0!==t)return!1;var e=this,s=this.primHandler.makeStArray(this.eventsReceived.map((function(t){if(t.__cp_event)return t.__cp_event;let s=e.eventClassMap[t.type],i=e.vm.instantiateClass(s,0);return i.event=t,t.__cp_event=i,i})));return this.eventsReceived=[],this.answer(t,s)},"primitiveEventPropertyAt:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).asString();if(!e)return!1;var s=this.interpreterProxy.stackValue(1).event;if(!s)return!1;var i=s[e];return i||"currentTarget"!==e||(i=s.__cp_current_target),this.answer(t,i)},primitiveEventModifiers:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;if(!e)return!1;var s=(e.altKey?1:0)+(e.ctrlKey?2:0)+(e.metaKey?4:0)+(e.shiftKey?8:0);return this.answer(t,s)},primitiveEventPreventDefault:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;return!!e&&(e.preventDefault(),this.answerSelf(t))},primitiveEventStopPropagation:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;return!!e&&(e.stopPropagation(),e.__cp_stop_propagation||(e.__cp_stop_propagation=!0,e.__cp_stop_after=e.__cp_current_target),this.answerSelf(t))},primitiveEventStopImmediatePropagation:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;return!!e&&(e.stopImmediatePropagation(),e.__cp_stop_propagation||(e.__cp_stop_propagation=!0,e.__cp_stop_after=null),this.answerSelf(t))},primitiveEventIsStopped:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;if(!e)return!1;var s=!1;return e.__cp_stop_propagation&&(null===e.__cp_stop_after?s=!0:e.__cp_stop_after!==e.__cp_current_target&&(e.__cp_stop_after=null,delete e.__cp_current_target,s=!0)),this.answer(t,s)},primitiveEventCopy:function(t){if(0!==t)return!1;var e=this.interpreterProxy.stackValue(0).event;let s={};for(let t in e){let i=e[t];i&&i.apply||(s[t]=i)}s.__cp_stop_propagation=!0,s.__cp_stop_after=null,s.preventDefault=function(){},s.stopPropagation=function(){},s.stopImmediatePropagation=function(){};let i=this.eventClassMap[e.type],r=this.vm.instantiateClass(i,0);return r.event=s,this.answer(t,r)},"primitiveCustomEventCreateWithDetail:":function(t){if(1!==t)return!1;var e=this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(0)),s=this.interpreterProxy.stackValue(1);if(s.event)return!1;var i=s.sqClass.type;return s.event=new CustomEvent(i,{detail:e,bubbles:!0,cancelable:!0,composed:!0}),s.event.__cp_event=s,this.answerSelf(t)},"primitiveCustomEventDispatchFrom:":function(t){if(1!==t)return!1;var e=this.interpreterProxy.stackValue(0).domElement;if(!e)return!1;var s=this.interpreterProxy.stackValue(1).event;return!!s&&(window.setTimeout((function(){e.dispatchEvent(s)}),0),this.answerSelf(t))},"primitiveTransitionRegisterProcess:":function(t){return 1===t&&(this.transitionProcess=this.interpreterProxy.stackValue(0),this.systemPlugin.makeProcessSynchronous(this.transitionProcess),this.transitionProcess.failOnAwait=!0,this.answerSelf(t))},"primitiveTransitionHasTransitions:":function(t){return 1===t&&(this.hasTransitions=!0===this.systemPlugin.asJavaScriptObject(this.interpreterProxy.stackValue(0)),this.answerSelf(t))},primitiveTransitionTickCount:function(t){return 0===t&&this.answer(t,Math.ceil(performance.now()-this.transitionStartTick))},handleTransitions:function(t){this.transitionProcess&&this.hasTransitions&&this.transitionProcess.run()}}):globalThis.setTimeout(t,100)}(),Object.extend(Squeak,"running",{runImage:function(t,e){console.log("Running SqueakJS VM (build "+Squeak.vmBuild+")");var s=new Squeak.Image(e);s.fixFloat(),s.readFromBuffer(t,(function(){var t=new Squeak.Interpreter(s,{vmOptions:["-vm-display-null","-nodisplay"]});t.interpreterRestartTimeout=null,t.runInterpreter=function(e){e&&t.interpreterRestartTimeout?"defer"!==t.interpreterRestartTimeout&&(globalThis.clearTimeout(t.interpreterRestartTimeout),t.interpreterRestartTimeout="defer"):t.interpreterRestartTimeout=null;try{var s,i=t.activeProcess();if(i.isSync||(i=void 0),t.isIdle=!1,i){do{(s=t.method.compiled)?s(t):t.interpretOneSistaWithExtensions(!1,0,0)}while(i===t.activeProcess());if(t.activeProcess().isSync)return}else{var r=performance.now()+50;do{(s=t.method.compiled)?s(t):t.interpretOneSistaWithExtensions(!1,0,0)}while(performance.now()<r&&!t.isIdle)}"defer"!==t.interpreterRestartTimeout&&t.inIdleProcess()?t.interpreterRestartTimeout=null:t.interpreterRestartTimeout=globalThis.setTimeout(t.runInterpreter,0)}catch(t){console.error("Failure during Squeak run: ",t)}},t.deferRunInterpreter=function(){"defer"!==t.interpreterRestartTimeout?(t.interpreterRestartTimeout&&(globalThis.clearTimeout(t.interpreterRestartTimeout),t.interpreterRestartTimeout=null),globalThis.setTimeout((function(){t.runInterpreter(!0)}),0)):globalThis.setTimeout((function(){t.runInterpreter(!0)}),0)},t.runInterpreter()}))}}),window.addEventListener("unhandledrejection",(function(t){globalThis.__cp_uncaught={reason:t.reason,promise:t.promise,compiledCode:t.promise.__cp_compiled_code},Squeak.externalModules.CpSystemPlugin.vm.handleUncaught(),t.preventDefault()})),Object.extend(Squeak,{vmPath:"/",platformSubtype:"Browser",osVersion:window.navigator.userAgent,windowSystem:"CodeParadise",fetchImageAndRun:function(t){globalThis.fetch(t,{method:"GET",mode:"cors",cache:"localhost"===document.location.hostname?"no-store":"no-cache"}).then((function(t){if(!t.ok)throw new Error("Response not OK: "+t.status);return t.arrayBuffer()})).then((function(e){Squeak.runImage(e,t.replace(/\.image$/i,""))})).catch((function(t){console.error("Failed to retrieve image",t)}))}})}();